<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Progresso - Edital</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- Versão 117 --- */
    /* --- ESTILO PARA O NOVO TÍTULO --- */
    header {
      text-align: center;
      padding: 20px 0;
      color: #F7EF8A;
    }

    header h1 {
      font-size: 1.8rem;
      margin: 0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      background: linear-gradient(to right, #D2AC47, #F7EF8A, #AE8625);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* --- ESTILO DO MENU DE USUÁRIO (HEADER) --- */
    header {
      position: relative;
      /* Necessário para posicionar o ícone no canto */
    }

    .header-user-icon {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      font-size: 1.5rem;
      color: #D2AC47;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 100;
      padding: 10px;
      /* Aumenta a área de clique */
    }

    .header-user-icon:hover {
      color: #F7EF8A;
      text-shadow: 0 0 8px rgba(210, 172, 71, 0.5);
    }

    .user-dropdown-menu {
      display: none;
      /* Escondido por padrão */
      position: absolute;
      top: 60px;
      /* Logo abaixo do header */
      right: 10px;
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      padding: 15px;
      z-index: 2000;
      min-width: 200px;
      text-align: center;
      animation: slideInDown 0.2s ease;
    }

    .user-dropdown-menu.active {
      display: block;
    }

    .user-dropdown-email {
      color: #F7EF8A;
      font-size: 0.9rem;
      margin-bottom: 12px;
      font-weight: bold;
      word-break: break-all;
      display: block;
    }

    .btn-logout-dropdown {
      background: linear-gradient(135deg, #7A0000, #A10000);
      color: white;
      border: 1px solid #ff4d4d;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      transition: all 0.3s;
    }

    .btn-logout-dropdown:hover {
      background: #ff4d4d;
      transform: translateY(-1px);
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ----------------------------------------- */
    /* --- FIM DO ESTILO --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #0D0D09 0%, #000000 100%);
      color: #F4E883;
      min-height: 100vh;
      padding: 0px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow-y: hidden;
      overflow-x: hidden;
      /* CORREÇÃO: Remove a barra de rolagem horizontal (Estilo V113) */
    }

    .container {
      width: 100%;
      max-width: 1200px;
      background: rgba(20, 20, 20, 0.95);
      border-radius: 10px;
      padding: 0px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      border: 1px solid #333;
    }

    header {
      text-align: center;
      padding: 08px 0;
      color: #F7EF8A;
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 1.6rem;
      margin-bottom: 5px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      background: linear-gradient(to right, #D2AC47, #F7EF8A, #AE8625);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    header p {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .app-container {
      margin-top: 10px;
    }

    .progress-app {
      background: linear-gradient(to bottom, #1a1a1a, #111);
      border-radius: 8px;
      padding: 4px 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      min-height: 420px;
      border: 1px solid #333;
    }

    .app-header {
      display: flex;
      justify-content: flex-end;
      /* ALTERADO DE 'space-between' */
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 0px;
      border-bottom: 1px solid #333;
      flex-wrap: wrap;
      gap: 8px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(210, 172, 71, 0.25);
      padding: 5px 12px;
      border-radius: 50px;
      font-weight: 500;
      color: #F7EF8A;
      font-size: 0.85rem;
    }

    /* --- BARRA SUPERIOR COMPACTA E ALINHADA --- */
    .top-bar {
      display: flex;
      flex-wrap: nowrap;
      gap: 4px;
      margin-bottom: 12px;
      align-items: center;
      justify-content: flex-start;
      overflow-x: hidden;
      padding-bottom: 4px;
    }

    .top-bar>* {
      flex: 0 0 auto;
    }

    .top-bar button {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
      border: none;
      padding: 6px 8px;
      border-radius: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      font-size: 0.82rem;
      transition: all 0.3s ease;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
      min-height: 34px;
      max-width: 130px;
      margin: 0;
    }

    .top-bar button:hover {
      background: linear-gradient(135deg, #F4E883, #D2AC47, #AE8625);
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    }

    .top-bar button.loading {
      pointer-events: none;
      opacity: 0.7;
    }

    /* Botão "Dados" compacto */
    .top-bar button:nth-child(5) {
      width: 76px !important;
      max-width: 76px !important;
      padding: 6px 5px !important;
      font-size: 0.8rem !important;
    }

    /* Container de busca fixo - AJUSTADO PARA NOVO FILTRO */
    .search-container {
      display: flex;
      align-items: center;
      gap: 6px;
      width: auto;
      flex: 1;
      min-width: 200px;
      max-width: 600px;
    }

    .top-bar input[type="text"],
    .top-bar select {
      padding: 6px 10px;
      border: 1px solid #555;
      border-radius: 50px;
      background: #222;
      color: #fff;
      font-size: 0.82rem;
    }

    .search-icon {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
      border: none;
      padding: 7px 12px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .search-icon:hover {
      background: linear-gradient(135deg, #F4E883, #D2AC47, #AE8625);
      transform: translateY(-1px);
    }

    .search-expanded {
      flex: 1;
      min-width: 120px;
    }

    .top-bar input[type="text"] {
      padding: 7px 12px;
      border: 1px solid #555;
      border-radius: 50px;
      font-size: 0.85rem;
      transition: border-color 0.3s;
      background-color: #222;
      color: #fff;
      width: 100%;
    }

    .top-bar input[type="text"]:focus {
      border-color: #D2AC47;
      outline: none;
    }

    /* 5. Ajuste do placeholder do campo de busca */
    #searchInput::placeholder {
      font-size: 0.8rem;
    }

    .top-bar select {
      padding: 7px 12px;
      border: 1px solid #555;
      border-radius: 50px;
      background: #222;
      font-size: 1rem;
      transition: border-color 0.3s;
      color: #fff;
      min-width: 170px;
      width: 170px;
    }

    .top-bar select:focus {
      border-color: #D2AC47;
      outline: none;
    }

    .progress-counter {
      background: rgba(210, 172, 71, 0.25);
      color: #F7EF8A;
      padding: 5px 10px;
      border-radius: 50px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
    }

    #main-container {
        display: flex;
        flex-direction: column;
        /* Define a altura do container pai para ir até o fim da tela */
        height: calc(100vh - 70px) !important; 
        min-height: unset !important; /* Remove travas antigas */
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
        gap: 0 !important; /* Remove espaços extras entre elementos */
      }

    .content-area {
      display: flex;
      gap: 12px;
      height: 100%;
    }

   #topics-list-container {
        min-width: unset;
        max-width: unset;
        
        /* OGRANDE TRUQUE: flex: 1 faz ele ocupar TODO o espaço que sobrar */
        flex: 1 !important; 
        height: auto !important; /* Deixa o flex controlar a altura */
        
        /* Remove bordas inferiores para encostar no fundo */
        margin-bottom: 0 !important;
        border-bottom: none !important;
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
      }

    .list-header {
      background: linear-gradient(to right, #222, #111);
      color: #F7EF8A;
      padding: 10px 12px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      font-size: 1.3rem;
    }

    #topics-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      /* CORREÇÃO: Bloqueia rolagem horizontal na lista */
      list-style: none;
      background: #000000;
    }

    /* 4. Ícone de edição sempre visível */
    .topic-item {
      padding: 10px 12px;
     border-bottom: 1px solid rgba(210, 172, 71, 0.3) !important;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #eee;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
	  margin-bottom: 2px;
    }

    .topic-item:hover {
      background: linear-gradient(to right, #2a2a2a, #222);
      transform: translateX(3px);
      box-shadow: inset 3px 0 6px rgba(244, 232, 131, 0.15);
    }

    .topic-item.active {
      background: rgba(210, 172, 71, 0.15);
      border-left: 3px solid #D2AC47;
      box-shadow: inset 3px 0 8px rgba(210, 172, 71, 0.25);
    }

    .topic-content {
      flex: 1;
    }

    .topic-title {
      font-weight: bold;
      margin-bottom: 4px;
      color: #F7EF8A;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
    }

    /* 1. Ícones de status duplos para tópicos */
    .status-icons {
      display: flex;
      gap: 4px;
      margin-right: 8px;
    }

    .status-icon {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .status-estudado {
      background: #4CAF50;
      color: white;
    }

    .status-revisado {
      background: #FFC107;
      color: black;
    }

    .status-questoes {
      background: #2196F3;
      /* Azul */
      color: white;
    }

    /* === CONTROLES RÁPIDOS NA LISTA === */
    .quick-controls {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-right: 12px;
    }

    .quick-checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid #555;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
      background: #222;
    }

    .quick-checkbox:hover {
      border-color: #D2AC47;
      transform: scale(1.1);
    }

    .quick-checkbox.checked-estudo {
      background: #4CAF50;
      border-color: #4CAF50;
      color: white;
    }

    .quick-checkbox.checked-questoes {
      background: #2196F3;
      border-color: #2196F3;
      color: white;
    }

    .quick-checkbox.checked-flashcards {
      background: #9C27B0;
      border-color: #9C27B0;
      color: white;
    }

    /* --- CSS NOVO: Botão de Dificuldade na Lista --- */
    .quick-difficulty-btn {
      width: 22px;
      height: 22px;
      border: 2px solid #555;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
      background: #222;
      color: #555;
      /* Cor padrão (sem seleção) */
    }

    .quick-difficulty-btn:hover {
      border-color: #D2AC47;
      transform: scale(1.1);
    }

    .quick-difficulty-btn.diff-facil {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.2);
      /* Fundo suave */
      color: #4CAF50;
    }

    .quick-difficulty-btn.diff-medio {
      border-color: #FFC107;
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }

    .quick-difficulty-btn.diff-dificil {
      border-color: #F44336;
      background: rgba(244, 67, 54, 0.2);
      color: #F44336;
    }

    .quick-revisao-counter {
      min-width: 28px;
      height: 22px;
      padding: 0 6px;
      background: #333;
      border: 2px solid #555;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 11px;
      font-weight: bold;
      color: #999;
      transition: all 0.2s ease;
    }

    .quick-revisao-counter:hover {
      border-color: #FFC107;
      background: #3a3a3a;
    }

    .quick-revisao-counter.has-revisoes {
      background: #FFC107;
      border-color: #FFC107;
      color: #000;
    }

    /* Tooltip para os controles */
    .quick-controls [title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #F7EF8A;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      white-space: nowrap;
      z-index: 100;
    }

    /* Mini popup para editar revisões */
    .revisao-popup {
      position: absolute;
      /* Mudado de fixed para absolute */
      /* Removemos top/left/transform fixos para definir via JS */
      background: #111;
      border: 2px solid #D2AC47;
      border-radius: 8px;
      padding: 15px;
      z-index: 2000;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8);
      min-width: 50px;
      max-width: 180px;
    }

    .revisao-popup h4 {
      color: #F7EF8A;
      margin-bottom: 15px;
      font-size: 1rem;
    }

    .revisao-popup input {
      width: 100%;
      padding: 8px;
      background: #222;
      border: 2px solid #555;
      border-radius: 4px;
      color: #FFC107;
      font-size: 1.1rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
    }

    .revisao-popup-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .popup-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1999;
    }

    .edit-icon {
      color: #D2AC47;
      opacity: 0.7;
      font-size: 0.9rem;
      margin-left: 8px;
      transition: all 0.3s ease;
    }

    .edit-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .topic-discipline {
      background: rgba(210, 172, 71, 0.25);
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 1.2rem;
      color: white;
      font-weight: 500;
    }

    .topic-subtopic {
      font-size: 1.2rem;
      color: #ffffff;
      margin-top: 4px;
      font-style: italic;
    }

    #topic-detail-container {
      flex: 2;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      background: #000000;
      position: relative;
    }

    #topic-detail-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 8px;
      color: #F7EF8A;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
    }

    #topic-detail-discipline {
      font-size: 0.85rem;
      color: white;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
    }

    .topic-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 5px;
      padding: 10px;
      border: 1px solid #333;
    }

    .info-field {
      display: flex;
      margin-bottom: 8px;
      align-items: center;
    }

    .info-field:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-weight: bold;
      min-width: 80px;
      color: #F7EF8A;
      font-size: 0.85rem;
    }

    .info-value {
      flex: 1;
      color: #fff;
      font-size: 0.85rem;
    }

    .info-value.editable {
      background: rgba(210, 172, 71, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px dashed #D2AC47;
    }

    .edit-input {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #D2AC47;
      border-radius: 4px;
      background: #222;
      color: #fff;
      font-size: 0.85rem;
    }

    .edit-input:focus {
      outline: none;
      border-color: #F7EF8A;
    }

    .progress-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.05);
    }

    .progress-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .progress-label i {
      color: #D2AC47;
    }

    .progress-status {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* --- ESTILOS DOS CHECKBOXES PERSONALIZADOS --- */
    .custom-checkbox {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .custom-checkbox input[type="checkbox"] {
      opacity: 0;
      position: absolute;
      width: 0;
      height: 0;
    }

    .checkmark {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border: 2px solid #555;
      background-color: #222;
      color: transparent;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .custom-checkbox input[type="checkbox"]:checked+.checkmark {
      color: white;
      border-color: #4CAF50;
    }

    /* Cores específicas para cada tipo de checkbox */
    .custom-checkbox.estudo input[type="checkbox"]:checked+.checkmark {
      background-color: #4CAF50;
      /* Verde */
      border-color: #4CAF50;
    }

    .custom-checkbox.revisao input[type="checkbox"]:checked+.checkmark {
      background-color: #FFC107;
      /* Amarelo */
      border-color: #FFC107;
      color: black;
    }

    .custom-checkbox.questoes input[type="checkbox"]:checked+.checkmark {
      background-color: #2196F3;
      /* Azul */
      border-color: #2196F3;
    }

    .custom-checkbox.flashcards input[type="checkbox"]:checked+.checkmark {
      background-color: #9C27B0;
      /* Roxo */
      border-color: #9C27B0;
    }

    .custom-checkbox input[type="checkbox"]:hover+.checkmark {
      border-color: #D2AC47;
    }

    .date-input {
      padding: 5px 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #222;
      color: #fff;
      font-size: 0.85rem;
    }

    .resize-handle {
      position: absolute;
      right: 5px;
      top: 5px;
      background: #D2AC47;
      color: #0D0D09;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.3s;
      font-size: 0.75rem;
    }

    .resize-handle:hover {
      transform: scale(1.1);
      background: #F7EF8A;
    }

    .topic-actions {
      display: flex;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid #333;
      margin-top: auto;
      z-index: 10;
    }

    .topic-actions button {
      padding: 7px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .topic-actions button.loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .topic-actions button:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    .btn-save {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }

    .btn-reset {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }

    .btn-edit {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }

    .btn-cancel {
      background: linear-gradient(135deg, #666, #999, #444);
      color: #fff;
    }

    .edit-mode-banner {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A);
      color: #0D0D09;
      padding: 8px 12px;
      border-radius: 5px;
      margin-bottom: 12px;
      text-align: center;
      font-weight: bold;
      display: none;
    }

    /* LOGIN STYLES - CORES IGUAIS AO PROJETO ANOTAÇÕES */
    #login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      /* ALTERADO: Alinha ao topo */
      padding: 25px;
      padding-top: 60px;
      /* NOVO: Espaço do topo para não colar no teto */
      text-align: center;
      height: 100%;
    }

    #login-form {
      background: #111;
      padding: 20px;
      border-radius: 8px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #333;
    }

    #login-form h2 {
      color: #D2AC47;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }

    #login-form p {
      margin-bottom: 12px;
      font-size: 0.85rem;
    }

    #login-form input {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border: 1px solid #555;
      border-radius: 5px;
      font-size: 0.85rem;
      transition: border-color 0.3s;
      background: #222;
      color: #fff;
    }

    #login-form input:focus {
      border-color: #D2AC47;
      outline: none;
    }

    #login-form button {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      transition: all 0.3s ease;
      position: relative;
    }

    #login-form button:hover {
      background: linear-gradient(135deg, #F4E883, #D2AC47, #AE8625);
      transform: translateY(-1px);
    }

    .login-spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(210, 172, 71, 0.3);
      border-radius: 50%;
      border-top-color: #D2AC47;
      animation: spin 1s ease-in-out infinite;
      margin: 8px auto;
    }

    #login-error {
      color: #D2AC47;
      margin-top: 10px;
      text-align: center;
      display: none;
      font-size: 0.85rem;
    }

    .logout-button {
      background: none;
      border: none;
      cursor: pointer;
      color: #D2AC47;
      font-size: 0.9rem;
      margin-left: 6px;
      transition: color 0.3s;
    }

    .logout-button:hover {
      color: #F7EF8A;
    }

    #loading-message,
    #error-message {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 1rem;
      flex-direction: column;
      gap: 12px;
      text-align: center;
      background: #000000;
      border-radius: 6px;
      padding: 15px;
      color: #F7EF8A;
    }

    #loading-message i {
      font-size: 2rem;
      color: #D2AC47;
      animation: spin 1.5s linear infinite;
    }

    #error-message {
      color: #D2AC47;
    }

    .notification-container {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      max-width: 280px;
      width: 100%;
    }

    .notification {
      background: #111;
      border-radius: 5px;
      padding: 10px 14px;
      margin-bottom: 8px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
      border-left: 3px solid #D2AC47;
      transition: transform 0.3s;
      color: #F7EF8A;
      font-size: 0.85rem;
    }

    .notification:hover {
      transform: translateY(-2px);
    }

    .notification.error {
      border-left-color: #D2AC47;
    }

    .notification-icon {
      font-size: 1.1rem;
    }

    .success .notification-icon {
      color: #D2AC47;
    }

    .error .notification-icon {
      color: #D2AC47;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: bold;
      margin-bottom: 3px;
      font-size: 0.9rem;
    }

    .notification-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      color: #777;
      transition: color 0.3s;
    }

    .notification-close:hover {
      color: #F7EF8A;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: flex-start; /* ALTERADO: Alinha ao topo em vez do centro */
      padding-top: 50px;       /* ADICIONADO: Espaço para não colar no teto */
      z-index: 999;
      display: none;
      overflow-y: auto;        /* ADICIONADO: Garante rolagem se a tela for pequena */
    }

    .modal-backdrop#confirmModal {
      z-index: 1001;
      /* Garante que a confirmação fique sobre outros modais */
    }

    .modal {
      background: #111;
      border-radius: 6px;
      padding: 15px;
      max-width: 380px;
      width: 90%;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      transform: translateY(-12px);
      animation: modalAppear 0.4s ease forwards;
      border: 1px solid #333;
      color: #F7EF8A;
    }

    .modal h3 {
      margin-bottom: 12px;
      color: #D2AC47;
      font-size: 1.2rem;
    }

    .modal p {
      margin-bottom: 15px;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-buttons button {
      padding: 7px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .modal-buttons button.loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .modal-buttons button:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    .btn-modal-confirm {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }

    .btn-modal-cancel {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }

    /* --- VISÃO GERAL AVANÇADA --- */
    .overview-modal-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 10px;
      text-align: left;
    }

    .overview-text-summary {
      background: #000000;
      padding: 14px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 1.05rem;
      line-height: 1.7;
      border: 1px solid #555;
      white-space: pre-wrap;
    }

    .overview-chart {
      background: #000000;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #555;
    }

    .chart-title {
      color: #F7EF8A;
      margin-bottom: 12px;
      font-weight: bold;
      text-align: center;
      font-size: 1.5rem;
    }

    /* Gráfico 1 */
    .chart-1-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      align-items: flex-end;
      height: 130px;
      padding: 10px 0;
    }

    .bar {
      width: 60px;
      border-radius: 4px 4px 0 0;
      position: relative;
    }

    .bar-label {
      position: absolute;
      bottom: -28px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 0.9rem;
      color: #fff;
    }

    .bar.estudado {
      background: #4CAF50;
    }

    .bar.nao-estudado {
      background: #F44336;
    }

    /* Gráfico 2 */
    .discipline-progress {
      margin-bottom: 14px;
    }

    /* NOVO ESTILO PARA O CAMPO DE REVISÕES */
    .revisao-count-input {
      width: 60px;
      padding: 6px 8px;
      border: 2px solid #FFC107;
      border-radius: 8px;
      background: #222;
      color: #FFC107;
      font-weight: bold;
      text-align: center;
      font-size: 0.9rem;
    }

    .revisao-count-input:focus {
      outline: none;
      border-color: #FFD54F;
      background: #333;
    }

    /* Mantém a caixa amarela de status na lista */
    .status-revisado {
      background: #FFC107;
      color: black;
      font-weight: bold;
      min-width: 20px;
      text-align: center;
    }

    .discipline-name {
      font-size: 1.1rem;
      margin-bottom: 5px;
      color: #F7EF8A;
      display: flex;
      justify-content: space-between;
      cursor: pointer;
    }

    .progress-bar-container {
      height: 22px;
      background: #333;
      border-radius: 11px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(to right, #2E7D32, #4CAF50);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: #000;
      font-size: 0.8rem;
      font-weight: bold;
    }

    /* Gráfico 3 */
    .chart-3-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      align-items: flex-end;
      height: 150px;
      padding: 10px 0;
    }

    .stacked-bar {
      width: 50px;
      display: flex;
      flex-direction: column-reverse;
      border-radius: 4px 4px 0 0;
    }

    .stacked-segment {
      width: 100%;
    }

    .segment-revisado {
      background: #2196F3;
    }

    .segment-nao-revisado {
      background: #9E9E9E;
    }

    /* ESTILOS PARA AS CAIXAS DE VISÃO GERAL - ALINHADAS */
    .overview-box {
      padding: 0px 6px !important;
      font-size: 1.2rem !important;
      line-height: 0.8 !important;
      min-height: 6px !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      border-radius: 5px !important;
      text-align: center;
      flex: 1;
      margin: 1px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      gap: 8px;
    }

    /* --- NOVO MODAL: METAS DO USUÁRIO --- */
    #userGoalsModal .modal {
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .form-field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }

    .form-field {
      flex: 1;
      min-width: 200px;
    }

    .form-field label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #F7EF8A;
    }

    .form-field input[type="number"],
    .form-field input[type="date"],
    .form-field input[type="time"] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #fff;
      color: #0000ff;
      font-size: 0.85rem;
      font-weight: bold;
      text-align: center;
    }

    .form-field input[type="number"]:focus,
    .form-field input[type="date"]:focus {
      border-color: #D2AC47;
      outline: none;
    }

    /* ESTILOS PARA O RAIO X (NOVOS) */
    .resources-list {
      list-style: none;
      margin-top: 5px;
    }

    .resources-list li {
      padding: 2px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .critical-points {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 10px;
      color: #000;
    }

    /* NOVOS ESTILOS PARA AS CORREÇÕES SOLICITADAS */
    .dicas-content {
      line-height: 0.9 !important;
      font-size: 0.95rem !important;
      color: #ffffff !important;
      /* CORREÇÃO 6: Texto das dicas em branco */
    }

    .dicas-content div {
      margin-bottom: 1px !important;
      color: #ffffff !important;
      /* CORREÇÃO 6: Texto das dicas em branco */
    }

    .dicas-content br {
      display: none !important;
    }

    .bigger-font {
      font-size: 1.5em !important;
      font-weight: bold !important;
      line-height: 1.2 !important;
    }

    .raiox-personalizadas .overview-text-summary {
      font-size: 1.2em !important;
      line-height: 1.4 !important;
    }

    .raiox-personalizadas .overview-text-summary div {
      font-size: 1.25em !important;
    }

    .raiox-medias .overview-text-summary div {
      font-size: 1.25em !important;
    }

    /* NOVOS ESTILOS PARA BOTÃO DADOS - CONTAINERS INDIVIDUAIS */
    .dados-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .dados-item {
      background: #000000;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .dados-label {
      font-weight: bold;
      color: #FFD700;
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .dados-value {
      color: #ffffff;
      font-size: 1.4em;
      font-weight: bold;
    }

    /* CORREÇÃO 4: Aumentar tamanho das letras na distribuição de questões */
    .distribuicao-questoes {
      font-size: 1.2em !important;
    }

    .distribuicao-questoes div {
      font-size: 1.1em !important;
    }

    /* ANIMAÇÃO DE PULSAÇÃO PARA FEEDBACK POSITIVO */
    .pulse-animation {
      animation: pulseSuccess 0.6s ease-in-out 2;
    }

    @keyframes pulseSuccess {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: translateY(-12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- ESTILOS DA AGENDA (FASE 2) --- */
    /* ESTILO PARA O CONTAINER COM ROLAGEM NA VISÃO SEMANAL */
    .week-grid-container {
      height: 65vh;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px;
      background: #000;
    }

    /* ESTILO PARA O CONTAINER COM ROLAGEM NA VISÃO MENSAL */
    .monthly-agenda {
      max-height: 70vh;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 10px;
    }

    .monthly-agenda::-webkit-scrollbar {
      width: 8px;
    }

    .monthly-agenda::-webkit-scrollbar-track {
      background: #111;
      border-radius: 4px;
    }

    .monthly-agenda::-webkit-scrollbar-thumb {
      background: #D2AC47;
      border-radius: 4px;
    }

    .monthly-agenda::-webkit-scrollbar-thumb:hover {
      background: #F7EF8A;
    }

    /* Estilo para os dias do calendário mensal */
    .calendar-day {
      min-height: 100px !important;
      max-height: 140px;
      /* Define uma altura máxima antes da rolagem aparecer */
      overflow-y: auto;
      /* Adiciona a barra de rolagem vertical quando necessário */
      padding: 8px !important;
      padding-right: 12px;
      /* Adiciona espaço para a barra de rolagem não cobrir o texto */
    }

    /* Estilo customizado para a nova barra de rolagem dos dias */
    .calendar-day::-webkit-scrollbar {
      width: 5px;
    }

    .calendar-day::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    .calendar-day::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 3px;
    }

    .calendar-day::-webkit-scrollbar-thumb:hover {
      background: #D2AC47;
    }

    .empty-day {
      min-height: 100px !important;
    }

    .week-grid {
      display: grid;
      grid-template-columns: 100px repeat(7, 1fr);
      gap: 8px;
      min-height: min-content;
    }

    /* Botão de adicionar bloco */
    .add-block-btn {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: #333;
      border: none;
      color: #D2AC47;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-block-btn:hover {
      background: #D2AC47;
      color: #000;
    }

    /* Botão de deletar bloco */
    .delete-block {
      background: none;
      border: none;
      color: #ff4444;
      cursor: pointer;
      font-size: 0.9rem;
      /* Tamanho do ícone */
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
      padding: 0;
    }

    .delete-block:hover {
      background: #ff4444;
      color: #fff;
    }

    .delete-block:hover {
      background: #ff4444;
      color: #000;
    }

    /* Estados de drag & drop */
    .time-slot.drag-over {
      border-color: #F7EF8A;
      background: rgba(210, 172, 71, 0.1);
    }

    /* Calendário mensal */
    .calendar-day.today {
      border: 2px solid #F7EF8A !important;
      background-color: rgba(210, 172, 71, 0.15) !important;
      box-shadow: 0 0 8px rgba(244, 232, 131, 0.25);
    }

    .calendar-day.has-studies {
      background: linear-gradient(135deg, #333, #222) !important;
    }

    /* Estatísticas mensais */
    .stat-card {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    /* Configurações */
    .config-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #333;
    }

    .config-section h5 {
      color: #D2AC47;
      margin-bottom: 15px;
      font-size: 1rem;
    }

    .agenda-config {
      max-height: 65vh;
      /* Limita a altura máxima da área de configurações */
      overflow-y: auto;
      /* Adiciona a barra de rolagem vertical se o conteúdo ultrapassar a altura */
      padding: 0 15px 15px 10px;
      /* Adiciona um preenchimento para a barra de rolagem não cobrir o conteúdo */
    }

    /* Abas da Agenda */
    .agenda-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }

    .agenda-tab {
      background: #222;
      border: 1px solid #555;
      color: #F7EF8A;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
    }

    .agenda-tab.active {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
      font-weight: bold;
    }

    .agenda-tab:hover {
      background: #333;
    }

    .agenda-tab.active:hover {
      background: linear-gradient(135deg, #F4E883, #D2AC47, #AE8625);
    }

    /* Blocos de estudo */
    .study-block {
      background: #333;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
      border-left: 4px solid #D2AC47;
      cursor: move;
      transition: all 0.3s ease;
    }

    .study-block:hover {
      background: #3a3a3a;
      transform: translateY(-1px);
    }

    .study-block.concluido {
      opacity: 0.7;
      border-left-color: #4CAF50;
    }

    /* Slots de tempo */
    .time-slot {
      min-height: 120px;
      background: #222;
      border: 2px dashed #555;
      padding: 8px;
      border-radius: 5px;
      transition: all 0.3s ease;
      position: relative;
      /* <<< ESSA LINHA FOI ADICIONADA */
    }

    .time-slot:hover {
      border-color: #D2AC47;
      background: #2a2a2a;
    }

    .time-slot.drag-over {
      border-color: #F7EF8A;
      background: rgba(210, 172, 71, 0.1);
    }

    /* Cabeçalhos */
    .day-header,
    .period-header {
      background: #333;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      color: #F7EF8A;
      border-radius: 4px;
    }

    .weekly-agenda {
      overflow-x: auto;
    }

    /* Responsividade */
    @media (max-width: 768px) {
	/* --- NOVO: Força o botão X a aparecer no celular --- */
      #btnXFecharMobile {
        display: flex !important;
      }
	  /* --- PASSO 1: Esconde o ícone de usuário do cabeçalho no celular --- */
  .header-user-icon {
    display: none !important;
  }
      /* === HARMONIA DE FONTES MOBILE === */
      /* 1. Reduz o Título Principal (estava muito grande) */
      header h1 {
        font-size: 1.3rem !important;
        /* Reduzido de 1.8rem */
        margin-bottom: 2px;
      }

      header p {
        font-size: 0.75rem !important;
      }

      /* 2. Ajusta Títulos dos Modais */
      .modal h3,
      #agendaModal h3 {
        font-size: 1.1rem !important;
        /* Mais compacto */
      }

      /* 3. Ajusta botões do Menu para não quebrarem linha */
      .top-bar button {
        font-size: 0.85rem !important;
        padding: 8px 10px !important;
      }

      /* 4. Melhora leitura na Agenda Semanal (Grade) */
      .week-grid {
        font-size: 0.75rem !important;
        /* Texto menor para caber os 7 dias */
      }

      .day-header {
        font-size: 0.7rem !important;
        /* Cabeçalho dos dias compacto */
        padding: 4px !important;
      }

      .period-header {
        font-size: 0.9rem !important;
        /* Manhã/Tarde/Noite */
        padding: 4px !important;
      }

      /* 5. Ajusta tamanho do texto dentro dos blocos de estudo */
      .study-block strong {
        font-size: 0.75rem !important;
        /* Disciplina */
      }

      .agenda-block-title {
        font-size: 0.7rem !important;
        /* Tópico */
        line-height: 1.1;
      }

      /* === NOVO MENU HAMBÚRGUER E TOQUE === */

      /* Linha superior sempre visível no mobile: hambúrguer + busca + filtro */
      .mobile-top-row {
        display: flex !important;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
        margin-bottom: 8px;
      }
/* CORREÇÃO: Força a caixa de busca a abrir para a direita no celular */
      #expandableSearchMobile .search-input-modal {
        right: auto !important; /* Desliga o alinhamento à direita (que estava cortando) */
        left: -5px !important;  /* Alinha à esquerda (leve ajuste para centralizar com o ícone) */
        top: 45px !important;   /* Garante que abra logo abaixo do ícone */
        width: 250px !important; /* Largura segura para ver o texto */
      }
      .mobile-menu-btn {
        display: flex !important;
        background: transparent !important;
        border: 2px solid #D2AC47 !important;
        color: #D2AC47 !important;
        font-size: 1.4rem !important;
        padding: 6px 10px !important;
        border-radius: 6px !important;
        cursor: pointer !important;
        align-items: center !important;
        justify-content: center !important;
		width: 34px !important;       /* Largura fixa igual à altura */
        max-width: 34px !important;   /* Trava a largura máxima */
        min-height: 30px !important;
        height: 30px !important;
        flex-shrink: 0;
      }

      /* O menu hambúrguer: escondido por padrão, abre como dropdown */
      #mainTopBar {
        display: none !important;
        flex-direction: column !important;
        
        /* CORREÇÃO AQUI: Alinha tudo no TOPO */
        justify-content: flex-start !important; 
        
        background: #0d0d0d !important; 
        position: fixed !important; 
        top: 0 !important; 
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important; 
        width: 100% !important;
        height: 100vh !important;
        padding: 20px !important;
        z-index: 9999 !important; 
        overflow-y: auto !important;
        gap: 10px !important; /* Espaço pequeno fixo entre o X e os botões */
      }

      /* Estilo do novo botão de fechar menu */
      .mobile-close-menu-btn {
        display: flex !important;
        width: 100% !important;
        background: #7A0000 !important;
        color: white !important;
        border: 1px solid #ff4d4d !important;
        padding: 12px !important;
        border-radius: 8px !important;
        margin-bottom: 20px !important;
        font-weight: bold !important;
        justify-content: center !important;
        align-items: center !important;
        cursor: pointer !important;
        font-size: 1rem !important;
        min-height: 45px !important;
      }
      
      .mobile-close-menu-btn i {
        margin-right: 8px;
      }

      /* --- CORREÇÃO DE FONTES E MODAIS (Imagens 1 e 2) --- */
      
      /* Ajusta Modal para não cortar laterais */
      .modal {
        width: 95% !important;
        padding: 15px 10px !important; /* Menos padding lateral */
        max-height: 90vh !important;
      }

      /* Título do Modal menor para não bater no botão X */
      .modal h3, #overview-title, #dados-title {
        font-size: 1.1rem !important;
        margin-top: 10px !important; /* Espaço para o botão X */
        padding-right: 30px !important; /* Espaço lateral para o X não cobrir texto */
        line-height: 1.4 !important;
      }

      /* Reposiciona o botão X dos Modais */
      .btn-fechar-novo {
        top: 5px !important;
        right: 5px !important;
        width: 32px !important;
        height: 32px !important;
        font-size: 1rem !important;
      }

      /* Reduz tamanho das letras nos dados (Visão Geral) */
      .overview-text-summary div, 
      .bigger-font {
        font-size: 0.95rem !important; /* Reduz fonte */
        line-height: 1.3 !important;
      }
      
      /* Garante que valores numéricos grandes quebrem linha se necessário */
      .overview-text-summary div {
        word-break: break-word !important;
      }

      /* Ajuste do Select de Disciplinas no Mobile */
      #disciplineFilter, #disciplineFilterMobile {
        max-width: 100% !important;
        width: 100% !important;
        font-size: 1rem !important; /* Fonte legível */
        height: 45px !important; /* Área de toque maior */
      }

      #mainTopBar.active {
        display: flex !important;
        max-height: 80vh;
        overflow-y: auto;
      }

      /* Esconde os right-controls no mobile (busca e filtro já estão na mobile-top-row) */
      #mainTopBar .right-controls {
        display: none !important;
      }

      /* Select de disciplina dentro do menu: largura total */
      #mainTopBar #disciplineFilter {
        width: 100% !important;
        max-width: none !important;
        height: 40px !important;
        max-height: none !important;
        min-height: 40px !important;
        font-size: 0.95rem !important;
        padding: 8px 16px !important;
        border-radius: 8px !important;
        border: 1px solid #555 !important;
        background: #222 !important;
        color: #fff !important;
        margin-bottom: 6px;
      }
      /* Botões dentro do menu: largura total, layout vertical ajustado */
      #mainTopBar .left-buttons {
        display: flex !important;
        flex-direction: column !important;
        width: 100% !important;
        gap: 8px !important;        /* Reduzi levemente o espaço entre botões */
        overflow-x: visible !important;
        padding-top: 0 !important;  /* REMOVIDO: Remove o espaço extra no topo */
        margin-top: 0 !important;   /* GARANTIA: Cola logo abaixo do cabeçalho */
      }

      #mainTopBar .left-buttons button {
        width: 100% !important;
        max-width: none !important;
        height: 40px !important;
        max-height: none !important;
        min-height: 40px !important;
        padding: 8px 16px !important;
        font-size: 0.95rem !important;
        justify-content: flex-start !important;
        border-radius: 8px !important;
      }

      /* Estilo do Bloco Selecionado (Toque para Mover) */
      .study-block.mobile-selected {
        border: 2px solid #F7EF8A !important;
        box-shadow: 0 0 15px rgba(247, 239, 138, 0.5);
        transform: scale(1.02);
        z-index: 100;
        animation: pulseSelect 1s infinite;
      }

      @keyframes pulseSelect {
        0% {
          box-shadow: 0 0 5px rgba(247, 239, 138, 0.5);
        }

        50% {
          box-shadow: 0 0 20px rgba(247, 239, 138, 0.8);
        }

        100% {
          box-shadow: 0 0 5px rgba(247, 239, 138, 0.5);
        }
      }

      /* === CORREÇÃO CRÍTICA DO LOGIN MOBILE === */
      /* 1. Libera a rolagem da tela no celular (essencial para teclados virtuais) */
      body {
        overflow-y: auto !important;
        align-items: flex-start !important;
        /* Remove alinhamento forçado ao centro */
      }

      /* 2. Ajusta o container de login para não ficar preso no centro */
      #login-container {
        height: auto !important;
        min-height: 100vh;
        /* Ocupa pelo menos a tela toda */
        justify-content: flex-start !important;
        /* Joga o formulário para cima */
        padding-top: 40px !important;
        /* Espaço do topo */
        padding-bottom: 50px !important;
        /* Espaço extra embaixo para o botão não colar no fim */
      }

      /* 3. Garante que o formulário caiba na tela */
      #login-form {
        margin-bottom: 20px;
      }

      .week-grid {
        grid-template-columns: 80px repeat(7, 1fr) !important;
        font-size: 0.8rem;
      }

      /* Aumentar área de toque para botões no celular */
      .agenda-toolbar button,
      .btn-icon-only,
      .add-block-btn,
      .delete-block {
        min-height: 40px !important;
        /* Altura mínima para o dedo */
        height: auto !important;
        padding: 8px 12px !important;
        font-size: 1rem !important;
      }

      /* Ajustar largura dos botões de ícone para não ficarem deformados */
      .btn-icon-only {
        width: 40px !important;
      }

      /* Aumentar o botão de fechar modal */
      .btn-fechar-novo {
        width: 40px !important;
        height: 40px !important;
        font-size: 1.2rem !important;
      }

      /* Melhorar visualização da grade */
      .week-grid {
        /* Garante que a tabela não quebre em telas pequenas, forçando rolagem lateral */
        min-width: 600px;
      }

      .day-header,
      .period-header {
        padding: 5px !important;
        font-size: 0.7rem;
      }

      .time-slot {
        min-height: 100px !important;
        padding: 5px !important;
      }

      .study-block {
        padding: 5px !important;
      }

      .agenda-header {
        flex-direction: column;
        gap: 10px;
      }

      #main-container {
        display: flex;
        flex-direction: column;
        min-height: 500px;
        /* <-- Alterado de 'height' para 'min-height' */
        gap: 12px;
      }

      header h1 {
        font-size: 1.4rem;
      }

      .app-header {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }

      .progress-app {
        padding: 10px;
      }

      /* AJUSTE DE ALTURA DA LISTA (Ocupar até a base) */
      #topics-list-container {
        min-width: unset;
        max-width: unset;
        /* ALTERADO: De 240px para 160px. Isso "estica" a lista para baixo */
        height: calc(100vh - 160px) !important;
        min-height: 400px !important;
        margin-bottom: 0 !important;
        /* Remove bordas inferiores arredondadas para dar sensação de continuidade */
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        border-bottom: none !important;
      }

      /* NOVO: Remove espaços mortos no fundo dos containers principais */
      .container, .app-container, .progress-app, #main-container {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
        border-bottom: none !important;
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
      }

      .user-info {
        font-size: 0.8rem;
      }

      .progress-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .progress-status {
        width: 100%;
        justify-content: space-between;
      }

      .info-field {
        flex-direction: column;
        align-items: flex-start;
      }

      .info-label {
        margin-bottom: 4px;
      }

      .summary-row {
        flex-direction: column;
        gap: 4px;
      }

      .form-field-row {
        flex-direction: column;
      }

      .dados-container {
        grid-template-columns: 1fr;
      }

      .search-container {
        max-width: 100%;
        grid-column: 1 / -1;
      }

      .topic-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .edit-icon {
        align-self: flex-end;
        margin-top: 5px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 8px;
      }

      .container {
        padding: 10px;
        border-radius: 8px;
      }

      .topic-actions {
        flex-direction: column;
      }

      #login-container {
        padding: 15px;
      }

      #login-form {
        padding: 15px;
      }
    }

    /* Estilo personalizado para Minha Visão Geral de Progresso */
    .custom-progress-bar-fill {
      height: 100%;
      /* background-color será definido inline pelo JavaScript */
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: #000;
      font-size: 0.8rem;
      font-weight: bold;
    }

    /* ESTILO ESPECÍFICO PARA BARRAS DE REVISÃO NO GRÁFICO 3 */
    .revisao-bar-fill {
      height: 100%;
      background: linear-gradient(to right, #FFC107, #FFD54F);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: #000;
      font-size: 0.8rem;
      font-weight: bold;
    }

    /* Estilo de Carregamento (Spinner) */
    .quick-controls .loading {
      border-radius: 50% !important;
      /* Transforma em círculo */
      border: 2px solid rgba(210, 172, 71, 0.3);
      border-top-color: #D2AC47;
      color: transparent !important;
      /* Esconde o texto/ícone de dentro */
      animation: spin 1s linear infinite;
      pointer-events: none;
      /* Impede cliques múltiplos */
    }

    /* Estilo de Sucesso (Pulso Verde) */
    .quick-controls .success {
      border-color: #4CAF50 !important;
      background-color: rgba(76, 175, 80, 0.2) !important;
      animation: pulseSuccess 0.5s ease-out;
    }

    /* Estilo de Erro (Tremor Vermelho) */
    .quick-controls .error {
      border-color: #F44336 !important;
      background-color: rgba(244, 67, 54, 0.2) !important;
      animation: shakeError 0.5s ease-out;
    }

    /* Animações */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes pulseSuccess {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes shakeError {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-3px);
      }

      75% {
        transform: translateX(3px);
      }
    }

    /* --- ESTILOS PARA A BARRA DE PROGRESSO DINÂMICA (CHICO CONCURSOS) --- */
    #chico-progress-bar-container {
      flex: 1;
      display: none;
      /* Começa escondido por padrão */
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-left: 20px;
    }

    .time-allocation-label {
      font-size: 0.8rem;
      font-weight: bold;
      color: #F7EF8A;
      /* >>>>> LINHAS NOVAS ADICIONADAS AQUI <<<<< */
      width: 100%;
      text-align: center;
      /* >>>>> FIM DAS LINHAS NOVAS <<<<< */
    }

    .time-allocation-bar {
      width: 100%;
      max-width: 300px;
      height: 22px;
      background-color: #111;
      border-radius: 11px;
      display: flex;
      overflow: hidden;
      border: 1px solid #555;
    }

    .bar-segment {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-weight: bold;
      font-size: 0.75rem;
      transition: width 0.5s ease-in-out;
      white-space: nowrap;
    }

    .new-content-segment {
      background: linear-gradient(to right, #2E7D32, #4CAF50);
    }

    .review-segment {
      background: linear-gradient(to right, #FFC107, #FFD54F);
    }

    /* --- ESTILOS PARA O TIMER DE FOCO (POMODORO) --- */
    #focus-timer-container {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0, 0, 0, 0.2);
      padding: 5px 12px;
      border-radius: 50px;
      border: 1px solid #444;
      margin-left: 20px;
    }

    #timer-display {
      font-size: 1.4rem;
      font-weight: bold;
      color: #F7EF8A;
      min-width: 70px;
      text-align: center;
    }

    .timer-controls button {
      background: none;
      border: none;
      color: #F7EF8A;
      font-size: 1.2rem;
      cursor: pointer;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .timer-controls button:hover {
      background-color: rgba(210, 172, 71, 0.2);
      transform: scale(1.1);
    }

    #pomodoro-cycles {
      font-size: 1rem;
      color: #aaa;
    }

    /* --- ESTILO PARA MENSAGEM DE AJUDA DO MÉTODO CHICO --- */
    .chico-helper-text {
      font-size: 0.75rem;
      color: #FFC107;
      background-color: rgba(255, 193, 7, 0.1);
      border-left: 3px solid #FFC107;
      padding: 5px 8px;
      margin-top: 5px;
      border-radius: 4px;
      display: none;
      /* Começa escondido */
    }

    /* --- ESTILOS PARA OS BOTÕES DE DIFICULDADE --- */
    .btn-difficulty {
      flex: 1;
      padding: 6px 10px;
      border: 2px solid #555;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      font-size: 0.8rem;
      transition: all 0.2s ease;
      background: #222;
      color: #fff;
    }

    .btn-difficulty:hover {
      transform: translateY(-2px);
      border-color: #F7EF8A;
    }

    .btn-difficulty.active {
      color: #0D0D09;
    }

    .btn-difficulty[data-level="Fácil"].active {
      background: #4CAF50;
      /* Verde */
      border-color: #4CAF50;
    }

    .btn-difficulty[data-level="Médio"].active {
      background: #FFC107;
      /* Amarelo */
      border-color: #FFC107;
    }

    .btn-difficulty[data-level="Difícil"].active {
      background: #F44336;
      /* Vermelho */
      border-color: #F44336;
    }

    /* --- ESTILO PARA O NOVO BOTÃO DE FECHAR --- */
    .btn-fechar-novo {
      /* Forma e Tamanho */
      width: 28px;
      height: 28px;
      border-radius: 50%;

      /* Cor e Fundo */
      background: linear-gradient(135deg, #7A0000 5%, #FF4D4D 45%, #A10000 100%);
      color: white;
      border: 1px solid #FFC9C9;

      /* Conteúdo ("X") */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 16px;
      font-weight: bold;
      line-height: 1;

      /* Layout */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;

      /* Efeitos */
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      flex-shrink: 0;
      /* Impede que o botão seja esmagado */
    }

    .btn-fechar-novo:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }

    /* --- FIM DO ESTILO --- */
    /* --- NOVOS ESTILOS PARA BOTÕES DA AGENDA --- */

    /* 1. Regra Geral: Força TODOS os botões da barra (Texto e Ícones) a terem a mesma altura */
    .agenda-toolbar button {
      height: 20px !important;
      /* Altura fixa igual para todos */
      max-height: 20px !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      vertical-align: middle !important;
      /* Garante alinhamento na linha */
      margin-bottom: 0 !important;
    }

    /* 2. Regra Específica: Botões só de ícone ficam quadrados */
    .btn-icon-only {
      width: 20px !important;
      /* Largura igual à altura */
      padding: 0 !important;
      /* Sem preenchimento interno */
      min-width: 20px !important;
      font-size: 1rem !important;
    }

    /* --- CORREÇÃO: Botão Fechar do Modal (X) --- */
    .btn-close-absolute {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 100;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #7A0000;
      color: white;
      border: 1px solid #ff4d4d;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .btn-close-absolute:hover {
      transform: scale(1.1);
      background: #a10000;
    }

    /* --- ESTILO PARA O NOVO MODAL DE ESCOLHA DE GERAÇÃO --- */
    .generate-options-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }

    .option-card {
      background: #222;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      width: 180px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .option-card:hover {
      border-color: #D2AC47;
      background: #2a2a2a;
      transform: translateY(-3px);
    }

    .option-card i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #F7EF8A;
    }

    .option-card h4 {
      color: #fff;
      margin-bottom: 5px;
    }

    .option-card p {
      font-size: 0.8rem;
      color: #aaa;
    }

    /* Efeito de Tooltip (Nome aparece ao passar o mouse) */
    /* --- EFEITO DE TOOLTIP (CORRIGIDO: Aparece ABAIXO do botão) --- */
    .tooltip-btn {
      position: relative;
    }

    .tooltip-btn:hover::after {
      content: attr(data-title);
      position: absolute;

      /* MUDANÇA PRINCIPAL: Define o topo como referência, empurrando para baixo */
      top: 120%;
      bottom: auto;
      /* Anula a regra anterior que jogava para cima */

      left: 50%;
      transform: translateX(-50%);
      background: #1a1a1a;
      /* Fundo levemente mais escuro para leitura */
      color: #F7EF8A;
      border: 1px solid #D2AC47;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 2000;
      /* Z-index alto para ficar sobre a grade da agenda */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      pointer-events: none;
      animation: fadeInDown 0.2s ease-out;
    }

    /* Nova animação: Aparece deslizando levemente para baixo */
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Agrupamento dos botões de Gerar */
    .generate-group {
      display: flex;
      background: #333;
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid #555;
    }

    .generate-group button {
      border-radius: 0 !important;
      border: none !important;
      border-right: 1px solid #444 !important;
      margin: 0 !important;
    }

    .generate-group button:last-child {
      border-right: none !important;
    }

    /* --- SELEÇÃO TRANSPARENTE (CURSOR INVISÍVEL) --- */
    /* Isso remove o fundo azul padrão quando o número está selecionado */
    #revisao-input::selection {
      background: transparent;
      /* Fundo transparente */
      color: #FFC107;
      /* Texto mantém a cor amarela/dourada */
    }

    /* Suporte para navegador Firefox */
    #revisao-input::-moz-selection {
      background: transparent;
      color: #FFC107;
    }

    /* --- SKELETON SCREENS (UI OTIMISTA) --- */
    /* Sobrescreve o estilo centralizado padrão apenas quando necessário */
    #loading-message.skeleton-mode {
      justify-content: flex-start !important;
      align-items: stretch !important;
      padding: 0 !important;
      background: transparent !important;
    }

    .skeleton-item {
      background: #111;
      border-bottom: 1px solid #333;
      padding: 15px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 65px;
    }

    .skeleton-box {
      background: linear-gradient(90deg, #222 25%, #333 50%, #222 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    .skeleton-text-lg {
      height: 14px;
      width: 60%;
      margin-bottom: 8px;
    }

    .skeleton-text-sm {
      height: 10px;
      width: 30%;
    }

    .skeleton-controls {
      height: 24px;
      width: 100px;
      border-radius: 12px;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    /* --- ESTILOS DA GAMIFICAÇÃO (NOVOS) --- */
    .gamification-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 15px;
    }

    /* Heatmap Estilo GitHub */
    .heatmap-wrapper {
      background: #0d1117;
      /* Fundo escuro GitHub */
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 15px;
      overflow-x: auto;
    }

    .heatmap-grid {
      display: grid;
      grid-template-rows: repeat(7, 12px);
      /* 7 dias da semana */
      grid-auto-flow: column;
      /* Cresce para a direita */
      gap: 3px;
    }

    .heatmap-cell {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      background-color: #161b22;
      /* Cor padrão (vazio) */
    }

    /* Níveis de intensidade (Cores do seu tema Gold) */
    .level-1 {
      background-color: rgba(210, 172, 71, 0.3);
    }

    .level-2 {
      background-color: rgba(210, 172, 71, 0.5);
    }

    .level-3 {
      background-color: rgba(210, 172, 71, 0.7);
    }

    .level-4 {
      background-color: #D2AC47;
    }

    /* Cor sólida */

    /* Container do Burndown */
    .chart-container {
      background: #000;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
      height: 300px;
      position: relative;
    }

    /* --- BOTÃO DE FILTRO ICONIZADO --- */
    .filter-icon-wrapper {
      position: relative;
      /* Para segurar o select invisível dentro */
      width: 36px;
      /* Largura fixa pequena */
      height: 36px;
      /* Altura fixa */
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      /* Mesmo gradiente dos outros botões */
      border-radius: 50%;
      /* Formato circular */
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      cursor: pointer;
      flex-shrink: 0;
      /* Impede que o botão seja esmagado se faltar espaço */
      margin-left: 5px;
    }

    .filter-icon-wrapper:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      background: linear-gradient(135deg, #F4E883, #D2AC47, #AE8625);
    }

    .filter-icon-wrapper i {
      color: #0D0D09;
      /* Cor do ícone */
      font-size: 1rem;
      pointer-events: none;
      /* O clique passa pelo ícone e vai para o select */
    }

    /* O Select Invisível que fica por cima */
    .filter-icon-wrapper select {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      /* Totalmente transparente */
      cursor: pointer;
      appearance: none;
      /* Remove seta padrão do navegador */
      -webkit-appearance: none;
      z-index: 10;
      /* Garante que fique no topo */
      padding: 0;
      border: none;
    }

    /* --- BUSCA FLUTUANTE (MODAL CORRIGIDO) --- */
    .search-wrapper {
      position: relative;
      /* O modal vai se basear na posição deste ícone */
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      /* Largura fixa pequena */
      height: 32px;
      /* Altura fixa pequena */
    }

    .search-btn {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-btn:hover {
      color: #D2AC47;
      background: rgba(255, 255, 255, 0.1);
    }

    /* O MODAL FLUTUANTE (A MÁGICA ACONTECE AQUI) */
    .search-input-modal {
      display: none;
      /* Começa escondido */
      position: absolute;
      top: 45px;
      /* Empurra para baixo do ícone */
      right: -50px;
      /* Ajuste lateral para não sair da tela */
      width: 240px;
      /* Largura da janelinha */
      background: #1a1a1a;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #D2AC47;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
      /* Sombra forte para destacar */
      z-index: 9999;
      /* Garante que fique POR CIMA de tudo */
    }

    /* Quando ativo (via JS), ele aparece */
    .search-wrapper.active .search-input-modal {
      display: block;
      animation: fadeInDown 0.2s ease-out;
    }

    .search-input-modal input {
      width: 100%;
      background: #333;
      border: 1px solid #555;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9rem;
      outline: none;
    }

    .search-input-modal input:focus {
      border-color: #D2AC47;
    }

    /* Animação suave */
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- BARRA SUPERIOR: ALINHAMENTO CENTRAL PERFEITO --- */
    .top-bar {
      display: flex;
      align-items: center;
      /* Centro matemático vertical */
      justify-content: space-between;
      flex-wrap: nowrap;
      overflow: visible;

      /* CONTAINER: A altura será definida pelo conteúdo + padding */
      height: auto;
      padding: 5px 6px;
      /* 5px em cima e 5px em baixo exatos */

      gap: 8px;
      position: relative;
      z-index: 500;
      border-bottom: none;
      margin-bottom: 0;
      background: transparent;
      /* Garante que não haja cor de fundo estranha */
    }

    /* --- MOBILE TOP ROW: escondido no desktop --- */
    .mobile-top-row {
      display: none;
    }

    /* --- MOBILE MENU BTN: escondido no desktop --- */
    .mobile-menu-btn {
      display: none;
    }

    /* Grupo da Esquerda */
    .left-buttons {
      display: flex;
      gap: 4px;
      align-items: center !important;
      height: auto !important;
      overflow-x: auto;
      scrollbar-width: none;
      /* Firefox */
    }

    .left-buttons::-webkit-scrollbar {
      display: none;
    }

    /* Chrome/Safari */

    /* --- REGRA DE OURO: TODOS OS ITENS COM A MESMA ALTURA --- */
    .top-bar button,
    /* Botões Amarelos */
    .search-wrapper,
    /* Wrapper da Lupa */
    .filter-icon-wrapper,
    /* Wrapper do Filtro */
    #disciplineFilter,
    /* Select de Disciplina */
    .search-btn {
      /* Botão da Lupa interno */

      height: 26px !important;
      /* ALTURA UNIFICADA PARA TODOS */
      min-height: 26px !important;
      max-height: 26px !important;

      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      margin: 0 !important;
      /* Remove margens invisíveis */
      line-height: 1 !important;
      /* Evita que texto empurre a altura */
      vertical-align: middle !important;
    }

    /* Ajustes específicos para o conteúdo interno */
    .left-buttons button {
      padding: 0 12px !important;
      font-size: 0.8rem !important;
      border-radius: 50px !important;
      gap: 6px;
    }

    /* Ajustes para os ícones quadrados da direita */
    .search-wrapper,
    .filter-icon-wrapper {
      width: 26px !important;
      /* Quadrados perfeitos 26x26 */
      padding: 0 !important;
      border-radius: 50% !important;
      /* Círculos perfeitos */
    }

    /* Ajuste do Select de Disciplina (precisa ser mais largo) */
    #disciplineFilter {
      width: auto !important;
      max-width: 140px;
      padding: 0 8px !important;
      /* Espaço lateral para o texto não colar */
      border-radius: 50px !important;
    }

    /* Grupo da Direita */
    .right-controls {
      display: flex;
      align-items: center !important;
      gap: 6px;
      margin-left: auto;
      height: auto !important;
    }

    /* Correção de ícones FontAwesome que podem ter line-height próprio */
    .top-bar i {
      line-height: 0 !important;
      display: inline-block !important;
    }

    /* Modal Flutuante de Busca */
    .search-input-modal {
      display: none;
      position: absolute !important;
      top: 40px !important;
      /* Ajustado para não cobrir a barra */
      right: 0 !important;
      width: 240px;
      background: #111;
      border: 1px solid #D2AC47;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.9);
      z-index: 9999 !important;
    }

    .search-wrapper.active .search-input-modal {
      display: block;
    }

    .search-input-modal input {
      width: 100%;
      font-size: 0.85rem;
      padding: 6px;
      background: #333;
      border: 1px solid #555;
      color: white;
      border-radius: 4px;
    }

    /* --- ESTILO PARA OVERLAY DE CARREGAMENTO DA AGENDA --- */
    #agenda-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
      transition: opacity 0.3s ease;
    }

    .loading-content {
      text-align: center;
      background: rgba(30, 30, 30, 0.9);
      padding: 30px 40px;
      border-radius: 10px;
      border: 1px solid #D2AC47;
      box-shadow: 0 0 20px rgba(210, 172, 71, 0.5);
      max-width: 90%;
      width: 400px;
    }

    .spinner-large {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(210, 172, 71, 0.3);
      border-radius: 50%;
      border-top-color: #D2AC47;
      margin: 0 auto 20px;
      animation: spin 1s linear infinite;
    }

    .loading-subtext {
      color: #aaa;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* --- FIM DO ESTILO DO OVERLAY --- */
    /* --- PORTED LOGIN STYLES FROM V57 --- */
    :root {
      /* VARIÁVEIS DO LOGIN (CHICO CONCURSOS) */
      --gold-main: #FFD700;
      --gold-gradient: linear-gradient(135deg, #D2AC47 0%, #F7EF8A 50%, #AE8625 100%);
      --bg-body-login: #050505;
      --bg-card-login: #121212;
    }

    #loginModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-body-login);
      z-index: 100000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      /* Default for mobile/safe */
      padding-top: 20px;
      padding-left: 20px;
      padding-right: 20px;
      padding-bottom: 40px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    @media (min-height: 600px) {
      #loginModal {
        justify-content: flex-start; /* MUDANÇA: Alinha ao topo, não ao centro */
        padding-top: 50px;           /* MUDANÇA: Espaço para não colar no teto */
      }
    }

    .login-container-clean {
      background-color: var(--bg-card-login);
      padding: 40px 30px;
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.15);
      text-align: center;
      border: 1px solid #333;
      position: relative;
    }

    .login-container-clean::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gold-gradient);
      border-radius: 20px 20px 0 0;
    }

    .login-logo-clean {
      font-family: 'Roboto', sans-serif;
      font-weight: 900;
      font-size: 1.8em;
      color: white;
      margin-bottom: 5px;
      letter-spacing: 1px;
    }

    .login-logo-clean span {
      background: var(--gold-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: var(--gold-main);
    }

    .login-badge {
      display: inline-block;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #666;
      margin-bottom: 30px;
      border: 1px solid #333;
      padding: 4px 12px;
      border-radius: 20px;
    }

    .input-wrapper {
      position: relative;
      margin-bottom: 15px;
      text-align: left;
    }

    .input-icon {
      position: absolute;
      left: 15px;
      top: 22px;
      /* Fixed px instead of % to avoid line-height issues */
      transform: translateY(-50%);
      color: #D2AC47;
      font-size: 1rem;
      /* Slightly larger */
      pointer-events: none;
      z-index: 10;
      line-height: 1;
      /* Reset line-height */
      display: flex;
      align-items: center;
      justify-content: center;
      height: 20px;
      width: 20px;
    }

    .login-container-clean input {
      width: 100%;
      height: 45px;
      padding: 0 15px 0 50px !important;
      background-color: #111 !important;
      border: 1px solid #333;
      border-radius: 8px;
      color: white !important;
      font-size: 0.9rem;
      outline: none;
      transition: 0.3s;
      box-sizing: border-box;
    }

    .login-container-clean input:focus {
      border-color: #D2AC47;
      box-shadow: 0 0 10px rgba(210, 172, 71, 0.1);
      background-color: #000 !important;
    }

    .login-container-clean input:-webkit-autofill {
      -webkit-box-shadow: 0 0 0 30px #111 inset !important;
      -webkit-text-fill-color: white !important;
    }

    .login-button-clean {
      width: 100%;
      height: 45px;
      margin-top: 15px;
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      border: none;
      border-radius: 8px;
      color: #000;
      font-weight: 800;
      letter-spacing: 1px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 0.9rem;
      box-shadow: 0 4px 15px rgba(210, 172, 71, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .login-button-clean:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(210, 172, 71, 0.4);
    }

    .login-button-clean:disabled {
      width: 45px !important;
      height: 45px !important;
      margin-left: auto;
      margin-right: auto;
      border-radius: 50% !important;
      padding: 0 !important;
      background: transparent !important;
      border: 2px solid rgba(210, 172, 71, 0.3) !important;
      transform: none !important;
      animation: none !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      cursor: wait;
      box-shadow: none !important;
      color: transparent;
    }

    .login-button-clean:disabled span {
      display: none !important;
    }

    .login-button-clean:disabled .spinner {
      display: block !important;
      position: absolute !important;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto !important;
      width: 24px !important;
      height: 24px !important;
      border: 3px solid transparent !important;
      border-top-color: #D2AC47 !important;
      border-radius: 50% !important;
      animation: spinForce 0.8s linear infinite !important;
    }

    @keyframes spinForce {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
	/* --- CORREÇÃO DE LAYOUT DOS TÓPICOS (MOBILE) --- */
    
    /* Container da direita (Metrics, Datas, Checkboxes) */
    .topic-right-panel {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Container dos Checkboxes */
    .topic-checkbox-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    /* Ajustes Específicos para Mobile (Telas pequenas) */
    @media (max-width: 768px) {
      .topic-right-panel {
        display: flex;
        flex-wrap: wrap; /* Permite que os itens pulem para a próxima linha */
        width: 100%;
        justify-content: space-between; /* Espalha os itens */
        gap: 10px;
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid #222; /* Separação sutil do título */
      }

      /* Grupo de Métricas (Páginas/Cards) */
      .topic-metrics {
        order: 1; /* Fica em primeiro na linha de cima */
      }

      /* Grupo de Datas */
      .topic-dates-wrapper {
        order: 2; /* Fica em segundo na linha de cima */
      }
      
      /* Ícone de Edição */
      .edit-icon {
        order: 2; /* Fica junto com as datas na direita */
      }

      /* O GRANDE TRUQUE: Grupo de Checkboxes vai para uma linha nova inteira */
      .topic-checkbox-group {
        order: 3; /* Vai para baixo */
        width: 100%; /* Ocupa a linha toda */
        background: rgba(255, 255, 255, 0.03); /* Fundo leve para destacar */
        border-radius: 6px;
        padding: 8px 0;
        margin-top: 5px;
        flex-direction: column; /* Mantém cabeçalhos acima dos boxes */
      }
      
      /* Garante que os checkboxes fiquem centralizados nessa nova linha */
      .topic-checkbox-group > div {
        justify-content: center !important;
        width: 100%;
      }
      
      /* Ajuste nas margens dos cabeçalhos E R Q F D no mobile */
      .topic-checkbox-group > div:first-child {
        margin-bottom: 4px !important;
      }
    }
	/* ============================================================ */
    /* === MODO IMERSIVO (TELA CHEIA) PARA CELULAR - V124 === */
    /* ============================================================ */
    @media (max-width: 768px) {
      
      /* 1. Corpo da página: Remove margens e fixa fundo */
      body {
        padding: 0 !important;
        margin: 0 !important;
        background: #000 !important; /* Fundo preto contínuo */
      }

      /* 2. Container Principal (A caixa de fora): Remove bordas e padding */
      .container {
        width: 100% !important;
        max-width: 100% !important;
        border: none !important; /* Remove linha de borda */
        border-radius: 0 !important; /* Remove cantos arredondados */
        box-shadow: none !important; /* Remove sombra 3D */
        padding: 0 !important;
        margin: 0 !important;
      }

      /* 3. Área do App (A caixa do meio): Funde com o fundo */
      .progress-app {
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important; /* Conteúdo cola nas bordas para ganhar espaço */
        box-shadow: none !important;
        background: transparent !important;
        min-height: 100vh !important;
      }

      /* 4. Container da Lista (A caixa de dentro): Remove bordas laterais */
      #topics-list-container {
        border-left: none !important;
        border-right: none !important;
        border-radius: 0 !important;
        background: #000 !important;
      }

      /* 5. Ajuste do Cabeçalho para não ficar colado demais no topo da tela */
      header {
        padding-top: 10px !important;
        padding-bottom: 5px !important;
        background: #0d0d09 !important; /* Fundo sutil para destacar título */
        border-bottom: 1px solid #222;
      }

      /* 6. Garante que a barra de ferramentas (botões) tenha um respiro mínimo */
      .mobile-top-row {
        padding: 8px 10px !important; /* Espacinho nas laterais para não cortar botões */
      }
      
      /* 7. Ajuste final de altura para usar 100% da tela */
      #main-container {
        height: calc(100vh - 120px) !important; 
        padding: 0 !important;
      }
    }
	/* --- CORREÇÃO DOS GRÁFICOS DE PIZZA (RESPONSIVIDADE) --- */
    .pizza-container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      padding: 10px;
    }

    /* No celular, muda a direção para COLUNA (um embaixo do outro) */
    @media (max-width: 768px) {
      .pizza-container {
        flex-direction: column !important; 
        gap: 25px !important;
      }
      
      /* Ajuste fino para centralizar o conteúdo das pizzas no mobile */
      .pizza-container > div {
        justify-content: center !important; /* Centraliza horizontalmente */
      }
    }
	/* =======================================================
       CORREÇÃO FINAL: DESKTOP (Telas acima de 768px)
       ======================================================= */
    @media (min-width: 769px) {

      /* 1. DESTRAVAR ROLAGEM E CORPO */
      html, body {
        height: auto !important;
        overflow-y: auto !important; /* Devolve a barra de rolagem */
        overflow-x: hidden !important;
        position: static !important;
      }

      /* 2. ESTRUTURA PRINCIPAL (LADO A LADO) */
      /* Isso obriga o Menu e o Conteúdo a ficarem vizinhos */
      .container {
        display: flex !important;
        flex-direction: row !important;
        height: auto !important;
        overflow: visible !important;
      }

      /* 3. MENU LATERAL (DISCIPLINAS) */
      .sidebar {
        position: relative !important; /* Tira o modo flutuante/fixed */
        width: 300px !important;       /* Largura fixa */
        min-width: 300px !important;   /* Garante que não encolha */
        height: auto !important;       /* Altura automática */
        display: block !important;
        transform: none !important;    /* Garante que está visível */
        left: 0 !important;
        z-index: 10 !important;
        box-shadow: none !important;
        border-right: 1px solid #ddd;  /* Uma linha sutil para separar */
      }

      /* 4. SOMEM OS ITENS DE CELULAR */
      .mobile-menu-toggle,       /* Botão Hamburguer */
      .close-sidebar-btn,        /* Botão X de fechar */
      #mobile-menu-overlay {     /* Fundo escuro */
        display: none !important;
      }

      /* Garante que o título "Disciplinas" apareça */
      .sidebar-header {
        display: block !important;
      }

      /* 5. CONSERTO DOS CHECKBOXES (LINHA) */
      /* AQUI ESTÁ A MÁGICA: FORÇA ROW (LINHA) */
      .topic-checkbox-group {
        display: flex !important;
        flex-direction: row !important; 
        align-items: center !important;
        justify-content: flex-end !important;
        gap: 15px !important;
        width: auto !important;
        margin-top: 0 !important;
        border: none !important;
        background: transparent !important;
      }

      /* Ajuste dos botões individuais */
      .topic-checkbox-group label {
        width: auto !important;
        margin-bottom: 0 !important;
        padding: 4px 10px !important;
      }

      /* 6. PAINEL DE CONTROLE GERAL */
      .quick-controls {
        flex-direction: row !important;
        flex-wrap: nowrap !important;
      }
      
      /* Ajuste da área principal para não ficar por baixo do menu */
      .main-content {
        flex: 1 !important; /* Ocupa o resto do espaço */
        width: calc(100% - 300px) !important;
        margin-left: 0 !important;
      }
    }
	/* } <--- ESSA CHAVE É A SEGURANÇA (Fecha blocos anteriores esquecidos) */
    }

    /* =======================================================
       CORREÇÃO BLINDADA: DESKTOP (COMPUTADOR > 768px)
       ======================================================= */
   @media (min-width: 769px) {
   /* GARANTIA: O botão X some no PC */
      #btnXFecharMobile {
        display: none !important;
      }
	  
      /* ATIVANDO A ETIQUETA: O que tiver 'mobile-only-hide-pc' some no computador */
      .mobile-only-hide-pc {
        display: none !important;
      }
      /* 1. SUMIR COM OS BOTÕES DE CELULAR (REGRA FORTE) */
      .mobile-menu-toggle, 
      .close-sidebar-btn,
      .mobile-close-menu-btn, /* ADICIONADO AQUI: Esconde o botão Fechar Menu no PC */
      #mobile-menu-overlay {
        display: none !important;
      }
      /* 2. DESTRAVAR BARRA DE ROLAGEM */
      html, body {
        height: auto !important;
        overflow-y: visible !important;
        overflow-x: hidden !important;
        position: static !important;
      }

      /* 3. ALINHAR MENU E CONTEÚDO (LADO A LADO) */
      .container {
        display: flex !important;
        flex-direction: row !important;
        align-items: flex-start !important; /* Alinha no topo */
        width: 100% !important;
      }

      /* 4. TRAVAR O MENU NA ESQUERDA */
      .sidebar {
        display: block !important;
        position: sticky !important; /* Menu acompanha a rolagem suavemente */
        top: 0 !important;
        width: 300px !important;
        min-width: 300px !important;
        height: 100vh !important;
        z-index: 100 !important;
        border-right: 1px solid #ddd !important;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1) !important;
      }

      /* Garante que o cabeçalho do menu apareça */
      .sidebar-header {
        display: block !important;
      }

      /* 5. EMPURRAR O CONTEÚDO PARA A DIREITA */
      .main-content {
        flex-grow: 1 !important;
        width: calc(100% - 300px) !important;
        margin-left: 0 !important;
        padding: 20px !important;
      }

      /* 6. CONSERTAR OS CHECKBOXES (LINHA) */
      .topic-checkbox-group {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: flex-end !important;
        gap: 10px !important;
        width: auto !important;
        border: none !important;
        background: transparent !important;
      }

      .topic-checkbox-group label {
        width: auto !important;
        margin-bottom: 0 !important;
        padding: 5px 10px !important;
      }
      
      .topic-right-panel {
         flex-wrap: nowrap !important;
      }
    }
	/* =======================================================
       CORREÇÃO FINAL DE SEGURANÇA: Esconde X no Computador
       ======================================================= */
    @media (min-width: 769px) {
      #btnXFecharMobile {
        display: none !important;
      }
    }
	/* =======================================================
       CORREÇÃO VISUAL DEFINITIVA: CONTAINER ACOMPANHA LISTA
       ======================================================= */
   @media (min-width: 769px) {

      /* --- 1. SEGURANÇA: ESCONDE BOTÕES DE CELULAR --- */
      #btnXFecharMobile, 
      #btnSairMobile,
      .mobile-only-btn {
        display: none !important;
      }

      /* --- 2. DESTRAVA A ROLAGEM GERAL --- */
      html, body {
        height: auto !important;
        overflow-y: auto !important;
      }

      /* --- 3. CONTAINER PRINCIPAL (A caixa com borda) --- */
      .container {
        display: flex !important;
        flex-direction: column !important;
        height: auto !important;       /* Cresce conforme o conteúdo */
        min-height: 100vh !important;  /* No mínimo a altura da tela */
        overflow: visible !important;  /* Deixa o conteúdo expandir */
        padding-bottom: 40px !important; 
      }

      /* --- 4. CONTAINERS INTERMEDIÁRIOS --- */
      .app-container, 
      .progress-app {
        height: auto !important;
        display: block !important;
        overflow: visible !important;
        flex: none !important;
      }

      /* --- 5. ÁREA DE CONTEÚDO --- */
      #main-container {
        height: auto !important;
        display: block !important;
        overflow: visible !important;
        min-height: unset !important;
      }
      
      .content-area {
        height: auto !important;
        display: flex !important;
        align-items: stretch !important;
      }

      /* --- 6. LISTA DE TÓPICOS (O que empurra tudo) --- */
      #topics-list-container {
        height: auto !important;
        overflow: visible !important;
        flex: 1 !important;
      }
      
      #topics-list {
        height: auto !important;
        overflow: visible !important;
      }
    }
	/* ==========================================
       CORREÇÃO FINAL: AGENDA MOBILE (IDs Corrigidos)
       ========================================== */
    @media (max-width: 768px) {
      
      /* 1. LIMPEZA VISUAL (IDs Corrigidos) */
      /* Oculta Timer, Barra e Abas */
      #focus-timer-container, 
      #chico-progress-bar-container,
      .agenda-tabs,
      #agenda-tabs { 
        display: none !important;
      }

      /* 2. CABEÇALHO DO MODAL (Corrigido para #agenda-modal) */
      #agenda-modal .modal-header {
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding-bottom: 5px !important;
        border-bottom: 1px solid #333 !important;
        display: flex !important;
      }

      /* Ajuste do Título */
      #agenda-modal h3 {
        font-size: 1.2rem !important;
        margin: 0 !important;
        white-space: nowrap !important;
        display: block !important;
      }

      /* 3. SCROLL HORIZONTAL (A Mágica) */
      /* O Container Pai */
      .week-grid-container {
        display: block !important;
        width: 100% !important;
        overflow-x: auto !important; /* Ativa a rolagem */
        padding-bottom: 15px !important;
      }

      /* A Grade Gigante (Forçamos 900px) */
      .week-grid {
        display: grid !important;
        min-width: 900px !important; /* O segredo: maior que a tela */
        width: 900px !important;
        grid-template-columns: 60px repeat(7, 1fr) !important;
        gap: 5px !important;
      }
      
      /* Ajuste de Texto para caber */
      .day-header, .period-header {
        font-size: 0.8rem !important;
        padding: 5px !important;
        word-wrap: break-word !important;
      }

      /* Ajuste do corpo do modal para não cortar */
      #agenda-modal .modal-content {
        padding: 5px !important;
        width: 98% !important;
        max-width: 98% !important;
      }
    }

  </style>
</head>

<body>
  <div class="container">
    <div class="app-container">
      <header>
        <h1 id="header-title">EDITAL VERTICALIZADO</h1>
        <div class="header-user-icon" onclick="toggleUserMenu()" title="Minha Conta">
          <i class="fas fa-user-circle"></i>
        </div>
        <div id="user-dropdown" class="user-dropdown-menu">
          <span id="header-user-email" class="user-dropdown-email">Carregando...</span>
          <button class="btn-logout-dropdown" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Sair do Sistema
          </button>
        </div>
      </header>
      <div class="progress-app">
        <!-- CONTAINER DE LOGIN -->
        <!-- CONTAINER DE LOGIN (PORTED FROM V57) -->
        <div id="loginModal">
          <div class="login-container-clean">
            <div class="login-logo-clean">
              CHICO <span>CONCURSOS</span>
            </div>

            <div class="login-badge">ACESSO RESTRITO</div>

            <form id="login-form">

              <div class="input-wrapper">
                <i class="fas fa-envelope input-icon"></i>
                <input type="email" id="user-email" required placeholder="Digite seu e-mail" autocomplete="off">
              </div>

              <div class="input-wrapper">
                <i class="fas fa-lock input-icon"></i>
                <input type="password" id="user-password" required placeholder="Sua senha de acesso">
              </div>

              <button type="submit" class="login-button-clean" id="loginSubmitBtn">
                <span id="loginBtnText">ENTRAR</span>
                <div class="spinner" id="loginSpinner"></div>
              </button>
            </form>

            <div id="login-error" style="display: none; margin-top: 15px; color: #D2AC47;"></div>
          </div>
        </div>
        <!-- CONTEÚDO PRINCIPAL (APÓS LOGIN) -->
        <div id="app-content" style="display: none;">

          <!-- MOBILE: Linha superior sempre visível (hambúrguer + busca + filtro) -->
          <div class="mobile-top-row">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
              <i class="fas fa-bars"></i>
            </button>

            <div class="search-wrapper" id="expandableSearchMobile">
              <button class="search-btn" onclick="toggleSearchMobile()" title="Pesquisar">
                <i class="fas fa-search"></i>
              </button>
              <div class="search-input-modal">
                <input type="text" id="searchInputMobile" placeholder="Digite para buscar..."
                  oninput="syncSearchInput(this); filterTopics()">
              </div>
            </div>

            <div class="filter-icon-wrapper" title="Filtrar por Status" style="width: 32px; height: 32px;"> <i
                class="fas fa-filter"></i>
              <select id="statusFilterMobile" onchange="syncStatusFilter(this); filterTopics()">
                <option value="" selected disabled hidden>Filtrar</option>
                <option value="">🔄 Ver Todos</option>
                <option value="estudado">✅ Estudados</option>
                <option value="nao_estudado">⬜ Não Estudados</option>
                <option value="revisado">🔄 Revisados</option>
                <option value="nao_revisado">⬜ Não Revisados</option>
                <option value="questoes">❓ Questões Feitas</option>
                <option value="nao_questoes">⬜ Questões Pendentes</option>
                <option value="flashcards">⚡ Flashcards Feitos</option>
                <option value="nao_flashcards">⬜ Flashcards Pendentes</option>
              </select>
            </div>
          </div>

          <!-- MENU HAMBÚRGUER (abre/fecha via botão ☰) -->
         <div class="top-bar" id="mainTopBar">
    
    <button id="btnXFecharMobile" class="mobile-close-menu-btn" onclick="toggleMobileMenu()" style="margin-bottom: 0;">
    FECHAR MENU
</button>

    <div class="left-buttons">
      <button onclick="showProgressOverviewWithLoading()"><i class="fas fa-chart-bar"></i> Visão Geral</button>
      <button onclick="showIndividualProgressOverviewWithLoading()"><i class="fas fa-chart-bar"></i> Minha Visão</button>
      <button onclick="openUserGoalsModal()"><i class="fas fa-bullseye"></i> Metas</button>
      <button onclick="showRaioXOverviewWithLoading()"><i class="fas fa-binoculars"></i> Raio X</button>
      <button onclick="showDadosOverviewWithLoading()"><i class="fas fa-database"></i> Dados</button>
      <button onclick="showEstatisticasMetasWithLoading()"><i class="fas fa-chart-line"></i> Estatísticas</button>
      <button onclick="showAgendaWithLoading()"><i class="fas fa-calendar-alt"></i> Agenda</button>
	  <button id="btnSairMobile" onclick="logout()" class="mobile-only-btn" style="background: linear-gradient(135deg, #7A0000, #A10000); color: white; border: 1px solid #ff4d4d; margin-top: 10px;">
    <i class="fas fa-sign-out-alt"></i> Sair
</button>
    </div>

    <div class="right-controls">
      
      <select id="disciplineFilter" onchange="filterTopics()" 
              style="max-width: 140px; height: 32px; padding: 0 8px; margin-right: 10px;">
        <option value="">Todas as Disciplinas</option>
      </select>

      <div class="search-wrapper" id="expandableSearch">
        <button class="search-btn" onclick="toggleSearch()" title="Pesquisar">
          <i class="fas fa-search"></i>
        </button>
        <div class="search-input-modal">
          <input type="text" id="searchInput" placeholder="Digite para buscar..." oninput="filterTopics()">
                </div>
              </div>

              <div class="filter-icon-wrapper" title="Filtrar por Status" style="width: 32px; height: 32px;"> <i
                  class="fas fa-filter"></i>
                <select id="statusFilter" onchange="filterTopics()">
                  <option value="" selected disabled hidden>Filtrar</option>
                  <option value="">🔄 Ver Todos</option>
                  <option value="estudado">✅ Estudados</option>
                  <option value="nao_estudado">⬜ Não Estudados</option>
                  <option value="revisado">🔄 Revisados</option>
                  <option value="nao_revisado">⬜ Não Revisados</option>
                  <option value="questoes">❓ Questões Feitas</option>
                  <option value="nao_questoes">⬜ Questões Pendentes</option>
                  <option value="flashcards">⚡ Flashcards Feitos</option>
                  <option value="nao_flashcards">⬜ Flashcards Pendentes</option>
                </select>
              </div>

            </div>
          </div>
          <div id="main-container">
            <div id="loading-message" class="skeleton-mode">
              <div class="skeleton-item">
                <div style="width: 70%">
                  <div class="skeleton-box skeleton-text-lg"></div>
                  <div class="skeleton-box skeleton-text-sm"></div>
                </div>
                <div class="skeleton-box skeleton-controls"></div>
              </div>
              <div class="skeleton-item">
                <div style="width: 70%">
                  <div class="skeleton-box skeleton-text-lg" style="width: 40%"></div>
                  <div class="skeleton-box skeleton-text-sm" style="width: 20%"></div>
                </div>
                <div class="skeleton-box skeleton-controls"></div>
              </div>
              <div class="skeleton-item">
                <div style="width: 70%">
                  <div class="skeleton-box skeleton-text-lg" style="width: 80%"></div>
                  <div class="skeleton-box skeleton-text-sm"></div>
                </div>
                <div class="skeleton-box skeleton-controls"></div>
              </div>
              <div class="skeleton-item">
                <div style="width: 70%">
                  <div class="skeleton-box skeleton-text-lg" style="width: 50%"></div>
                  <div class="skeleton-box skeleton-text-sm"></div>
                </div>
                <div class="skeleton-box skeleton-controls"></div>
              </div>
              <div class="skeleton-item">
                <div style="width: 70%">
                  <div class="skeleton-box skeleton-text-lg" style="width: 60%"></div>
                  <div class="skeleton-box skeleton-text-sm"></div>
                </div>
                <div class="skeleton-box skeleton-controls"></div>
              </div>
              <div class="skeleton-item">
                <div style="width: 70%">
                  <div class="skeleton-box skeleton-text-lg" style="width: 45%"></div>
                  <div class="skeleton-box skeleton-text-sm"></div>
                </div>
                <div class="skeleton-box skeleton-controls"></div>
              </div>
            </div>
            <div id="error-message" style="display:none;"></div>
            <div class="content-area">
              <div id="topics-list-container" style="display:none;">
                <div class="list-header">
                  <span>Tópicos do Edital</span>
                  <span id="filtered-counter">0/0</span>
                </div>
                <ul id="topics-list"></ul>
              </div>
              <div id="topic-detail-container" style="display:none;">
                <button class="btn-fechar-novo" title="Fechar e voltar à lista" onclick="closeTopicDetails()"
                  style="position: absolute; top: 8px; right: 8px; z-index: 10;">X</button>
                <!-- Banner de Modo Edição -->
                <div class="edit-mode-banner" id="edit-mode-banner">
                  <i class="fas fa-edit"></i> MODO EDIÇÃO ATIVADO - Você está editando informações do tópico
                </div>
                <div id="topic-detail-title">Título do Tópico</div>
                <div id="topic-detail-discipline">
                  <i class="fas fa-book"></i>
                  <span>Disciplina</span>
                </div>
                <!-- Nova estrutura: Informações + Controles de Progresso em colunas -->
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                  <!-- Coluna da Esquerda: Informações do Tópico -->
                  <div class="topic-info" style="flex: 1; min-width: 250px;">
                    <div class="info-field">
                      <span class="info-label">Disciplina:</span>
                      <span class="info-value" id="info-disc">Carregando...</span>
                      <input type="text" class="edit-input" id="edit-disc" style="display: none;">
                    </div>
                    <div class="info-field">
                      <span class="info-label">Sequência:</span>
                      <span class="info-value" id="info-seq">Carregando...</span>
                      <input type="text" class="edit-input" id="edit-seq" style="display: none;">
                    </div>
                    <div class="info-field">
                      <span class="info-label">Tópico:</span>
                      <span class="info-value" id="info-topico">Carregando...</span>
                      <input type="text" class="edit-input" id="edit-topico" style="display: none;">
                    </div>
                    <div class="info-field">
                      <span class="info-label">Subtópico:</span>
                      <span class="info-value" id="info-subtopico">Carregando...</span>
                      <input type="text" class="edit-input" id="edit-subtopico" style="display: none;">
                    </div>
                  </div>
                  <!-- Coluna da Direita: Controles de Progresso -->
                  <div class="progress-controls"
                    style="flex: 1; min-width: 300px; overflow-y: auto; max-height: 250px; border: 1px solid #333; border-radius: 5px; padding: 10px; background: rgba(255, 255, 255, 0.05);">
                    <div class="progress-item">
                      <div class="progress-label">
                        <i class="fas fa-book"></i>
                        <span>Estudo Concluído</span>
                      </div>
                      <div class="progress-status">
                        <label class="custom-checkbox estudo">
                          <input type="checkbox" id="estudo-checkbox" onchange="updateCheckboxStatus('estudo')">
                          <span class="checkmark">✓</span>
                        </label>
                        <input type="date" class="date-input" id="estudo-date">
                      </div>
                    </div>
                    <div class="progress-item">
                      <div class="progress-label">
                        <i class="fas fa-sync-alt"></i>
                        <span>Quantidade de Revisões</span>
                      </div>
                      <div class="progress-status">
                        <input type="number" id="revisao-count" min="0" value="0" class="revisao-count-input"
                          onchange="updateRevisaoStatus()" title="Número de vezes que revisou este tema">
                        <input type="date" class="date-input" id="revisao-date">
                      </div>
                    </div>
                    <div class="progress-item">
                      <div class="progress-label">
                        <i class="fas fa-question-circle"></i>
                        <span>Questões Concluídas</span>
                      </div>
                      <div class="progress-status">
                        <label class="custom-checkbox questoes">
                          <input type="checkbox" id="questoes-checkbox" onchange="updateCheckboxStatus('questoes')">
                          <span class="checkmark">✓</span>
                        </label>
                        <input type="date" class="date-input" id="questoes-date">
                      </div>
                    </div>
                    <!-- NOVO BLOCO PARA FLASHCARDS -->
                    <div class="progress-item">
                      <div class="progress-label">
                        <i class="fas fa-layer-group"></i>
                        <span>Flashcards Concluídos</span>
                      </div>
                      <div class="progress-status">
                        <label class="custom-checkbox flashcards">
                          <input type="checkbox" id="flashcards-checkbox" onchange="updateCheckboxStatus('flashcards')">
                          <span class="checkmark">✓</span>
                        </label>
                        <input type="date" class="date-input" id="flashcards-date">
                      </div>
                    </div>
                    <!-- FIM DO NOVO BLOCO -->
                  </div>
                </div>

                <div class="progress-item"
                  style="flex-direction: column; align-items: flex-start; margin-top: 10px; background: rgba(255, 255, 255, 0.05); border: 1px solid #333;">
                  <div class="progress-label"
                    style="margin-bottom: 8px; width: 100%; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <i class="fas fa-brain" style="color: #D2AC47;"></i>
                      <span style="font-weight: bold; color: #F7EF8A;">Nível de Dificuldade (SRS)</span>
                    </div>
                    <span style="font-size: 0.7rem; color: #aaa; font-style: italic;">Define a data da próxima
                      revisão</span>
                  </div>

                  <div id="difficulty-controls" style="display: flex; gap: 8px; width: 100%;">
                    <button class="btn-difficulty" data-level="Fácil" onclick="setDifficulty('Fácil')"
                      title="Revisão após: 2, 6, 14, 30, 60 dias">
                      <i class="fas fa-smile"></i> Fácil
                    </button>
                    <button class="btn-difficulty" data-level="Médio" onclick="setDifficulty('Médio')"
                      title="Revisão após: 1, 3, 7, 15, 30 dias">
                      <i class="fas fa-meh"></i> Médio
                    </button>
                    <button class="btn-difficulty" data-level="Difícil" onclick="setDifficulty('Difícil')"
                      title="Revisão após: 1, 2, 4, 8, 15 dias">
                      <i class="fas fa-dizzy"></i> Difícil
                    </button>
                  </div>
                </div>
                <!-- FIM DO NOVO BLOCO DE DIFICULDADE -->

                <!-- Ações -->
                <div class="topic-actions">
                  <button class="btn-save" onclick="saveProgress()" id="save-progress-btn">
                    <i class="fas fa-save"></i> Salvar Progresso
                    <i class="fas fa-spinner button-spinner" style="display: none;"></i>
                  </button>
                  <button class="btn-reset" onclick="resetProgress()" id="reset-progress-btn">
                    <i class="fas fa-undo"></i> Limpar Progresso
                    <i class="fas fa-spinner button-spinner" style="display: none;"></i>
                  </button>
                  <button class="btn-edit" id="edit-topic-btn" onclick="toggleEditMode()">
                    <i class="fas fa-edit"></i> Editar Tópico
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NOTIFICAÇÕES -->
  <div class="notification-container" id="notification-container"></div>

  <!-- MODAL DE CONFIRMAÇÃO -->
  <div class="modal-backdrop" id="confirmModal">
    <div class="modal">
      <h3>Confirmação</h3>
      <p id="confirmMessage">Tem certeza que deseja executar esta ação?</p>
      <div class="modal-buttons">
        <button class="btn-modal-cancel" onclick="closeModal(false)">Cancelar</button>
        <button class="btn-modal-confirm" onclick="closeModal(true)">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE VISÃO GERAL -->
  <div class="modal-backdrop" id="overviewModal">
    <div class="modal"
      style="width: 92%; max-width: 900px; max-height: 92vh; overflow: hidden; text-align: center; position: relative;">
      <button class="btn-fechar-novo" onclick="closeOverviewModal()"
        style="position: absolute; top: 10px; right: 10px; z-index: 10;">X</button>
      <h3 id="overview-title" style="margin-top: 0px; margin-bottom: 10px;"><i class="fas fa-chart-bar"></i> VISÃO GERAL
      </h3>
      <div id="overview-content" class="overview-modal-content" style="padding-top: 0;"></div>
    </div>
  </div>

  <!-- NOVO MODAL: DADOS -->
  <div class="modal-backdrop" id="dadosModal">
    <div class="modal"
      style="width: 92%; max-width: 900px; max-height: 92vh; overflow: hidden; text-align: center; position: relative;">
      <button class="btn-fechar-novo" onclick="closeDadosModal()"
        style="position: absolute; top: 10px; right: 10px; z-index: 10;">X</button>
      <h3 id="dados-title" style="margin-top: 0px; margin-bottom: 10px;"><i class="fas fa-database"></i> DADOS DO EDITAL
      </h3>
      <div id="dados-content" class="overview-modal-content" style="padding-top: 0;"></div>
    </div>
  </div>
  <!-- MODAL DE ESTATÍSTICAS DAS METAS -->
  <div class="modal-backdrop" id="estatisticasModal">
    <div class="modal"
      style="width: 92%; max-width: 900px; max-height: 92vh; overflow: hidden; text-align: center; position: relative;">
      <button class="btn-fechar-novo" onclick="closeEstatisticasModal()"
        style="position: absolute; top: 10px; right: 10px; z-index: 10;">X</button>
      <h3 id="estatisticas-title" style="margin-top: 0px; margin-bottom: 10px;"><i class="fas fa-chart-line"></i>
        ESTATÍSTICAS DAS METAS</h3>
      <div id="estatisticas-content" class="overview-modal-content" style="padding-top: 0;"></div>
    </div>
  </div>

  <!-- NOVO MODAL: AGENDA -->
  <div class="modal-backdrop" id="agendaModal">
    <div class="modal" style="width: 95%; max-width: 1200px; max-height: 95vh; overflow: hidden;">

      <!-- ================================================================ -->
      <!-- INÍCIO DO NOVO CABEÇALHO ORGANIZADO (COM TIMER) -->
      <!-- ================================================================ -->
      <div class="modal-header"
        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">

        <!-- Zona Esquerda: Título -->
        <h3 style="margin: 0; color: #F7EF8A;">
          <i class="fas fa-calendar-alt"></i> MINHA AGENDA DE ESTUDOS
        </h3>

        <!-- Zona Central e Direita -->
        <div style="display: flex; align-items: center; gap: 20px;">
          <!-- Abas -->
          <div class="agenda-tabs" style="margin-bottom: 0; display: inline-flex; gap: 5px;">
            <button class="agenda-tab active" onclick="switchAgendaTab('semanal')">
              <i class="fas fa-calendar-week"></i> Semanal
            </button>
            <button class="agenda-tab" onclick="switchAgendaTab('mensal')">
              <i class="fas fa-calendar"></i> Mensal
            </button>
            <button class="agenda-tab" onclick="switchAgendaTab('config')">
              <i class="fas fa-cog"></i> Configurações
            </button>
          </div>
          <!-- Barra de Progresso Chico -->
          <div id="chico-progress-bar-container">
            <div class="time-allocation-label">(🕰️ C. Concursos)</div>
            <div class="time-allocation-bar">
              <div class="bar-segment new-content-segment" id="new-content-segment" title="Tempo para Conteúdo Novo">
              </div>
              <div class="bar-segment review-segment" id="review-segment" title="Tempo para Revisão"></div>
            </div>
          </div>

          <!-- >>>>> INÍCIO DO NOVO TIMER DE FOCO <<<<< -->
          <div id="focus-timer-container">
            <span id="timer-display">25:00</span>
            <div class="timer-controls">
              <button id="timer-start-pause" onclick="startPauseTimer()"><i class="fas fa-play"></i></button>
              <button id="timer-reset" onclick="resetTimer()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div id="pomodoro-cycles" title="Ciclos Pomodoro Concluídos"></div>
            <button class="timer-controls" id="timer-mode-toggle" onclick="toggleTimerMode()"
              title="Alternar para modo Cronômetro"><i class="fas fa-stopwatch"></i></button>
          </div>
          <!-- >>>>> FIM DO NOVO TIMER DE FOCO <<<<< -->

          <!-- Botão Fechar -->
          <!-- Botão Fechar -->
          <button class="btn-fechar-novo" onclick="closeAgendaModal()" title="Fechar">X</button>
        </div>
      </div>
      <!-- ================================================================ -->
      <!-- FIM DO NOVO CABEÇALHO -->
      <!-- ================================================================ -->

      <!-- Conteúdo das Abas -->
      <div id="agenda-content" class="agenda-content">
        <!-- Conteúdo será carregado dinamicamente -->
      </div>
    </div>
  </div>

  <!-- NOVO MODAL: METAS DO USUÁRIO -->
  <div class="modal-backdrop" id="userGoalsModal">
    <div class="modal">
      <h3><i class="fas fa-bullseye"></i> Minhas Metas e Contadores</h3>
      <div class="form-field-row">
        <div class="form-field">
          <label for="goal-Meta Diária Tópicos">Meta Diária Tópicos</label>
          <input type="number" id="goal-Meta Diária Tópicos" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Meta Horas Estudo">Meta Horas Estudo</label>
          <input type="time" id="goal-Meta Horas Estudo">
        </div>
        <div class="form-field">
          <label for="goal-Meta Dias Estudo">Meta Dias Estudo</label>
          <input type="number" id="goal-Meta Dias Estudo" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Meta Data Conclusão">Meta Data Conclusão</label>
          <input type="date" id="goal-Meta Data Conclusão">
        </div>
      </div>
      <div class="form-field-row">
        <div class="form-field">
          <label for="goal-Meta T. Páginas">Meta T. Páginas</label>
          <input type="number" id="goal-Meta T. Páginas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Meta T. Vídeo Aulas">Meta T. Vídeo Aulas</label>
          <input type="number" id="goal-Meta T. Vídeo Aulas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Meta T. Artigos">Meta T. Artigos</label>
          <input type="number" id="goal-Meta T. Artigos" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Meta T. Flashcards">Meta T. Flashcards</label>
          <input type="number" id="goal-Meta T. Flashcards" min="0">
        </div>
      </div>
      <div class="form-field-row">
        <div class="form-field">
          <label for="goal-Total Material Páginas">Total Material Páginas</label>
          <input type="number" id="goal-Total Material Páginas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Total Material Vídeo Aulas">Total Material Vídeo Aulas</label>
          <input type="number" id="goal-Total Material Vídeo Aulas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Total Material Artigos">Total Material Artigos</label>
          <input type="number" id="goal-Total Material Artigos" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Total Material Flashcards">Total Material Flashcards</label>
          <input type="number" id="goal-Total Material Flashcards" min="0">
        </div>
      </div>
      <div class="form-field-row">
        <div class="form-field">
          <label for="goal-Páginas Concluídas">Páginas Concluídas</label>
          <input type="number" id="goal-Páginas Concluídas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Vídeo Aulas Concluídas">Vídeo Aulas Concluídas</label>
          <input type="number" id="goal-Vídeo Aulas Concluídas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Artigos Concluídos">Artigos Concluídos</label>
          <input type="number" id="goal-Artigos Concluídos" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Flashcards Concluídos">Flashcards Concluídos</label>
          <input type="number" id="goal-Flashcards Concluídos" min="0">
        </div>
      </div>
      <div class="modal-buttons">
        <button class="btn-modal-cancel" onclick="closeUserGoalsModal()">Fechar</button>
        <button class="btn-modal-confirm" onclick="saveUserGoals()" id="save-goals-btn">
          Salvar Metas
          <i class="fas fa-spinner button-spinner" style="display: none;"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURAÇÃO ---
    let WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxbrBY73qz1bGkxPSISORr2kIRFJUrpRDTBhZnH8G51JsPxjIDRDFnKXwd7vSmfF64tZA/exec";

    // --- LÓGICA HÍBRIDA DE ID (URL ou LOCALSTORAGE) ---
    const urlParamsId = new URLSearchParams(window.location.search);
    // Tenta pegar da URL, se não tiver, tenta pegar do login salvo no navegador
    let SHEET_ID = urlParamsId.get('id') || localStorage.getItem('userSpreadsheetId');

    if (!SHEET_ID) {
      console.warn("Aguardando login para obter ID da planilha.");
    }

    if (!SHEET_ID) {
      // Alerta opcional se quiser avisar que está sem ID
      console.warn("ATENÇÃO: ID da planilha não fornecido na URL.");
    }
    // --- VARIÁVEIS GLOBAIS ---
    let allTopics = [];
    let filteredTopics = [];
    let currentTopicSequence = null;
    let isContainerExpanded = false;
    let isEditMode = false;
    let originalTopicData = {};
    let currentUserName = null;
    let currentUserGoals = {};
    let globalMetas = {};
    let disciplineConfig = []; // Nova lista dinâmica de disciplinas
    let agendaData = [];

    // === NOVO SISTEMA DE FILA OFFLINE (SYNC MANAGER) ===
    const SyncManager = {
      queue: JSON.parse(localStorage.getItem('offlineQueue') || '[]'),
      isSyncing: false,

      // Adiciona uma ação à fila
      enqueue: function (actionName, payload, successMessage) {
        this.queue.push({
          action: actionName,
          payload: payload,
          message: successMessage,
          timestamp: new Date().getTime()
        });
        this.saveQueue();

        if (navigator.onLine) {
          this.processQueue(); // Tenta enviar já se tiver internet
        } else {
          showNotification('Sem conexão. Dados salvos offline! 💾 Será sincronizado automaticamente.', 'warning');
        }
      },

      // Salva a fila no navegador
      saveQueue: function () {
        localStorage.setItem('offlineQueue', JSON.stringify(this.queue));
      },

      // Processa a fila (envia os dados)
      processQueue: async function () {
        if (this.isSyncing || this.queue.length === 0 || !navigator.onLine) return;

        this.isSyncing = true;
        const item = this.queue[0]; // Pega o primeiro da fila

        try {
          // Exibe spinner se for uma ação manual visível
          const btnSave = document.querySelector('.btn-save');
          if (btnSave) {
            // Apenas indicação visual sutil se desejar
          }

          console.log(`Sincronizando: ${item.action}...`);

          const url = new URL(WEB_APP_URL);
          const params = new URLSearchParams();
          params.append("action", item.action);
          if (SHEET_ID) params.append("spreadsheetId", SHEET_ID);

          // Adiciona todos os parâmetros do payload
          for (const key in item.payload) {
            // Se for objeto (como a agenda completa), converte para string
            if (typeof item.payload[key] === 'object') {
              params.append(key, JSON.stringify(item.payload[key]));
            } else {
              params.append(key, item.payload[key]);
            }
          }

          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params,
            redirect: 'follow'
          });

          const result = await response.json();
          if (result.error) throw new Error(result.error);

          // Sucesso! Remove da fila
          this.queue.shift();
          this.saveQueue();

          // Só exibe notificação se houver uma mensagem personalizada
          if (item.message) {
            showNotification(item.message, 'success');
          }

          // Continua processando se houver mais
          this.isSyncing = false;
          if (this.queue.length > 0) this.processQueue();

        } catch (error) {
          console.error("Erro na sincronização:", error);
          this.isSyncing = false;
          // Não removemos da fila, tentará de novo depois
        }
      }
    };

    // Monitora a volta da internet para processar a fila
    window.addEventListener('online', () => {
      console.log('Conexão restaurada. Sincronizando fila...');
      SyncManager.processQueue();
    });

    // Tenta processar a cada 30 segundos por segurança
    setInterval(() => SyncManager.processQueue(), 30000);

    // --- VARIÁVEIS DO TIMER DE FOCO ---
    let timerInterval = null;
    let timerSeconds = 25 * 60; // Padrão de 25 minutos
    let isTimerRunning = false;
    let timerMode = 'pomodoro'; // 'pomodoro' ou 'chronometer'
    let pomodoroState = 'focus'; // 'focus', 'short_break', 'long_break'
    let pomodoroCycles = 0;
    let pomodoroSettings = {
      focus: 25,
      short_break: 5,
      long_break: 15,
      cycles_to_long_break: 4
    };

    // --- FUNÇÕES AUXILIARES ---
    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('loading');
      } else {
        button.classList.remove('loading');
      }
    }

    function formatarData(dataISO) {
      if (!dataISO) return '—';
      const data = new Date(dataISO);
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    function formatarHoras(decimalHoras) {
      if (!decimalHoras || decimalHoras <= 0) return '—';
      const totalMinutos = Math.round(decimalHoras * 60);
      const horas = Math.floor(totalMinutos / 60);
      const minutos = totalMinutos % 60;
      if (minutos === 0) {
        return `${horas}h`;
      } else {
        return `${horas}h${minutos.toString().padStart(2, '0')}m`;
      }
    }
    // --- INICIALIZAÇÃO ---
    document.addEventListener("DOMContentLoaded", function () {
      // 1. Configura listener do login
      const loginForm = document.getElementById("login-form");
      if (loginForm) {
        loginForm.addEventListener("submit", function (e) {
          e.preventDefault();
          login();
        });
      }

      // 2. Tenta recuperar sessão salva
      const savedUser = localStorage.getItem('currentUserName');
      const savedCourse = localStorage.getItem('userCourseName'); // Recupera nome do curso

      // 3. Se tiver curso salvo, já atualiza o título antes mesmo de carregar os dados
      if (savedCourse) {
        const titleEl = document.getElementById('header-title');
        if (titleEl) titleEl.textContent = savedCourse;
        document.title = savedCourse;
      }

      // 4. Se estiver logado, libera o acesso
      if (savedUser) {
        currentUserName = savedUser;
        const headerDisplay = document.getElementById('header-user-email');
        if (headerDisplay) headerDisplay.textContent = savedUser;

        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';

        // Garante que o ID da planilha esteja carregado
        if (!SHEET_ID) {
          SHEET_ID = localStorage.getItem('userSpreadsheetId');
        }

        loadAllData(true);
      }
    });

    // --- SISTEMA DE LOGIN ---
    async function login() {
      const emailInput = document.getElementById('user-email');
      const passInput = document.getElementById('user-password');
      const errorElement = document.getElementById('login-error');
      const submitButton = document.getElementById('loginSubmitBtn');

      if (emailInput && passInput) {
        const email = emailInput.value.trim();
        const password = passInput.value.trim();

        if (!email || !password) {
          errorElement.textContent = 'Preencha e-mail e senha.';
          errorElement.style.display = 'block';
          return;
        }

        // --- NOVA LÓGICA DE LOADING (CSS :disabled) ---
        submitButton.disabled = true;
        errorElement.style.display = 'none';

        try {
          const payload = { action: 'login', email: email, password: password };

          // Timeout de 10s para o login (evita tela travada)
          const loginController = new AbortController();
          const loginTimeout = setTimeout(() => loginController.abort(), 10000);

          const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            signal: loginController.signal
          });
          clearTimeout(loginTimeout);

          if (!response.ok) throw new Error(`Erro HTTP ${response.status}`);
          const result = await response.json();

          if (result.status === 'error' || result.error || result.erro) {
            throw new Error(result.message || result.error || result.erro);
          }

          // --- SUCESSO ---
          const realUserName = result.realUserName || result.nomeUsuario;
          const userSpreadsheetId = result.spreadsheetId;
          const userCourseName = result.nomeCurso;

          if (!userSpreadsheetId) throw new Error("Erro: ID da planilha não retornado.");

          // >>> CORREÇÃO AQUI: Atualiza a variável global IMEDIATAMENTE <<<
          SHEET_ID = userSpreadsheetId;

          // 1. Salva dados críticos
          currentUserName = realUserName;
          localStorage.setItem('currentUserName', realUserName);
          localStorage.setItem('savedUserEmail', realUserName);
          localStorage.setItem('savedSheetId', userSpreadsheetId);
          localStorage.setItem('savedCourseName', userCourseName);
          localStorage.setItem('userSpreadsheetId', userSpreadsheetId);

          // 2. Salva e Aplica o Nome do Curso
          if (userCourseName) {
            localStorage.setItem('userCourseName', userCourseName);
            // Atualiza o título imediatamente
            const titleEl = document.getElementById('header-title');
            if (titleEl) titleEl.textContent = userCourseName;
            // Atualiza também o título da aba do navegador
            document.title = userCourseName;
          }

          // 3. Atualiza URL e Interface
          const newUrl = new URL(window.location);
          newUrl.searchParams.set('id', userSpreadsheetId);
          window.history.pushState({}, '', newUrl);

          const headerDisplay = document.getElementById('header-user-email');
          if (headerDisplay) headerDisplay.textContent = realUserName;

          document.getElementById('loginModal').style.display = 'none';
          document.getElementById('app-content').style.display = 'block';
          showNotification(`Bem-vindo ao ${userCourseName || 'Sistema'}!`);

          await loadAllData();
          showProgressOverviewWithLoading();

        } catch (error) {
          console.error("Erro login:", error);
          errorElement.textContent = error.message;
          errorElement.style.display = 'block';
        } finally {
          submitButton.disabled = false; // Re-enable button
        }
      }
    }

    function logout() {
      localStorage.clear(); // Limpa todos os dados salvos
      location.reload();    // Recarrega a página para voltar ao login
    }

    // --- FUNÇÕES DE INTERFACE ---
    function closeTopicDetails() {
      // Esconde o painel de detalhes
      document.getElementById("topic-detail-container").style.display = 'none';

      // ✅ MOSTRA a lista de tópicos novamente
      document.getElementById("topics-list-container").style.display = 'block';

      // Remove seleção ativa de todos os tópicos
      document.querySelectorAll(".topic-item").forEach(item => {
        item.classList.remove("active");
      });

      // Limpa a sequência atual
      currentTopicSequence = null;

      // ✅ Desativa modo de edição se estiver ativo
      if (isEditMode) {
        deactivateEditMode();
      }

      // Feedback visual
      showNotification('Voltando à lista de tópicos', 'success');
    }

    function showNotification(message, type = 'success') {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-icon ${type}">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">${type === 'success' ? 'Sucesso!' : 'Erro!'}</div>
          <div class="notification-text">${message}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      container.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 8000); // Aumentado de 5000 para 8000 ms (8 segundos)
    }

    function showConfirm(message, callback) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmModal').style.display = 'flex';
      window.deleteCallback = callback;
    }

    function closeModal(confirmed) {
      document.getElementById('confirmModal').style.display = 'none';
      if (window.deleteCallback) {
        window.deleteCallback(confirmed);
        window.deleteCallback = null;
      }
    }

    function showSection(sectionId) {
      const sections = [
        "topics-list-container",
        "topic-detail-container",
        "loading-message",
        "error-message"
      ];
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      if (sectionId && document.getElementById(sectionId)) {
        document.getElementById(sectionId).style.display = 'block';
      }
    }

    function updateTopicCounter() {
      const filteredCounter = document.getElementById("filtered-counter");
      if (filteredCounter) {
        filteredCounter.textContent = `${filteredTopics.length}/${allTopics.length}`;
      }
    }

    function populateDisciplineFilter() {
      const filterSelect = document.getElementById("disciplineFilter");
      const filterSelectMobile = document.getElementById("disciplineFilterMobile");
      if (filterSelect) {
        // 1. SALVA o que está selecionado antes de limpar
        const savedValue = filterSelect.value;

        filterSelect.innerHTML = "<option value=\"\">Disciplinas</option>";
        const disciplines = [...new Set(allTopics.map(topic => topic.Disciplinas).filter(discipline => discipline))];
        disciplines.forEach(discipline => {
          const option = document.createElement("option");
          option.value = discipline;
          option.textContent = discipline;
          filterSelect.appendChild(option);
        });

        // 2. RESTAURA a seleção se ela ainda existir
        if (savedValue) {
          filterSelect.value = savedValue;
        }

        // 3. Popula o clone mobile também
        if (filterSelectMobile) {
          filterSelectMobile.innerHTML = filterSelect.innerHTML;
          filterSelectMobile.value = filterSelect.value;
        }
      }
    }

    function displayTopicsList() {
      const listElement = document.getElementById("topics-list");
      if (listElement) {
        listElement.innerHTML = "";

        // --- OTIMIZAÇÃO INÍCIO: Cria um fragmento de memória (caixa invisível) ---
        const fragment = document.createDocumentFragment();
        // ------------------------------------------------------------------------

        filteredTopics.forEach((topic, index) => {
          const listItem = document.createElement("li");
          listItem.className = "topic-item";
          if (topic.Seq === currentTopicSequence) {
            listItem.classList.add("active");
          }
          listItem.dataset.sequence = topic.Seq;

          // Ícones de status
          const estudoStatus = topic['Status Estudo'] === 'Concluído';
          const revisaoStatus = topic['Revisao Count'] > 0;
          const revisaoCount = topic['Revisao Count'] || 0;
          const questoesStatus = topic['Status Questões'] === 'Concluído';
          const flashcardsStatus = topic['Status Flashcards'] === 'Concluído';

          // 1. Formatador de Data com Ano (DD/MM/AA)
          const fmtData = (dt) => {
            if (!dt) return '—';
            const parts = dt.split('-'); // YYYY-MM-DD
            if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0].slice(2)}`;
            return '—';
          };

          // 2. Lógica SRS Corrigida (Baseada na Última Ação)
          let dataProxRevisao = '—';
          let corProxRevisao = '#aaa';

          if (topic['Data Estudo']) {
            const intervalosSRS = {
              'Fácil': [2, 6, 14, 30, 60],
              'Médio': [1, 3, 7, 15, 30],
              'Difícil': [1, 2, 4, 8, 15]
            };

            const nivel = topic['Dificuldade'] || 'Fácil'; // MUDANÇA: Default Fácil
            const count = parseInt(topic['Revisao Count'] || 0);
            const serie = intervalosSRS[nivel] || intervalosSRS['Fácil']; // MUDANÇA: Default Fácil

            if (count < serie.length) {
              const baseDateStr = (count > 0 && topic['Data Revisão']) ? topic['Data Revisão'] : topic['Data Estudo'];
              const diasParaAdicionar = serie[count];
              const dataBase = new Date(baseDateStr + 'T12:00:00');
              dataBase.setDate(dataBase.getDate() + diasParaAdicionar);

              const d = String(dataBase.getDate()).padStart(2, '0');
              const m = String(dataBase.getMonth() + 1).padStart(2, '0');
              const a = String(dataBase.getFullYear()).slice(2);
              dataProxRevisao = `${d}/${m}/${a}`;

              const hoje = new Date();
              hoje.setHours(0, 0, 0, 0);
              dataBase.setHours(0, 0, 0, 0);

              if (hoje > dataBase) corProxRevisao = '#ff5555';
              else if (hoje.getTime() === dataBase.getTime()) corProxRevisao = '#F7EF8A';
              else corProxRevisao = '#4CAF50';
            } else {
              // --- MODO INFINITO (HÍBRIDO) ---
              // Se acabou a lista fixa, usa multiplicador exponencial
              const ultimoIntervaloFixo = serie[serie.length - 1];
              const reviewsExtras = count - serie.length + 1;
              const multiplicador = 2.0;

              // Calcula novo intervalo: ÚltimoFix * (2 ^ Extras)
              // Exemplo (Fácil, base 60): 60->120->240->480...
              const diasParaAdicionar = Math.floor(ultimoIntervaloFixo * Math.pow(multiplicador, reviewsExtras));

              const baseDateStr = topic['Data Revisão'] || topic['Data Estudo'];
              const dataBase = new Date(baseDateStr + 'T12:00:00');
              dataBase.setDate(dataBase.getDate() + diasParaAdicionar);

              const d = String(dataBase.getDate()).padStart(2, '0');
              const m = String(dataBase.getMonth() + 1).padStart(2, '0');
              const a = String(dataBase.getFullYear()).slice(2);
              dataProxRevisao = `${d}/${m}/${a}`;

              const hoje = new Date();
              hoje.setHours(0, 0, 0, 0);
              dataBase.setHours(0, 0, 0, 0);

              if (hoje > dataBase) corProxRevisao = '#ff5555';
              else if (hoje.getTime() === dataBase.getTime()) corProxRevisao = '#F7EF8A';
              else corProxRevisao = '#4CAF50';

              // Indicador visual de Modo Infinito (∞)
              dataProxRevisao += ' ∞';
            }
          }

          // 3. HTML Layout Tabular
          let diffClass = '';
          let diffIcon = '<i class="fas fa-minus" style="font-size: 0.6rem;"></i>';
          const nivelDiff = topic['Dificuldade'];

          if (nivelDiff === 'Fácil') {
            diffClass = 'diff-facil';
            diffIcon = '<i class="fas fa-smile"></i>';
          } else if (nivelDiff === 'Médio') {
            diffClass = 'diff-medio';
            diffIcon = '<i class="fas fa-meh"></i>';
          } else if (nivelDiff === 'Difícil') {
            diffClass = 'diff-dificil';
            diffIcon = '<i class="fas fa-dizzy"></i>';
          }

          const topicContent = `     
            <div class="topic-content">
              <div class="topic-discipline">${topic.Disciplinas ? topic.Disciplinas : "Sem disciplina"}</div>
              <div class="topic-title">
                ${topic.Seq} - ${topic.Tópicos || "Sem título"}
              </div>
              ${topic.Subtópicos && topic.Subtópicos !== '—' ? `<div class="topic-subtopic">${topic.Subtópicos}</div>` : ''}
            </div>
            
            <div class="topic-right-panel">

              <div class="topic-metrics" style="display: flex; gap: 8px; font-size: 0.85rem; color: #ddd; align-items: center;">
                 ${topic['N. de Páginas'] ? `<span title="Páginas"><i class="fas fa-book-open" style="margin-right:4px;"></i>${topic['N. de Páginas']}</span>` : ''}
                 ${topic['N. de Cards'] ? `<span title="Flashcards"><i class="fas fa-layer-group" style="margin-right:4px;"></i>${topic['N. de Cards']}</span>` : ''}
              </div>
              
              <div class="topic-dates-wrapper" style="display: flex; gap: 12px;">
                  <div style="display: flex; flex-direction: column; align-items: center;">
                      <span style="font-size: 0.6rem; color: #aaa; text-transform: uppercase;">Est</span>
                      <span id="date-est-index-${index}" style="font-size: 0.75rem; color: #fff;">${fmtData(topic['Data Estudo'])}</span>
                  </div>
                  <div style="display: flex; flex-direction: column; align-items: center;">
                      <span style="font-size: 0.6rem; color: #aaa; text-transform: uppercase;">Rev</span>
                      <span id="date-rev-index-${index}" style="font-size: 0.75rem; color: #fff;">${fmtData(topic['Data Revisão'])}</span>
                  </div>
                  <div style="display: flex; flex-direction: column; align-items: center;">
                      <span style="font-size: 0.6rem; color: #aaa; text-transform: uppercase;">Prox</span>
                      <span id="date-prox-index-${index}" style="font-size: 0.75rem; font-weight: bold; color: ${corProxRevisao};">${dataProxRevisao}</span>
                  </div>
              </div>

              <div class="topic-checkbox-group">
                <div style="display: flex; gap: 8px; font-size: 0.7rem; color: #FFF; font-weight: bold; margin-bottom: 2px; justify-content: center; width: 100%;">
                  <span style="width: 22px; text-align: center;" title="Estudo">E</span>
                  <span style="width: 28px; text-align: center;" title="Revisões">R</span>
                  <span style="width: 22px; text-align: center;" title="Questões">Q</span>
                  <span style="width: 22px; text-align: center;" title="Flashcards">F</span>
                  <span style="width: 22px; text-align: center;" title="Dificuldade SRS">D</span>
                </div>

                <div class="quick-controls" onclick="event.stopPropagation()" style="display: flex; gap: 8px; justify-content: center;">
                  <div class="quick-checkbox ${estudoStatus ? 'checked-estudo' : ''}" 
                       onclick="quickToggleEstudo('${topic.Seq}', ${index}, this)">${estudoStatus ? '✓' : ''}</div>
                  
                  <div class="quick-revisao-counter ${revisaoStatus ? 'has-revisoes' : ''}" 
                       onclick="openRevisaoPopup(event, '${topic.Seq}', ${index}, ${revisaoCount})">${revisaoCount}</div>
                  
                  <div class="quick-checkbox ${questoesStatus ? 'checked-questoes' : ''}" 
                       onclick="quickToggleQuestoes('${topic.Seq}', this)">${questoesStatus ? '✓' : ''}</div>
                  
                  <div class="quick-checkbox ${flashcardsStatus ? 'checked-flashcards' : ''}" 
                       onclick="quickToggleFlashcards('${topic.Seq}', this)">${flashcardsStatus ? '✓' : ''}</div>

                  <div class="quick-difficulty-btn ${diffClass}" 
                       onclick="quickCycleDifficulty(event, '${topic.Seq}', '${nivelDiff || ''}', this)"
                       title="Dificuldade: ${nivelDiff || 'Definir Dificuldade'}">
                       ${diffIcon}
                  </div>
                </div>
              </div>

              <i class="fas fa-pencil-alt edit-icon" title="Editar tópico"></i>
            </div>
          `;

          listItem.innerHTML = topicContent;

          // Event Listeners
          listItem.addEventListener("click", (e) => {
            if (!e.target.classList.contains('edit-icon') && !e.target.closest('.edit-icon')) {
              showTopicDetails(topic.Seq);
            }
          });

          const editIcon = listItem.querySelector('.edit-icon');
          editIcon.addEventListener("click", (e) => {
            e.stopPropagation();
            showTopicDetails(topic.Seq);
            setTimeout(() => {
              if (!isEditMode) {
                toggleEditMode();
              }
            }, 100);
          });

          // --- OTIMIZAÇÃO MEIO: Adiciona na caixa invisível em vez da tela ---
          fragment.appendChild(listItem);
          // -------------------------------------------------------------------
        });

        // --- OTIMIZAÇÃO FIM: Joga tudo na tela de uma única vez ---
        listElement.appendChild(fragment);
        // ----------------------------------------------------------

        updateTopicCounter();
        showSection("topics-list-container");
      }
    }

    function showTopicDetails(sequence) {
      const topic = allTopics.find(t => t.Seq == sequence);
      if (!topic) return;
      currentTopicSequence = topic.Seq;
      if (document.getElementById("topic-detail-title")) {
        let titleHtml = `<i class="fas fa-book"></i> ${topic.Disciplinas || "Sem disciplina"} - ${topic.Seq}`;
        if (topic.Subtópicos && topic.Subtópicos !== '—') {
          titleHtml += `<br><i class="fas fa-level-down-alt"></i> ${topic.Subtópicos}`;
        }
        document.getElementById("topic-detail-title").innerHTML = titleHtml;
      }
      if (document.getElementById("topic-detail-discipline")) {
        document.getElementById("topic-detail-discipline").textContent = topic.Tópicos || "Sem título";
      }
      document.getElementById('info-disc').textContent = topic.Disciplinas || '';
      document.getElementById('info-seq').textContent = topic.Seq || '';
      document.getElementById('info-topico').textContent = topic.Tópicos || '';
      document.getElementById('info-subtopico').textContent = topic.Subtópicos || '';
      updateStatusCheckboxes(topic);
      document.querySelectorAll(".topic-item").forEach(item => {
        item.classList.remove("active");
        if (item.dataset.sequence == topic.Seq) {
          item.classList.add("active");
        }
      });
      // NOVO CÓDIGO - Adicionado para mostrar a dificuldade salva
      document.querySelectorAll('.btn-difficulty').forEach(btn => btn.classList.remove('active'));
      if (topic.Dificuldade) {
        const activeButton = document.querySelector(`.btn-difficulty[data-level="${topic.Dificuldade}"]`);
        if (activeButton) {
          activeButton.classList.add('active');
        }
      }
      // FIM DO NOVO CÓDIGO
      showSection("topic-detail-container");
    }

    function updateStatusCheckboxes(topic) {
      document.getElementById('estudo-checkbox').checked = (topic['Status Estudo'] === 'Concluído');
      document.getElementById('estudo-date').value = topic['Data Estudo'] || '';

      // ✅ NOVA LÓGICA PARA REVISÃO - SUBSTITUIÇÃO APLICADA
      const revisaoCount = topic['Revisao Count'] || 0;
      document.getElementById('revisao-count').value = revisaoCount;
      document.getElementById('revisao-date').value = topic['Data Revisão'] || '';

      document.getElementById('questoes-checkbox').checked = (topic['Status Questões'] === 'Concluído');
      document.getElementById('questoes-date').value = topic['Data Questões'] || '';
      document.getElementById('flashcards-checkbox').checked = (topic['Status Flashcards'] === 'Concluído');
      document.getElementById('flashcards-date').value = topic['Data Flashcards'] || '';
    }
    // --- INÍCIO DA NOVA FUNÇÃO DE LÓGICA SRS ---
    function getTopicsForSrsReview(deadline) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let dueTopics = [];

      allTopics.forEach(topic => {
        if (!topic['Data Estudo']) {
          return;
        }

        const studyDate = new Date(topic['Data Estudo']);
        studyDate.setHours(0, 0, 0, 0);
        const reviewCount = parseInt(topic['Revisao Count'] || 0);
        const difficulty = topic['Dificuldade'] || 'Médio';

        const intervals = {
          'Fácil': [2, 6, 14, 30, 60],
          'Médio': [1, 3, 7, 15, 30],
          'Difícil': [1, 2, 4, 8, 15]
        };

        if (reviewCount < idealIntervals.length) {
          intervalDays = idealIntervals[reviewCount];
        } else {
          // --- MODO INFINITO ---
          const ultimoIntervaloFixo = idealIntervals[idealIntervals.length - 1];
          const reviewsExtras = reviewCount - idealIntervals.length + 1;
          const multiplicador = 2.0;
          intervalDays = Math.floor(ultimoIntervaloFixo * Math.pow(multiplicador, reviewsExtras));
        }

        let idealDueDate = new Date(studyDate);
        // Se houve revisões, baseia na última revisão
        if (reviewCount > 0 && topic['Data Revisão']) {
          const revDate = new Date(topic['Data Revisão']);
          revDate.setHours(0, 0, 0, 0);
          idealDueDate = revDate;
        }
        idealDueDate.setDate(idealDueDate.getDate() + intervalDays);

        let finalDueDate = idealDueDate;

        // Lógica de adaptação ao prazo
        if (deadline && idealDueDate > deadline) {
          const remainingReviews = idealIntervals.length - reviewCount;
          const daysUntilDeadline = (deadline - today) / (1000 * 60 * 60 * 24);

          if (daysUntilDeadline <= 0 || remainingReviews <= 0) {
            finalDueDate = today;
          } else {
            const compressedInterval = Math.max(1, Math.floor(daysUntilDeadline / remainingReviews));
            const compressedDueDate = new Date(today);
            compressedDueDate.setDate(today.getDate() + compressedInterval);
            finalDueDate = compressedDueDate > deadline ? deadline : compressedDueDate;
          }
        }

        if (today >= finalDueDate) {
          // Adiciona a data de vencimento ao objeto do tópico para poder ordenar
          topic.dueDate = finalDueDate;
          dueTopics.push(topic);
        }
      });

      console.log(`SRS Adaptativo: Encontrados ${dueTopics.length} tópicos para revisar hoje.`);
      // Ordena por data de vencimento, os mais atrasados primeiro
      dueTopics.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
      return dueTopics;
    }
    // --- FIM DA NOVA FUNÇÃO DE LÓGICA SRS ---

    async function quickTopicLapse(sequence) {
      const topic = allTopics.find(t => t.Seq == sequence);
      if (!topic) return;

      // 1. Lógica Híbrida de Penalidade
      let currentCount = parseInt(topic['Revisao Count']) || 0;

      // Se estiver zerado, não faz sentido "esquecer" (já está no início)
      if (currentCount === 0 && topic['Status Estudo'] !== 'Concluído') return;

      // Penalidade: Recua 2 casas (Mínimo 1 se já estudou)
      let newCount = Math.max(1, currentCount - 2);

      // Se nunca revisou (count 0) mas estudou, mantém em 1 para forçar primeira revisão
      if (currentCount === 0) newCount = 0; // Mantém 0 pois vai agendar 'hoje' como revisão pendente

      // 2. Prepara atualização
      const hoje = new Date().toISOString().split('T')[0];

      // Atualização Otimista Local
      topic['Revisao Count'] = newCount;
      topic['Dificuldade'] = 'Difícil'; // Força Dificuldade
      // Não muda a data da última revisão, pois a penalidade é no contador.
      // Mas precisamos garantir que ele apareça como "Atrasado" agora.
      // Estratégia: Não mudamos a data da última revisão, apenas o contador reduzido
      // fará com que o próximo intervalo seja menor (ou negativo em relação a hoje).

      // POREM, o usuário quer que agende para HOJE/AMANHÃ.
      // Se reduzirmos o contador, o sistema vai calcular: DataUltima + Intervalo(NovoCount).
      // Se DataUltima foi há 30 dias e NovoIntervalo é 2 dias, vai dar "Vencido há 28 dias".
      // Isso joga para o topo da lista. É o comportamento desejado.

      displayTopicsList(); // Atualiza tela
      showNotification(`Tópico marcado como 'Esqueci'. Recuado para nível ${newCount}.`, 'warning');

      // 3. Sincroniza (Background)
      const payload = {
        action: 'updateTopicStatus',
        user: currentUserName,
        sequence: sequence,
        revisaoCount: newCount,
        // Força atualização da dificuldade também? Precisamos de uma action multi-update ou chamar duas vezes.
        // O endpoint 'updateTopicStatus' atualiza colunas específicas.
        // Vamos usar o updateTopicStatus para o count e data, e talvez precise de outro para dificuldade se não tiver lá.
      };

      // O endpoint updateTopicStatus suporta colunas extras dinamicamente se a planilha tiver?
      // O script Apps Script diz:
      // if (p.revisaoCount !== undefined) set('Revisao Count', p.revisaoCount);
      // Não tem 'Dificuldade' no updateTopicStatus. Tem no 'updateTopicDifficulty'.

      // Solução: Fila Offline gerencia isso. Vamos enfileirar 2 ações.

      SyncManager.enqueue('updateTopicStatus', payload, null);
      SyncManager.enqueue('updateDifficulty', {
        action: 'updateDifficulty',
        user: currentUserName,
        sequence: sequence,
        difficulty: 'Difícil'
      }, null); // Sem msg para o segundo
    }


    function filterTopics() {
      // Lê de qualquer versão (desktop ou mobile) que tenha valor
      const searchDesktop = document.getElementById("searchInput");
      const searchMobile = document.getElementById("searchInputMobile");
      const searchTerm = (searchDesktop && searchDesktop.value ? searchDesktop.value : (searchMobile ? searchMobile.value : '')).toLowerCase();

      const discDesktop = document.getElementById("disciplineFilter");
      const discMobile = document.getElementById("disciplineFilterMobile");
      const disciplineFilter = discDesktop ? discDesktop.value : (discMobile ? discMobile.value : '');

      const statusDesktop = document.getElementById("statusFilter");
      const statusMobile = document.getElementById("statusFilterMobile");
      const statusFilter = statusDesktop ? statusDesktop.value : (statusMobile ? statusMobile.value : '');

      filteredTopics = allTopics.filter(topic => {
        // 1. Filtro de Texto
        const matchesSearch =
          (topic.Tópicos && topic.Tópicos.toLowerCase().includes(searchTerm)) ||
          (topic.Disciplinas && topic.Disciplinas.toLowerCase().includes(searchTerm)) ||
          (topic.Subtópicos && topic.Subtópicos.toLowerCase().includes(searchTerm));

        // 2. Filtro de Disciplina
        const matchesDiscipline = disciplineFilter === "" || topic.Disciplinas === disciplineFilter;

        // 3. Novo Filtro de Status
        let matchesStatus = true;
        if (statusFilter === "estudado") {
          matchesStatus = topic['Status Estudo'] === 'Concluído';
        } else if (statusFilter === "nao_estudado") {
          matchesStatus = topic['Status Estudo'] !== 'Concluído';
        } else if (statusFilter === "revisado") {
          matchesStatus = (parseInt(topic['Revisao Count']) || 0) > 0;
        } else if (statusFilter === "nao_revisado") {
          matchesStatus = (parseInt(topic['Revisao Count']) || 0) === 0;
        } else if (statusFilter === "questoes") {
          matchesStatus = topic['Status Questões'] === 'Concluído';
        } else if (statusFilter === "nao_questoes") {
          matchesStatus = topic['Status Questões'] !== 'Concluído';
        } else if (statusFilter === "flashcards") {
          matchesStatus = topic['Status Flashcards'] === 'Concluído';
        } else if (statusFilter === "nao_flashcards") {
          matchesStatus = topic['Status Flashcards'] !== 'Concluído';
        }

        return matchesSearch && matchesDiscipline && matchesStatus;
      });
      displayTopicsList();
    }
    // --- FUNÇÃO DE BUSCA (MODAL) ---
    function toggleSearch() {
      const wrapper = document.getElementById('expandableSearch');
      const input = document.getElementById('searchInput');

      // Alterna a classe 'active' (CSS faz o resto)
      wrapper.classList.toggle('active');

      // Se abriu, foca no campo
      if (wrapper.classList.contains('active')) {
        setTimeout(() => input.focus(), 100); // Pequeno delay para garantir renderização
      }
    }

    // --- FUNÇÕES DE SINCRONIZAÇÃO MOBILE/DESKTOP ---
    function toggleSearchMobile() {
      const wrapper = document.getElementById('expandableSearchMobile');
      const input = document.getElementById('searchInputMobile');
      wrapper.classList.toggle('active');
      if (wrapper.classList.contains('active')) {
        setTimeout(() => input.focus(), 100);
      }
    }

    function syncDisciplineFilter(source) {
      const desktop = document.getElementById('disciplineFilter');
      const mobile = document.getElementById('disciplineFilterMobile');
      if (source === mobile && desktop) desktop.value = source.value;
      if (source === desktop && mobile) mobile.value = source.value;
    }

    function syncSearchInput(source) {
      const desktop = document.getElementById('searchInput');
      const mobile = document.getElementById('searchInputMobile');
      if (source === mobile && desktop) desktop.value = source.value;
      if (source === desktop && mobile) mobile.value = source.value;
    }

    function syncStatusFilter(source) {
      const desktop = document.getElementById('statusFilter');
      const mobile = document.getElementById('statusFilterMobile');
      if (source === mobile && desktop) desktop.value = source.value;
      if (source === desktop && mobile) mobile.value = source.value;
    }

    // Fecha o modal se clicar fora (Opcional, mas recomendado para UX)
    document.addEventListener('click', function (event) {
      const wrapper = document.getElementById('expandableSearch');
      if (wrapper && wrapper.classList.contains('active') && !wrapper.contains(event.target)) {
        wrapper.classList.remove('active');
      }
      const wrapperMobile = document.getElementById('expandableSearchMobile');
      if (wrapperMobile && wrapperMobile.classList.contains('active') && !wrapperMobile.contains(event.target)) {
        wrapperMobile.classList.remove('active');
      }
    });
    function updateCheckboxStatus(type) {
      const checkbox = document.getElementById(`${type}-checkbox`);
      const dateInput = document.getElementById(`${type}-date`);

      if (checkbox.checked && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }
    }

    function updateRevisaoStatus() {
      const countInput = document.getElementById('revisao-count');
      const dateInput = document.getElementById('revisao-date');
      const count = parseInt(countInput.value) || 0;

      if (count > 0 && !dateInput.value) {
        // Se está adicionando revisões e não tem data, preenche com hoje
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      } else if (count === 0) {
        // Se zerou as revisões, limpa a data
        dateInput.value = '';
      }
    }

    function closeOverviewModal() {
      document.getElementById('overviewModal').style.display = 'none';
    }

    function closeDadosModal() {
      document.getElementById('dadosModal').style.display = 'none';
    }

    // --- NOVAS FUNÇÕES COM LOADING ---
    async function showProgressOverviewWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(1)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300)); // Simula um pequeno delay
        showProgressOverview();
      } finally {
        setButtonLoading(button, false);
      }
    }

    async function showIndividualProgressOverviewWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(2)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300));
        showIndividualProgressOverview();
      } finally {
        setButtonLoading(button, false);
      }
    }

    async function showRaioXOverviewWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(4)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300));
        showRaioXOverview();
      } finally {
        setButtonLoading(button, false);
      }
    }

    // --- NOVA FUNÇÃO PARA BOTÃO DADOS ---
    async function showDadosOverviewWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(5)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300));
        showDadosOverview();
      } finally {
        setButtonLoading(button, false);
      }
    }
    // --- FUNÇÃO COM LOADING PARA ESTATÍSTICAS ---
    async function showEstatisticasMetasWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(6)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300));
        showEstatisticasMetas();
      } finally {
        setButtonLoading(button, false);
      }
    }

    // --- FECHAR MODAL DE ESTATÍSTICAS ---
    function closeEstatisticasModal() {
      document.getElementById('estatisticasModal').style.display = 'none';
    }

    // --- EXIBIR ESTATÍSTICAS DAS METAS ---
    function showEstatisticasMetas() {
      if (!globalMetas || !currentUserGoals || allTopics.length === 0) {
        showNotification('Dados insuficientes para gerar estatísticas.', 'error');
        return;
      }

      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const dataConclusaoStr = currentUserGoals['Meta Data Conclusão'];
      const dataConclusao = dataConclusaoStr ? new Date(dataConclusaoStr) : null;
      if (dataConclusao) dataConclusao.setHours(0, 0, 0, 0);

      // === DADOS BÁSICOS ===
      const totalTopics = allTopics.length;
      const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
      const topicsRevisados = allTopics.filter(t => t['Revisao Count'] > 0).length;
      const topicsQuestoes = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;

      // === DATAS DE ATIVIDADE ===
      const dataEstudoArray = allTopics
        .filter(t => t['Data Estudo'])
        .map(t => new Date(t['Data Estudo']));
      const dataRevisaoArray = allTopics
        .filter(t => t['Data Revisão'])
        .map(t => new Date(t['Data Revisão']));
      const dataQuestoesArray = allTopics
        .filter(t => t['Data Questões'])
        .map(t => new Date(t['Data Questões']));

      // Primeira e última data
      const primeiraData = dataEstudoArray.length > 0
        ? new Date(Math.min(...dataEstudoArray.map(d => d.getTime())))
        : hoje;
      const ultimaData = dataEstudoArray.length > 0
        ? new Date(Math.max(...dataEstudoArray.map(d => d.getTime())))
        : hoje;

      const diasTotais = Math.max(1, Math.ceil((ultimaData - primeiraData) / (1000 * 60 * 60 * 24)) + 1);
      const mediaEstudos = dataEstudoArray.length > 0 ? (dataEstudoArray.length / diasTotais).toFixed(1) : '—';
      const mediaRevisoes = dataRevisaoArray.length > 0 ? (dataRevisaoArray.length / diasTotais).toFixed(1) : '—';
      const mediaQuestoes = dataQuestoesArray.length > 0 ? (dataQuestoesArray.length / diasTotais).toFixed(1) : '—';

      // Últimos 7 dias
      const seteDiasAtras = new Date();
      seteDiasAtras.setDate(hoje.getDate() - 7);
      const estudadosSemana = dataEstudoArray.filter(d => d >= seteDiasAtras).length;
      const estudadosMes = dataEstudoArray.filter(d =>
        d.getFullYear() === hoje.getFullYear() &&
        d.getMonth() === hoje.getMonth()
      ).length;

      // Progresso Geral (Tópicos + Revisões)
      const progressoGeral = totalTopics > 0
        ? (((topicsEstudados + topicsRevisados) / (totalTopics * 2)) * 100).toFixed(1)
        : '0.0';

      // === PROJEÇÕES REALISTAS ===
      let diasRestantes = '—';
      let ritmoNecessarioTopicos = '—';
      let ritmoNecessarioRevisoes = '—';
      let statusMetaTopicos = '—';
      let statusMetaRevisoes = '—';

      if (dataConclusao) {
        const diffTime = dataConclusao - hoje;
        diasRestantes = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
        if (diasRestantes > 0) {
          const topicosRestantes = totalTopics - topicsEstudados;
          const revisoesRestantes = totalTopics - topicsRevisados;
          ritmoNecessarioTopicos = (topicosRestantes / diasRestantes).toFixed(1);
          ritmoNecessarioRevisoes = (revisoesRestantes / diasRestantes).toFixed(1);
          statusMetaTopicos = parseFloat(ritmoNecessarioTopicos) > (currentUserGoals['Meta Diária Tópicos'] || 0)
            ? 'PRECISA ACELERAR' : 'NO RITMO';
          statusMetaRevisoes = parseFloat(ritmoNecessarioRevisoes) > (currentUserGoals['Meta Diária Tópicos'] || 0)
            ? 'PRECISA ACELERAR' : 'NO RITMO';
        }
      }

      // === COMPARATIVO HOJE ===
      const hojeStr = hoje.toISOString().split('T')[0];
      const topicosHoje = allTopics.filter(t => t['Data Estudo'] === hojeStr).length;
      const revisoesHoje = allTopics.filter(t => t['Data Revisão'] === hojeStr).length;
      const questoesHoje = allTopics.filter(t => t['Data Questões'] === hojeStr).length;

      const metaDiariaTopicos = currentUserGoals['Meta Diária Tópicos'] || 0;
      const metaDiariaRevisoes = currentUserGoals['Meta Diária Tópicos'] || 0; // assumindo mesma meta
      const metaDiariaQuestoes = 0; // não definida
      const metaDiariaFlashcards = 0;

      // === PROGRESSO MATERIAIS HOJE ===
      const paginasHoje = 0; // não rastreado por dia
      const videosHoje = 0;
      const artigosHoje = 0;

      // === RECOMENDAÇÕES ===
      let alerta = '✅ Ótimo ritmo! Continue assim.';
      if (topicsEstudados === 0) {
        alerta = '⚠️ ALERTA: Você ainda não estudou nenhum tópico. Comece hoje!';
      } else if ((topicsEstudados / totalTopics) < 0.1) {
        alerta = '⚠️ ALERTA: Progresso muito lento. Aumente seu ritmo diário.';
      } else if ((topicsEstudados / totalTopics) > 0.9) {
        alerta = '🎉 Parabéns! Você está quase concluindo o edital. Foque nas revisões.';
      }

      // === PLANEJAMENTO SUGERIDO ===
      const disciplinas = [...new Set(allTopics.map(t => t.Disciplinas).filter(d => d))];
      const distribuicaoDisciplinas = {};
      disciplinas.forEach(disc => {
        const total = allTopics.filter(t => t.Disciplinas === disc).length;
        const restantes = total - allTopics.filter(t => t.Disciplinas === disc && t['Status Estudo'] === 'Concluído').length;
        distribuicaoDisciplinas[disc] = diasRestantes > 0 ? (restantes / diasRestantes).toFixed(1) : '0.0';
      });

      // === SELETOR DE DISCIPLINAS PARA REVISÕES ===
      let selectorHTML = `
    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
      <select id="disciplinaRevisaoSelector" onchange="atualizarBarrasRevisao()" style="padding: 6px 10px; border: 1px solid #555; border-radius: 50px; background: #222; color: #fff; font-size: 0.85rem; min-width: 180px;">
        <option value="">Selecione uma disciplina</option>
  `;
      disciplinas.forEach(disc => {
        selectorHTML += `<option value="${disc}">${disc}</option>`;
      });
      selectorHTML += `</select></div>`;

      let barrasRevisaoHTML = '<div id="barras-revisao-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div>';

      // === MONTAGEM DO CONTEÚDO COMPLETO ===
      let content = `
    <!-- 📊 ESTATÍSTICAS GERAIS -->
    <div class="overview-chart">
      <div class="chart-title">📊 ESTATÍSTICAS GERAIS</div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 10px;">
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Total de Tópicos</div>
          <div style="font-size: 1.8rem; font-weight: bold; color: #F7EF8A;">${totalTopics}</div>
        </div>
        <div style="background: rgba(76, 175, 80, 0.15); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Estudo Concluído</div>
<div style="font-size: 1.8rem; font-weight: bold; color: #4CAF50;">${Math.round((topicsEstudados / totalTopics) * 100)}%</div>
<div style="font-size: 0.9rem; color: #fff;">${topicsEstudados}/${totalTopics}</div>
        </div>
        <div style="background: rgba(255, 193, 7, 0.15); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Revisão Concluída</div>
          <div style="font-size: 1.8rem; font-weight: bold; color: #FFC107;">${Math.round((topicsRevisados / totalTopics) * 100)}%</div>
          <div style="font-size: 0.9rem; color: #fff;">${topicsRevisados}/${totalTopics}</div>
        </div>
        <div style="background: rgba(33, 150, 243, 0.15); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Questões Concluídas</div>
          <div style="font-size: 1.8rem; font-weight: bold; color: #2196F3;">${Math.round((topicsQuestoes / totalTopics) * 100)}%</div>
          <div style="font-size: 0.9rem; color: #eee;">${topicsQuestoes}/${totalTopics}</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Média de Estudos</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${mediaEstudos}</div>
          <div style="font-size: 0.8rem; color: #fff;">tópicos/dia</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Média de Revisões</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${mediaRevisoes}</div>
          <div style="font-size: 0.8rem; color: #fff;">revisões/dia</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Média de Questões</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${mediaQuestoes}</div>
          <div style="font-size: 0.8rem; color: #fff;">questões/dia</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Tópicos +2 Revisões</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${allTopics.filter(t => t['Revisao Count'] >= 2).length}</div>
          <div style="font-size: 0.8rem; color: #fff;">${totalTopics > 0 ? Math.round((allTopics.filter(t => t['Revisao Count'] >= 2).length / totalTopics) * 100) : 0}% do total</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Estudados na Semana</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${estudadosSemana}</div>
          <div style="font-size: 0.8rem; color: #fff;">últimos 7 dias</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Estudados no mês (${hoje.toLocaleString('pt-BR', { month: 'short' })})</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${estudadosMes}</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Horas estudadas na Semana</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${formatarHoras(currentUserGoals['Meta Horas Estudo'])}</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Horas estudadas no mês</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${formatarHoras(currentUserGoals['Meta Horas Estudo'])}</div>
        </div>
        <div style="background: rgba(106, 27, 154, 0.2); padding: 12px; border-radius: 8px; text-align: center; grid-column: span 2;">
          <div style="font-size: 0.9rem; color: #fff;">Progresso Geral (Tópicos + Revisões)</div>
          <div style="font-size: 1.8rem; font-weight: bold; color: #AE8625;">${progressoGeral}%</div>
        </div>
      </div>
    </div>
    <!-- 📊 COMPARAÇÃO PERÍODO -->
    <div class="overview-chart">
      <div class="chart-title">📊 COMPARAÇÃO PERÍODO</div>
      <div style="display: flex; justify-content: center; margin-bottom: 10px;">
        <select id="periodo-comparacao" onchange="atualizarComparacaoPeriodo()" style="padding: 6px 10px; border: 1px solid #555; border-radius: 50px; background: #222; color: #fff; font-size: 0.85rem; min-width: 180px;">
          <option value="semana">Esta semana</option>
          <option value="mes">Mês atual</option>
        </select>
      </div>
      <div id="comparacao-periodo-content" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;"></div>
    </div>
    <!-- 📊 COMPARATIVO META vs REALIZADO NO DIA -->
    <div class="overview-chart">
      <div class="chart-title">📊 COMPARATIVO META vs REALIZADO NO DIA</div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 10px;">
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Tópicos Estudados</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${metaDiariaTopicos}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #4CAF50;">${topicosHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Revisões</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${metaDiariaRevisoes}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #FFC107;">${revisoesHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Questões</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${metaDiariaQuestoes}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #2196F3;">${questoesHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Flashcards</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${metaDiariaFlashcards}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #9C27B0;">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 📚 PROGRESSO EM MATERIAIS (HOJE) -->
    <div class="overview-chart">
      <div class="chart-title">📚 PROGRESSO EM MATERIAIS (HOJE)</div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 10px;">
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Material Páginas</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${currentUserGoals['Meta T. Páginas'] || 0}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #42A5F5;">${paginasHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Vídeo Aulas</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${currentUserGoals['Meta T. Vídeo Aulas'] || 0}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #9C27B0;">${videosHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Artigos</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${currentUserGoals['Meta T. Artigos'] || 0}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
           <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #FF9800;">${artigosHoje}</span>
          </div>
        </div>
      </div>
    </div>

   <!-- 🎯 PROJEÇÕES REALISTAS -->
<div class="overview-chart">
  <div class="chart-title">🎯 PROJEÇÕES REALISTAS SOBRE AS MINHAS METAS</div>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-top: 10px;">
    <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; color: #fff;">
      <div style="font-weight: bold; color: #F7EF8A; margin-bottom: 6px;">Indicador</div>
      <div style="font-size: 0.95rem; line-height: 1.6;">
        <div><span style="color: #F7EF8A;">Tópicos Restantes:</span> <span style="color: #fff;">${totalTopics - topicsEstudados}</span></div>
        <div><span style="color: #F7EF8A;">Revisões Restantes:</span> <span style="color: #fff;">${totalTopics - topicsRevisados}</span></div>
        <div><span style="color: #F7EF8A;">Dias Restantes:</span> <span style="color: #fff;">${diasRestantes}</span></div>
        <div><span style="color: #F7EF8A;">Ritmo Necessário (Tópicos):</span> <span style="color: #fff;">${ritmoNecessarioTopicos} tópicos/dia</span></div>
        <div><span style="color: #F7EF8A;">Ritmo Necessário (Revisões):</span> <span style="color: #fff;">${ritmoNecessarioRevisoes} revisões/dia</span></div>
      </div>
    </div>
    <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; color: #fff;">
      <div style="font-weight: bold; color: #F7EF8A; margin-bottom: 6px;">Status da Meta</div>
      <div style="font-size: 0.95rem; line-height: 1.6;">
        <div><span style="color: #F7EF8A;">Tópicos:</span> <span style="color: ${statusMetaTopicos === 'NO RITMO' ? '#008000' : '#F44336'};">${statusMetaTopicos}</span></div>
        <div><span style="color: #F7EF8A;">Revisões:</span> <span style="color: ${statusMetaRevisoes === 'NO RITMO' ? '#008000' : '#F44336'};">${statusMetaRevisoes}</span></div>
    </div>
  </div>
</div>

    <!-- 💡 RECOMENDAÇÕES -->
    <div class="overview-chart">
      <div class="chart-title">💡 RECOMENDAÇÕES</div>
      <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #FFC107; padding: 12px; border-radius: 4px; margin-top: 10px; color: #fff;">
        <div style="font-weight: bold; margin-bottom: 6px;">${alerta}</div>
        <div>🎯 Foco Principal: Concluir tópicos pendentes</div>
        <div>📅 Próxima Meta: ${metaDiariaTopicos} tópicos hoje</div>
      </div>
    </div>

    <!-- 📅 PLANEJAMENTO SUGERIDO -->
<div class="overview-chart">
  <div class="chart-title">📅 PLANEJAMENTO SUGERIDO</div>
  <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 0.95rem; line-height: 1.6; color: #fff;">
    <div style="text-align: center; margin-top: 8px; font-weight: bold; color: #Fff100;">Metas definidas pelo aluno</div>
	<div>• <span style="color: #F7EF8A;">Meta Diária:</span> <span style="color: #fff;">${metaDiariaTopicos} tópicos</span></div>
    <div>• <span style="color: #F7EF8A;">Revisão Diária:</span> <span style="color: #fff;">${metaDiariaRevisoes} tópicos</span></div>
    <div>• <span style="color: #F7EF8A;">Questões Diárias:</span> <span style="color: #fff;">${metaDiariaQuestoes}</span></div>
    <div>• <span style="color: #F7EF8A;">Previsão de Conclusão:</span> <span style="color: #fff;">${dataConclusao ? formatarData(dataConclusao.toISOString()) : '—'}</span></div>
      <div style="text-align: center; margin-top: 8px; font-weight: bold; color: #Fff100;">Distribuição Recomendada por Disciplina:</div>
    ${Object.entries(distribuicaoDisciplinas).map(([disc, valor]) =>
        `<div>• <span style="color: #F7EF8A;">${disc}:</span> <span style="color: #fff;">${valor} tópicos/dia</span></div>`
      ).join('')}
	<div style="text-align: center; margin-top: 8px; font-weight: bold; color: #Fff100;">Distribuição Proporcional por Disciplina (baseada na quantidade de tópicos):</div>
    ${disciplinas.map(disc => {
        const totalDisc = allTopics.filter(t => t.Disciplinas === disc).length;
        const proporcao = totalTopics > 0 ? ((totalDisc / totalTopics) * 100).toFixed(1) : '0.0';
        const metaProporcional = metaDiariaTopicos > 0 ? (metaDiariaTopicos * totalDisc / totalTopics).toFixed(1) : '0.0';
        return `<div>• <span style="color: #F7EF8A;">${disc}:</span> <span style="color: #fff;">${metaProporcional} tópicos/dia (${proporcao}% do edital)</span></div>`;
      }).join('')}
  </div>
</div>

    <!-- 📚 PROGRESSO POR DISCIPLINA REVISÕES -->
    <div class="overview-chart">
      <div class="chart-title">📚 PROGRESSO POR DISCIPLINA REVISÕES</div>
      ${selectorHTML}
      ${barrasRevisaoHTML}
    </div>
  `;

      document.getElementById('estatisticas-content').innerHTML = content;
      document.getElementById('estatisticasModal').style.display = 'flex';

      // Adicionar função de atualização das barras
      window.atualizarBarrasRevisao = function () {
        const disciplina = document.getElementById('disciplinaRevisaoSelector').value;
        const container = document.getElementById('barras-revisao-container');
        if (!disciplina) {
          container.innerHTML = '';
          return;
        }
        const topicosDisciplina = allTopics.filter(t => t.Disciplinas === disciplina);
        let barras = '';
        topicosDisciplina.forEach(topico => {
          const revisoes = topico['Revisao Count'] || 0;
          const altura = Math.min(100, revisoes * 20); // até 5 revisões = 100px
          barras += `
  <div style="width: 40px; display: flex; flex-direction: column; align-items: center;" 
       title="${topico.Tópicos || 'Tópico'}${topico.Subtópicos && topico.Subtópicos !== '—' ? ' - ' + topico.Subtópicos : ''}">
    <div style="width: 100%; background: #333; border-radius: 4px; height: 100px; display: flex; align-items: flex-end; justify-content: center; position: relative;">
      <div style="width: 100%; background: #FFC107; height: ${altura}px; border-radius: 4px 4px 0 0; display: flex; align-items: flex-end; justify-content: center;">
        <span style="color: #000; font-weight: bold; font-size: 0.7rem;">${revisoes}</span>
      </div>
    </div>
    <div style="font-size: 0.7rem; color: #aaa; margin-top: 4px; text-align: center;">${topico.Seq}</div>
  </div>
`;
        });
        container.innerHTML = barras;
      };
      // Adicionar função de atualização da comparação
      window.atualizarComparacaoPeriodo = function () {
        const tipo = document.getElementById('periodo-comparacao').value;
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        let inicioAtual, fimAtual, inicioAnterior, fimAnterior, labelAtual, labelAnterior;

        if (tipo === 'semana') {
          // Esta semana (domingo a sábado)
          const domingoAtual = new Date(hoje);
          domingoAtual.setDate(hoje.getDate() - hoje.getDay());
          inicioAtual = domingoAtual;
          fimAtual = new Date(domingoAtual);
          fimAtual.setDate(domingoAtual.getDate() + 6);

          // Semana passada
          inicioAnterior = new Date(domingoAtual);
          inicioAnterior.setDate(domingoAtual.getDate() - 7);
          fimAnterior = new Date(inicioAnterior);
          fimAnterior.setDate(inicioAnterior.getDate() + 6);

          labelAtual = 'Esta semana';
          labelAnterior = 'Semana passada';
        } else {
          // Mês atual
          inicioAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
          fimAtual = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);

          // Mês passado
          inicioAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
          fimAnterior = new Date(hoje.getFullYear(), hoje.getMonth(), 0);

          labelAtual = 'Mês atual';
          labelAnterior = 'Mês passado';
        }

        // Função para contar atividades em um intervalo
        const contarAtividades = (dataArray, inicio, fim) => {
          return dataArray.filter(d => d >= inicio && d <= fim).length;
        };

        const topicosAtual = contarAtividades(dataEstudoArray, inicioAtual, fimAtual);
        const topicosAnterior = contarAtividades(dataEstudoArray, inicioAnterior, fimAnterior);
        const revisoesAtual = contarAtividades(dataRevisaoArray, inicioAtual, fimAtual);
        const revisoesAnterior = contarAtividades(dataRevisaoArray, inicioAnterior, fimAnterior);
        const questoesAtual = contarAtividades(dataQuestoesArray, inicioAtual, fimAtual);
        const questoesAnterior = contarAtividades(dataQuestoesArray, inicioAnterior, fimAnterior);

        const setaTopicos = topicosAtual > topicosAnterior ? '↑' : (topicosAtual < topicosAnterior ? '↓' : '→');
        const corTopicos = topicosAtual > topicosAnterior ? '#4CAF50' : (topicosAtual < topicosAnterior ? '#F44336' : '#FFC107');

        const setaRevisoes = revisoesAtual > revisoesAnterior ? '↑' : (revisoesAtual < revisoesAnterior ? '↓' : '→');
        const corRevisoes = revisoesAtual > revisoesAnterior ? '#4CAF50' : (revisoesAtual < revisoesAnterior ? '#F44336' : '#FFC107');

        const setaQuestoes = questoesAtual > questoesAnterior ? '↑' : (questoesAtual < questoesAnterior ? '↓' : '→');
        const corQuestoes = questoesAtual > questoesAnterior ? '#4CAF50' : (questoesAtual < questoesAnterior ? '#F44336' : '#FFC107');

        const comparacaoHTML = `
      <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Tópicos Estudados</div>
        <div style="font-size: 1.6rem; font-weight: bold; color: ${corTopicos}; margin: 8px 0;">${topicosAtual} ${setaTopicos}</div>
        <div style="font-size: 0.85rem; color: #aaa;">${labelAnterior}: ${topicosAnterior}</div>
      </div>
      <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Revisões</div>
        <div style="font-size: 1.6rem; font-weight: bold; color: ${corRevisoes}; margin: 8px 0;">${revisoesAtual} ${setaRevisoes}</div>
        <div style="font-size: 0.85rem; color: #aaa;">${labelAnterior}: ${revisoesAnterior}</div>
      </div>
      <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Questões</div>
        <div style="font-size: 1.6rem; font-weight: bold; color: ${corQuestoes}; margin: 8px 0;">${questoesAtual} ${setaQuestoes}</div>
        <div style="font-size: 0.85rem; color: #aaa;">${labelAnterior}: ${questoesAnterior}</div>
      </div>
    `;
        document.getElementById('comparacao-periodo-content').innerHTML = comparacaoHTML;
      };

      // Chamar uma vez ao abrir
      setTimeout(() => {
        if (typeof window.atualizarComparacaoPeriodo === 'function') {
          window.atualizarComparacaoPeriodo();
        }
      }, 100);
    }

    // --- NOVAS FUNÇÕES DE DADOS ---
    // --- NOVAS FUNÇÕES DE DADOS ---
    async function loadAllData(showOverview = false, silent = false) {
      try {
        // 1. Memoriza a rolagem do CONTAINER EXTERNO (onde a barra de rolagem realmente fica)
        const listContainer = document.getElementById("topics-list-container");
        const savedScroll = listContainer ? listContainer.scrollTop : 0;

        if (!silent) {
          showSection("loading-message");
        }

        await loadTopics(); // Carrega dados e aplica filtros

        showSection("topics-list-container");

        // (Removidos comandos redundantes que resetavam a lista aqui)

        // 2. Restaura a rolagem para o ponto exato
        if (listContainer) {
          listContainer.scrollTop = savedScroll;
        }

        if (showOverview) {
          showProgressOverview();
        }
      } catch (error) {
        console.error("Erro ao carregar todos os dados:", error);
        showNotification(`Falha ao carregar dados: ${error.message}`, 'error');
      }
    }

    // ============================================================================
    // O VIGIA: SISTEMA DE CACHE INTELIGENTE (Migrado do V84)
    // ============================================================================

    /**
     * Processa os dados recebidos (tanto do cache quanto do download) e atualiza a interface.
     */
    function processLoadedData(data) {
      // Adaptação para diferentes formatos de resposta
      const d = data.data || data;

      if (!d.topics || !Array.isArray(d.topics)) {
        throw new Error('Formato de dados inválido: lista de tópicos não encontrada.');
      }

      allTopics = d.topics;
      currentUserGoals = d.userGoals || {};

      if (d.globalGoals) {
        globalMetas = d.globalGoals;
      }
      if (d.disciplineConfig) {
        disciplineConfig = d.disciplineConfig;
      }

      populateDisciplineFilter();
      filterTopics();
      updateTopicCounter();

      // Pré-carregamento silencioso da agenda (3s após dados principais)
      setTimeout(() => {
        if (!window.agendaDataLoaded) {
          loadAgendaData().then(() => {
            window.agendaDataLoaded = true;
          }).catch(e => { });
        }
      }, 3000);
    }

    /**
     * loadTopics() — Sistema O VIGIA (4 Etapas)
     * Etapa 1: Pergunta ao servidor qual a versão atual (timeout 3s)
     * Etapa 2: Compara versão servidor vs versão local
     * Etapa 3: Se igual → usa cache local (instantâneo)
     * Etapa 4: Se diferente → baixa do servidor (timeout 15s) com fallback
     */
    async function loadTopics() {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }

      const cacheKey = `cachedTopics_${SHEET_ID}`;
      const versionKey = `topicsVersion_${SHEET_ID}`;
      const localData = localStorage.getItem(cacheKey);
      const localVersion = localStorage.getItem(versionKey);
      let serverVersion = null;
      let shouldUseCache = false;

      // =====================================================================
      // ETAPA 1: O VIGIA (Pergunta ao servidor qual a versão atual)
      // =====================================================================
      try {
        if (navigator.onLine) {
          const versionPayload = JSON.stringify({ action: 'checkVersion' });
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 segundos

          const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            body: versionPayload,
            signal: controller.signal
          });
          clearTimeout(timeoutId);

          if (response.ok) {
            const json = await response.json();
            if (json.status === 'success') {
              serverVersion = json.version;
              console.log(`📡 Vigia | Versão Servidor: ${serverVersion} | Versão Local: ${localVersion || 'nenhuma'}`);
            }
          }
        }
      } catch (e) {
        console.warn('⚠️ O Vigia não conseguiu contatar o servidor (Offline ou timeout).', e.name);
        // Se estiver offline mas tiver cache, usa o cache
        if (localData) shouldUseCache = true;
      }

      // =====================================================================
      // ETAPA 2: DECISÃO (Comparar versões)
      // =====================================================================
      if (serverVersion && localVersion && serverVersion === localVersion && localData) {
        shouldUseCache = true;
        console.log('✅ Vigia | Versões iguais → Usando cache local (instantâneo)');
      } else if (serverVersion) {
        console.log('🔄 Vigia | Versões diferentes → Baixando dados atualizados...');
      }

      // =====================================================================
      // ETAPA 3: CACHE LOCAL (Caminho rápido — instantâneo)
      // =====================================================================
      if (shouldUseCache) {
        try {
          const cachedData = JSON.parse(localData);
          processLoadedData(cachedData);
          console.log(`⚡ Vigia | ${allTopics.length} tópicos carregados do cache local`);
          return; // Sai aqui — sem ir ao servidor
        } catch (parseError) {
          console.warn('⚠️ Cache corrompido, baixando do servidor...', parseError);
          // Cache corrompido? Limpa e continua para o download
          localStorage.removeItem(cacheKey);
          localStorage.removeItem(versionKey);
        }
      }

      // =====================================================================
      // ETAPA 4: DOWNLOAD DO SERVIDOR (Caminho completo — com timeout e fallback)
      // =====================================================================
      try {
        const payload = JSON.stringify({
          action: 'getUserData',
          user: currentUserName,
          spreadsheetId: SHEET_ID
        });

        // Timeout de 15s para download de dados
        const downloadController = new AbortController();
        const downloadTimeout = setTimeout(() => downloadController.abort(), 15000);

        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: payload,
          signal: downloadController.signal
        });
        clearTimeout(downloadTimeout);

        if (!response.ok) throw new Error(`Erro ${response.status}`);
        const result = await response.json();

        if (result.error) {
          throw new Error(result.error || 'Erro desconhecido do servidor');
        }

        // Processa e exibe os dados
        processLoadedData(result);

        // 💾 Salva no cache local para próxima vez
        try {
          localStorage.setItem(cacheKey, JSON.stringify(result));
          if (serverVersion) {
            localStorage.setItem(versionKey, serverVersion);
          }
          console.log(`💾 Vigia | ${allTopics.length} tópicos baixados e salvos no cache`);
        } catch (storageError) {
          console.warn('⚠️ Não foi possível salvar no cache (localStorage cheio?)', storageError);
        }

      } catch (downloadError) {
        console.error('❌ Vigia | Falha no download:', downloadError);

        // FALLBACK: Se falhou mas tem cache antigo, usa ele com aviso
        if (localData) {
          try {
            const staleData = JSON.parse(localData);
            processLoadedData(staleData);
            showNotification(
              'Sem conexão — usando dados salvos anteriormente. Podem estar desatualizados.',
              'warning'
            );
            console.warn('⚠️ Vigia | Usando cache antigo (dados podem estar desatualizados)');
            return;
          } catch (e) {
            // Cache também corrompido, nada a fazer
          }
        }

        // Sem cache e sem download = erro fatal
        showNotification(`Erro ao carregar dados: ${downloadError.message}`, 'error');
        throw downloadError;
      }
    }

    async function loadGlobalMetas() {
      try {
        // --- CORREÇÃO: USAR POST E action 'getUserData' ---
        // Usamos getUserData pois ele já traz as metas globais no novo script
        const payload = {
          action: 'getUserData',
          user: currentUserName,
          spreadsheetId: SHEET_ID
        };

        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        // --------------------------------------------------

        if (!response.ok) throw new Error(`Erro ${response.status}`);
        const result = await response.json();

        if (result.error) {
          console.warn('Erro ao carregar métricas:', result.error);
          return;
        }

        // Adaptação: Pega globalGoals da resposta
        const data = result.data || result;
        globalMetas = data.globalGoals || {};

      } catch (error) {
        console.error("Erro ao carregar métricas globais:", error);
        // Não lançamos throw aqui para não travar o carregamento principal se falhar
      }
    }

    // --- NOVAS FUNÇÕES DE UI ---
    function openUserGoalsModal() {
      const modal = document.getElementById('userGoalsModal');
      const fields = [
        'Meta Diária Tópicos', 'Meta Horas Estudo', 'Meta Dias Estudo', 'Meta Data Conclusão',
        'Meta T. Páginas', 'Meta T. Vídeo Aulas', 'Meta T. Artigos', 'Meta T. Flashcards',
        'Total Material Páginas', 'Total Material Vídeo Aulas', 'Total Material Artigos', 'Total Material Flashcards',
        'Páginas Concluídas', 'Vídeo Aulas Concluídas', 'Artigos Concluídos', 'Flashcards Concluídos'
      ];

      fields.forEach(key => {
        const input = document.getElementById(`goal-${key}`);
        if (input) {
          const value = currentUserGoals[key];

          // CORREÇÃO ESPECÍFICA APENAS PARA O CAMPO DE DATA
          if (key === 'Meta Data Conclusão' && value) {
            // Garante que a data esteja no formato correto para o input type="date"
            const date = new Date(value);
            if (!isNaN(date.getTime())) {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              input.value = `${year}-${month}-${day}`;
            } else {
              input.value = value; // Fallback
            }
          } else {
            // Para todos os outros campos, mantém a lógica original
            if (input.type === 'date') {
              input.value = value || '';
            }
            // CORREÇÃO ESPECÍFICA PARA META HORAS ESTUDO (type="time")
            if (key === 'Meta Horas Estudo' && value) {
              if (typeof value === 'number') {
                const hours = Math.floor(value);
                const minutes = Math.round((value - hours) * 60);
                input.value = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
              } else {
                input.value = value;
              }
            } else {
              input.value = value !== undefined && value !== '' ? value : '';
            }
          }
        }
      });

      modal.style.display = 'flex';
    }

    function closeUserGoalsModal() {
      document.getElementById('userGoalsModal').style.display = 'none';
    }

    // --- FUNÇÃO SALVAR METAS OTIMIZADA ---
    async function saveUserGoals() {
      const saveBtn = document.getElementById('save-goals-btn');
      setButtonLoading(saveBtn, true);

      const fields = [
        'Meta Diária Tópicos', 'Meta Horas Estudo', 'Meta Dias Estudo', 'Meta Data Conclusão',
        'Meta T. Páginas', 'Meta T. Vídeo Aulas', 'Meta T. Artigos', 'Meta T. Flashcards',
        'Total Material Páginas', 'Total Material Vídeo Aulas', 'Total Material Artigos', 'Total Material Flashcards',
        'Páginas Concluídas', 'Vídeo Aulas Concluídas', 'Artigos Concluídos', 'Flashcards Concluídos'
      ];

      const goalsToSave = {};
      let hasError = false;

      // 1. Coleta e valida todos os dados primeiro, sem enviar nada.
      for (const key of fields) {
        const input = document.getElementById(`goal-${key}`);
        let value = input.value.trim();

        // Pular campos vazios, mas manter os preenchidos, mesmo que com '0'
        if (value === '') {
          continue;
        }

        if (input.type === 'number') {
          if (isNaN(value)) {
            showNotification(`Valor inválido para ${key}. Apenas números são permitidos.`, 'error');
            hasError = true;
            break;
          }
          value = parseFloat(value);
        }

        if (input.type === 'time' && value) {
          const [hours, minutes] = value.split(':').map(Number);
          value = hours + (minutes / 60);
        }

        goalsToSave[key] = value;
      }

      if (hasError) {
        setButtonLoading(saveBtn, false);
        return;
      }

      // 2. Se não houver nada para salvar, avisa o usuário.
      if (Object.keys(goalsToSave).length === 0) {
        setButtonLoading(saveBtn, false);
        showNotification('Nenhum campo preenchido para salvar.');
        return;
      }

      // 3. Envia todas as metas de uma só vez.
      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "updateUserGoals");
        if (SHEET_ID) params.append("spreadsheetId", SHEET_ID);
        params.append("userEmail", currentUserName);
        // A chave 'goalKey' não é mais usada, enviamos tudo em 'goalValue' como um JSON
        params.append("goalValue", JSON.stringify(goalsToSave));

        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        // Animação de sucesso
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Salvo!';
        saveBtn.style.background = 'linear-gradient(135deg, #4CAF50, #66BB6A, #2E7D32)';
        saveBtn.classList.add('pulse-animation');
        showNotification(`Metas atualizadas com sucesso!`);

        setTimeout(() => {
          closeUserGoalsModal();
          setTimeout(() => {
            saveBtn.innerHTML = 'Salvar Metas';
            saveBtn.style.background = '';
            saveBtn.classList.remove('pulse-animation');
          }, 500);
        }, 1500);

        loadAllData(); // Recarrega os dados para refletir as mudanças

      } catch (error) {
        console.error("Erro ao salvar metas:", error);
        showNotification(`Erro ao salvar: ${error.message}`, 'error');
      } finally {
        setButtonLoading(saveBtn, false);
      }
    }
    // NOVA FUNÇÃO: Para salvar um campo específico das metas do usuário
    async function saveUserGoalSpecificField(key, value) {
      if (!currentUserName) {
        console.warn('Usuário não autenticado. Não é possível salvar meta.');
        return;
      }
      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "updateUserGoals");
        if (SHEET_ID) params.append("spreadsheetId", SHEET_ID);
        params.append("userEmail", currentUserName);
        params.append("goalKey", key);
        params.append("goalValue", value);

        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }
        // Atualizar o currentUserGoals localmente após sucesso
        currentUserGoals[key] = value;
        console.log(`Meta "${key}" atualizada com sucesso para "${value}".`);

      } catch (error) {
        console.error(`Erro ao salvar meta "${key}":`, error);
        showNotification(`Erro ao sincronizar meta "${key}": ${error.message}`, 'error');
      }
    }
    // FIM NOVA FUNÇÃO

    // NOVA FUNÇÃO: Determina a meta diária de tópicos/unidades de estudo
    function getDailyStudyTarget(baseAgendaConfig, topicosDiaConfig, diasSemanaConfig) {
      let dailyTarget = 0;

      // Calcula Médias Diárias Personalizadas (se baseAgendaConfig precisar)
      let mediasPersonalizadas = {};
      if (baseAgendaConfig === 'medias-personalizadas' || baseAgendaConfig === 'medias-recomendadas') {
        mediasPersonalizadas = calcularMediasPersonalizadas(); // Função já existente no HTML
      }

      switch (baseAgendaConfig) {
        case 'meta-diaria-topicos':
          dailyTarget = topicosDiaConfig;
          break;
        case 'medias-recomendadas':
          // Do Raio X: Tópicos: (Total Temas Edital / Dias p Prova) por dia
          const diasParaProva = globalMetas['Dias_p_Prova']?.value || 0;
          const totalTemasEdital = globalMetas['Total_Temas_Edital']?.value || 0;
          if (diasParaProva > 0 && totalTemasEdital > 0) {
            dailyTarget = parseFloat((totalTemasEdital / diasParaProva).toFixed(1));
          }
          break;
        case 'medias-personalizadas':
          // Do Raio X: Tópicos restantes: (temasRestantes / diasParaProva) por dia
          dailyTarget = parseFloat(mediasPersonalizadas.mediaTemasPersonalizada || '0');
          break;
        default:
          dailyTarget = topicosDiaConfig; // Fallback para a meta do usuário
      }

      // Ajusta o dailyTarget para ser pelo menos 1, se for 0 e houver dias de estudo
      if (dailyTarget === 0 && diasSemanaConfig > 0) {
        // Se a meta for 0 mas o usuário tem dias de estudo, sugerir pelo menos 1 tópico/dia
        // Isso evita agendas vazias por erro de configuração inicial
        dailyTarget = 1;
      }

      return dailyTarget;
    }
    // FIM NOVA FUNÇÃO getDailyStudyTarget
    // NOVA FUNÇÃO: Calcula a fase de estudo geral do usuário com base no progresso de estudo dos tópicos
    function calculateStudyPhase() {
      if (!allTopics || allTopics.length === 0) {
        return '0-50'; // Assume fase inicial se não houver tópicos
      }

      const totalTopics = allTopics.length;
      const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;

      const completionPercentage = (topicsEstudados / totalTopics) * 100;

      if (completionPercentage >= 100) {
        return '100+'; // Após a conclusão total
      } else if (completionPercentage >= 75) {
        return '75-100'; // 75% revisão até 100% concluído
      } else if (completionPercentage >= 50) {
        return '50-75'; // 50% revisão até 75% concluído
      } else {
        return '0-50'; // 25% revisão até 50% concluído
      }
    }
    // FIM NOVA FUNÇÃO calculateStudyPhase
    // NOVA FUNÇÃO: Aloca o tempo diário entre novo conteúdo e revisões conforme a fase de progressão
    function allocateDailyStudyHours(totalDailyHours, studyPhase) {
      let newContentHours = 0;
      let reviewHours = 0;

      switch (studyPhase) {
        case '0-50': // 25% revisão / 75% novo
          reviewHours = totalDailyHours * 0.25;
          newContentHours = totalDailyHours * 0.75;
          break;
        case '50-75': // 50% revisão / 50% novo
          reviewHours = totalDailyHours * 0.5;
          newContentHours = totalDailyHours * 0.5;
          break;
        case '75-100': // 75% revisão / 25% novo
          reviewHours = totalDailyHours * 0.75;
          newContentHours = totalDailyHours * 0.25;
          break;
        case '100+': // 100% revisão
          reviewHours = totalDailyHours;
          newContentHours = 0;
          break;
        default: // Caso padrão (se algo der errado, assume fase inicial)
          reviewHours = totalDailyHours * 0.25;
          newContentHours = totalDailyHours * 0.75;
          break;
      }

      return {
        newContentHours: parseFloat(newContentHours.toFixed(2)),
        reviewHours: parseFloat(reviewHours.toFixed(2))
      };
    }
    // FIM NOVA FUNÇÃO allocateDailyStudyHours

    // NOVA FUNÇÃO: Prepara e prioriza os tópicos para agendamento (novos e de revisão)

    function prepareTopicsForScheduling(focoPrincipalConfig, distribuicaoConfig, allTopics, globalMetas) {
      // Separa os tópicos em "para estudar" (novo conteúdo) e "para revisar)

      // <<< AQUI ESTÁ A CORREÇÃO PRINCIPAL: A variável 'config' é declarada APENAS UMA VEZ >>>
      const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');
      const excludedDiscipline = config.excludeDisciplina || '';

      // Filtra a disciplina excluída ANTES de qualquer outra lógica
      const availableTopics = excludedDiscipline
        ? allTopics.filter(t => t.Disciplinas !== excludedDiscipline)
        : allTopics;

      let topicsToStudy = availableTopics.filter(t => t['Status Estudo'] !== 'Concluido');

      // --- INÍCIO DA LÓGICA INTEGRADA DO SRS ---
      const baseRevisaoConfig = config.baseRevisao || '1';
      let topicsToReviewOriginal = [];

      // DECIDE A FONTE DOS TÓPICOS DE REVISÃO (SRS ou LÓGICA PADRÃO)
      if (baseRevisaoConfig === 'srs') {
        // Se o modo SRS estiver ativo, usa nossa nova função inteligente
        topicsToReviewOriginal = getTopicsForSrsReview();
      } else {
        // Senão, usa a lógica padrão que já existia
        topicsToReviewOriginal = availableTopics.filter(t => t['Status Estudo'] === 'Concluído' && (parseInt(t['Revisao Count']) || 0) < 4);
      }
      // --- FIM DA LÓGICA INTEGRADA DO SRS ---

      // --- Implementação da proporção 2:1 (agora opera sobre a lista correta, seja ela do SRS ou não) ---
      const SMALL_TOPIC_PAGES_THRESHOLD = 5;
      let smallReviewTopics = topicsToReviewOriginal.filter(t => (parseInt(t['N. de Páginas']) || 0) < SMALL_TOPIC_PAGES_THRESHOLD);
      let largeReviewTopics = topicsToReviewOriginal.filter(t => (parseInt(t['N. de Páginas']) || 0) >= SMALL_TOPIC_PAGES_THRESHOLD);

      smallReviewTopics.sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq));
      largeReviewTopics.sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq));

      let topicsToReview = [];
      let smallIdx = 0;
      let largeIdx = 0;

      while (smallIdx < smallReviewTopics.length || largeIdx < largeReviewTopics.length) {
        for (let i = 0; i < 2 && smallIdx < smallReviewTopics.length; i++) {
          topicsToReview.push(smallReviewTopics[smallIdx++]);
        }
        if (largeIdx < largeReviewTopics.length) {
          topicsToReview.push(largeReviewTopics[largeIdx++]);
        }
      }
      while (smallIdx < smallReviewTopics.length) {
        topicsToReview.push(smallReviewTopics[smallIdx++]);
      }
      while (largeIdx < largeReviewTopics.length) {
        topicsToReview.push(largeReviewTopics[largeIdx++]);
      }
      // --- Fim da implementação da proporção 2:1 ---

      // Aplica a distribuição por disciplina
      function applyDisciplineDistribution(topics, distributionType) {
        const disciplines = [...new Set(topics.map(t => t.Disciplinas).filter(d => d))];
        let distributedTopics = [];

        if (distributionType === 'igual') {
          distributedTopics = [...topics].sort(() => Math.random() - 0.5);
        } else if (distributionType === 'peso') {
          const disciplineWeights = {};
          disciplines.forEach(d => {
            const cleanDiscName = d.replace(/[^a-zA-Z0-9çãáéíóúâêôõüÇÃÁÉÍÓÚÂÊÔÕÜ\s]/g, '').replace(/ /g, '_');
            disciplineWeights[d] = parseInt(globalMetas[cleanDiscName]?.value || 0);
          });

          disciplines.sort((a, b) => disciplineWeights[b] - disciplineWeights[a]);

          let disciplineQueues = {};
          disciplines.forEach(d => disciplineQueues[d] = topics.filter(t => t.Disciplinas === d).sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq)));

          let allQueuesEmpty = false;
          let currentDisciplineIndex = 0;
          while (!allQueuesEmpty) {
            allQueuesEmpty = true;
            const currentDisc = disciplines[currentDisciplineIndex];
            if (disciplineQueues[currentDisc] && disciplineQueues[currentDisc].length > 0) {
              distributedTopics.push(disciplineQueues[currentDisc].shift());
              allQueuesEmpty = false;
            }
            currentDisciplineIndex = (currentDisciplineIndex + 1) % disciplines.length;

            if (allQueuesEmpty) {
              allQueuesEmpty = Object.values(disciplineQueues).every(queue => queue.length === 0);
            }
          }
        } else {
          distributedTopics = [...topics].sort(() => Math.random() - 0.5);
        }
        return distributedTopics;
      }

      topicsToStudy = applyDisciplineDistribution(topicsToStudy, distribuicaoConfig);
      topicsToReview = applyDisciplineDistribution(topicsToReview, distribuicaoConfig);

      let finalNewTopics = [];
      let finalReviewTopics = [];

      if (focoPrincipalConfig === 'novos') {
        finalNewTopics = topicsToStudy;
        finalReviewTopics = []; // Modo Puro: Sem revisões forçadas
      } else if (focoPrincipalConfig === 'revisao') {
        finalReviewTopics = topicsToReview;
        finalNewTopics = []; // Modo Puro: Sem novos tópicos forçados
      } else if (focoPrincipalConfig === 'balanceado' || focoPrincipalConfig === 'chico-concursos') {
        finalNewTopics = topicsToStudy;
        finalReviewTopics = topicsToReview;
      } else if (focoPrincipalConfig === 'questoes') {
        finalReviewTopics = topicsToReview.filter(t => t['Status Questões'] !== 'Concluído' && t['Status Estudo'] === 'Concluído');
        finalNewTopics = topicsToStudy.filter(t => t['Status Questões'] !== 'Concluido');
        finalNewTopics.sort(() => Math.random() - 0.5);
        finalReviewTopics.sort(() => Math.random() - 0.5);
      }

      return { newTopics: finalNewTopics || [], reviewTopics: finalReviewTopics || [] };
    }

    // NOVA FUNÇÃO PARA SINCRONIZAR CHECKBOXES
    function syncPeriodCheckboxes(sourceCheckbox, targetGroup) {
      const isChecked = sourceCheckbox.checked;
      const period = sourceCheckbox.id.split('-')[2]; // manha, tarde, noite

      if (targetGroup === 'main') {
        const targetId = `periodo-${period}`;
        const targetEl = document.getElementById(targetId);
        if (targetEl) targetEl.checked = isChecked;
      } else { // targetGroup === 'config'
        const targetId = `config-periodo-${period}`;
        const targetEl = document.getElementById(targetId);
        if (targetEl) targetEl.checked = isChecked;
      }
      // Atualiza a visibilidade da grade principal
      updatePeriodoVisibility();
    }

    // NOVA FUNÇÃO: Atribui os blocos de estudo aos slots da agenda
    function assignBlocksToAgenda(newTopics, reviewTopics, availableSlots, numNewTopicsForDay, numReviewTopicsForDay) {
      const agenda = [];
      let newTopicIndex = 0;
      let reviewTopicIndex = 0;
      const SUGGESTED_DURATION_PER_TOPIC = 1;
      const today = new Date();

      const slotsByDay = {};
      availableSlots.forEach(slot => {
        if (!slotsByDay[slot.dia]) { slotsByDay[slot.dia] = []; }
        slotsByDay[slot.dia].push(slot);
      });

      const orderedDays = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];

      for (const day of orderedDays) {
        const slotsForToday = slotsByDay[day];
        if (!slotsForToday || slotsForToday.length === 0) continue;

        let slotIndex = 0;

        // Agenda os TÓPICOS NOVOS
        for (let i = 0; i < numNewTopicsForDay; i++) {
          if (newTopicIndex >= newTopics.length) break;
          const topic = newTopics[newTopicIndex++];
          const targetSlot = slotsForToday[slotIndex % slotsForToday.length];
          agenda.push({
            Data: today.toISOString().split('T')[0], DiaSemana: targetSlot.dia, Periodo: targetSlot.periodo,
            Disciplina: topic.Disciplinas, TopicosSugeridos: `${topic.Seq} - ${topic.Tópicos}`,
            Horas: SUGGESTED_DURATION_PER_TOPIC, Concluido: 'Não', Prioridade: 'Alta',
            ID_Topico: topic.Seq, ID_Disciplina: topic.Disciplinas
          });
          slotIndex++;
        }

        // Agenda as REVISÕES
        for (let i = 0; i < numReviewTopicsForDay; i++) {
          if (reviewTopicIndex >= reviewTopics.length) break;
          const topic = reviewTopics[reviewTopicIndex++];
          const targetSlot = slotsForToday[slotIndex % slotsForToday.length];
          agenda.push({
            Data: today.toISOString().split('T')[0], DiaSemana: targetSlot.dia, Periodo: targetSlot.periodo,
            Disciplina: topic.Disciplinas, TopicosSugeridos: `${topic.Seq} - ${topic.Tópicos}`,
            Horas: SUGGESTED_DURATION_PER_TOPIC, Concluido: 'Não', Prioridade: 'Média',
            ID_Topico: topic.Seq, ID_Disciplina: topic.Disciplinas
          });
          slotIndex++;
        }
      }
      return agenda;
    }
    // FIM NOVA FUNÇÃO assignBlocksToAgenda


    function calcularMediasPersonalizadas() {
      const diasParaProva = globalMetas['Dias_p_Prova']?.value || 0;

      // PROGRESSO REAL DO USUÁRIO
      const temasEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
      const totalTemas = allTopics.length;
      const temasRestantes = totalTemas - temasEstudados;

      const revisoesConcluidas = allTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
      const revisoesRestantes = totalTemas - revisoesConcluidas;

      const questoesConcluidas = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;
      const questoesRestantes = totalTemas - questoesConcluidas;

      // MATERIAIS PESSOAIS
      const paginasRestantes = (currentUserGoals['Total Material Páginas'] || 0) - (currentUserGoals['Páginas Concluídas'] || 0);
      const videosRestantes = (currentUserGoals['Total Material Vídeo Aulas'] || 0) - (currentUserGoals['Vídeo Aulas Concluídas'] || 0);
      const artigosRestantes = (currentUserGoals['Total Material Artigos'] || 0) - (currentUserGoals['Artigos Concluídos'] || 0);
      const flashcardsRestantes = (currentUserGoals['Total Material Flashcards'] || 0) - (currentUserGoals['Flashcards Concluídos'] || 0);

      // CÁLCULO DAS MÉDIAS PERSONALIZADAS
      let mediaTemasPersonalizada = diasParaProva > 0 ? (temasRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaRevisoesPersonalizada = diasParaProva > 0 ? (revisoesRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaQuestoesPersonalizada = diasParaProva > 0 ? (questoesRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaPaginasPersonalizada = diasParaProva > 0 ? (paginasRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaVideosPersonalizada = diasParaProva > 0 ? (videosRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaArtigosPersonalizada = diasParaProva > 0 ? (artigosRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaFlashcardsPersonalizada = diasParaProva > 0 ? (flashcardsRestantes / diasParaProva).toFixed(1) : 'N/A';

      return {
        mediaTemasPersonalizada,
        mediaRevisoesPersonalizada,
        mediaQuestoesPersonalizada,
        mediaPaginasPersonalizada,
        mediaVideosPersonalizada,
        mediaArtigosPersonalizada,
        mediaFlashcardsPersonalizada
      };
    }

    function showIndividualProgressOverview() {
      if (allTopics.length === 0) {
        showNotification('Nenhum dado carregado para calcular progresso', 'error');
        return;
      }
      const totalTopics = allTopics.length;
      const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
      const topicsRevisados = allTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
      const topicsQuestoes = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;

      // --- GRÁFICO 1: Progresso por Disciplina (Estudo) ---
      const disciplines = [...new Set(allTopics.map(t => t.Disciplinas).filter(d => d))];
      let disciplineBars = '';

      // Adiciona a barra geral de Estudo Concluído
      disciplineBars += `
    <div class="discipline-progress">
      <div class="discipline-name">
        <span>Estudo Concluído</span>
        <span>${topicsEstudados}/${totalTopics} (${Math.round((topicsEstudados / totalTopics) * 100)}%)</span>
      </div>
      <div class="progress-bar-container">
		<div class="progress-bar-fill" style="width: ${Math.round((topicsEstudados / totalTopics) * 100)}%; background: linear-gradient(to right, #2E7D32, #4CAF50);">${Math.round((topicsEstudados / totalTopics) * 100)}%</div>
      </div>
    </div>
  `;

      if (disciplines.length > 0) {
        disciplineBars += `<div class="chart-title" style="margin-top: 20px;">Gráfico 1: Progresso por Disciplina (Estudo)</div>`;
        disciplines.forEach(disc => {
          const discTopics = allTopics.filter(t => t.Disciplinas === disc);
          const total = discTopics.length;
          const concluidos = discTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
          const percent = total > 0 ? Math.round((concluidos / total) * 100) : 0;
          disciplineBars += `
        <div class="discipline-progress">
          <div class="discipline-name" onclick="filterByDiscipline('${disc}')">
            <span>${disc}</span>
            <span>${concluidos}/${total} (${percent}%)</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: ${percent}%; background: linear-gradient(to right, #2E7D32, #4CAF50);">${percent}%</div>
          </div>
        </div>
      `;
        });
      }

      // --- GRÁFICO 2: Revisão Geral + Revisão por Disciplina ---
      let chart2 = `
    <div class="chart-title">Gráfico 2: Revisão Geral</div>
    <div class="discipline-progress">
      <div class="discipline-name">
        <span>Revisão Concluída</span>
        <span>${topicsRevisados}/${totalTopics} (${Math.round((topicsRevisados / totalTopics) * 100)}%)</span>
      </div>
      <div class="progress-bar-container">
        <div class="revisao-bar-fill" style="width: ${Math.round((topicsRevisados / totalTopics) * 100)}%;">${Math.round((topicsRevisados / totalTopics) * 100)}%</div>
      </div>
    </div>
  `;

      if (disciplines.length > 0) {
        chart2 += `<div class="chart-title" style="margin-top: 20px;">Revisão por Disciplina</div>`;
        disciplines.forEach(disc => {
          const discTopics = allTopics.filter(t => t.Disciplinas === disc);
          const total = discTopics.length;
          const revisados = discTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
          const percent = total > 0 ? Math.round((revisados / total) * 100) : 0;
          chart2 += `
        <div class="discipline-progress">
          <div class="discipline-name" onclick="filterByDiscipline('${disc}')">
            <span>${disc}</span>
            <span>${revisados}/${total} (${percent}%)</span>
          </div>
          <div class="progress-bar-container">
            <div class="revisao-bar-fill" style="width: ${percent}%;">${percent}%</div>
          </div>
        </div>
      `;
        });
      }

      // --- MONTAR TUDO ---
      const fullContent = `
    <div class="overview-chart">
      ${disciplineBars}
    </div>
    <div class="overview-chart">
      ${chart2}
    </div>
  `;

      document.getElementById('overview-title').innerHTML = '<i class="fas fa-chart-bar"></i> MINHA VISÃO GERAL DE PROGRESSO';
      document.getElementById('overview-content').innerHTML = fullContent;
      document.getElementById('overviewModal').style.display = 'flex';
    }

    // --- NOVA FUNÇÃO PARA BOTÃO DADOS - COM CONTAINERS INDIVIDUAIS (1 COLUNA) ---
    function showDadosOverview() {
      if (Object.keys(globalMetas).length === 0) {
        showNotification('Nenhuma métrica global carregada.', 'error');
        return;
      }

      // Dados textuais (removido % Aprovação Ano Ant - CORREÇÃO 3)
      const dadosTextuais = [
        { chave: 'Matéria Mais Cobrada', valor: globalMetas['Materia_Mais_Cobradas']?.value || '—' },
        { chave: 'Tópico Crítico 1', valor: globalMetas['Topico_Crítico_1']?.value || '—' },
        { chave: 'Tópico Crítico 2', valor: globalMetas['Topico_Crítico_2']?.value || '—' }
        // % Aprovação Ano Ant foi removido (CORREÇÃO 3)
      ];

      let dadosContent = `
        <div class="overview-chart">
          <div class="chart-title">📊 Dados Textuais do Edital</div>
          <div class="dados-container">
      `;

      // Criar container individual para cada métrica (CORREÇÃO 5: 1 coluna)
      dadosTextuais.forEach(dado => {
        dadosContent += `
          <div class="dados-item">
            <div class="dados-label">${dado.chave}</div>
            <div class="dados-value">${dado.valor}</div>
          </div>
        `;
      });

      dadosContent += `
          </div>
        </div>
      `;

      document.getElementById('dados-title').innerHTML = '<i class="fas fa-database"></i> DADOS DO EDITAL';
      document.getElementById('dados-content').innerHTML = dadosContent;
      document.getElementById('dadosModal').style.display = 'flex';
    }

    function showRaioXOverview() {
      if (Object.keys(globalMetas).length === 0) {
        showNotification('Nenhuma métrica global carregada.', 'error');
        return;
      }

      // Dados do Raio X - ATUALIZADO (CORREÇÃO 3: % Aprovação Ano Ant movido para cá)
      const diasParaProva = globalMetas['Dias_p_Prova']?.value || 0;
      const totalTemas = globalMetas['Total_Temas_Edital']?.value || 0;
      const totalRevisoes = globalMetas['Total_Temas_Revisao_Edital']?.value || 0;
      const totalArtigos = globalMetas['Total_Artigos_Edital']?.value || 0;
      const totalVideos = globalMetas['Total_Video_Aulas_Edital']?.value || 0;
      const totalFlashcards = globalMetas['Total_Flashcards_Edital']?.value || 0;
      const dataProva = formatarData(globalMetas['Data_Prova']?.value);
      const percentAprovacao = globalMetas['Percent_Aprovacao_Ano_Ant']?.value || '—'; // CORREÇÃO 3: Movido para Raio X

      // MÉDIAS PERSONALIZADAS
      const mediasPersonalizadas = calcularMediasPersonalizadas();

      // Estrutura do Raio X com GRID DE 4 COLUNAS
      let raioXContent = `
          <div class="overview-chart">
              <div class="chart-title">📊 Métricas do Edital</div>
              <div class="overview-text-summary">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: center;">
      `;

      // Adicionar cada item em pares chave-valor - INCLUINDO % APROVAÇÃO (CORREÇÃO 3)
      const metricas = [
        { chave: 'Data Prova', valor: dataProva },
        { chave: 'Dias p Prova', valor: diasParaProva },
        { chave: 'Total Temas Edital', valor: totalTemas },
        { chave: 'Total Temas Revisao Edital', valor: totalRevisoes },
        { chave: 'Total Artigos Edital', valor: totalArtigos },
        { chave: 'Total Video Aulas Edital', valor: totalVideos },
        { chave: 'Total Flashcards Edital', valor: totalFlashcards || '—' },
        { chave: 'Qtd Vagas Edital', valor: globalMetas['Qtd_Vagas_Edital']?.value || '—' },
        { chave: 'Qtd Questões', valor: globalMetas['Qtd_Questões']?.value || '—' },
        { chave: '% Aprovação Ano Ant', valor: percentAprovacao } // CORREÇÃO 3: Adicionado aqui
      ];

      metricas.forEach(metrica => {
        raioXContent += `
              <div style="font-weight: bold; text-align: right; color: #FFD700;" class="${['Data Prova', 'Dias p Prova', 'Total Temas Edital'].includes(metrica.chave) ? 'bigger-font' : ''}">${metrica.chave}:</div>
              <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${metrica.valor}</div>
          `;
      });

      raioXContent += `
              </div>
          </div>
      `;

      // Médias Diárias Recomendadas (Globais) - TAMBÉM EM 4 COLUNAS
      raioXContent += `
          <div class="overview-chart raiox-medias">
              <div class="chart-title">📅 Médias Diárias Recomendadas</div>
              <div class="overview-text-summary">
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: center;">
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Tópicos:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalTemas / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Revisões:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalRevisoes / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Artigos:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalArtigos / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Vídeos:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalVideos / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Flashcards:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalFlashcards / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                  </div>
              </div>
          </div>
      `;

      // Suas Médias Diárias Personalizadas - TAMBÉM EM 4 COLUNAS
      raioXContent += `
          <div class="overview-chart raiox-personalizadas">
              <div class="chart-title">💪 Suas Médias Diárias Personalizadas</div>
              <div class="overview-text-summary">
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: center;">
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Tópicos restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaTemasPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Revisões restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaRevisoesPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Questões restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaQuestoesPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Páginas restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaPaginasPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Vídeos restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaVideosPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Artigos restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaArtigosPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Flashcards restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaFlashcardsPersonalizada} por dia</div>
                  </div>
              </div>
          </div>
          
          <div class="overview-chart">
              <div class="chart-title">Dicas para Eficácia e Eficiência</div>
              <div class="overview-text-summary dicas-content">
                  <div>🍅 <strong>CICLO POMODORO – FOCO E DISCIPLINA</strong></div>
                  <div>⏱️ 25 min → 💪 FOCO TOTAL</div>
                  <div>☕ 5 min → 😌 PAUSA CURTA</div>
                  <div>🔁 Repita 4 vezes</div>
                  <div>🌿 Após 4 ciclos → 💤 PAUSA LONGA (15–30 min)</div>
                  <div>🎯 Objetivo:</div>
                  <div>👉 Aumentar a concentração</div>
                  <div>👉 Evitar a procrastinação</div>
                  <div>👉 Reduzir o cansaço mental</div>
                  <br>
                  <div>• Revise o conteúdo no mesmo dia e depois em intervalos crescentes (1, 3, 7, 15 dias).</div>
                  <div>• Resolva questões imediatamente após estudar o tema.</div>
                  <div>• Use flashcards para memorizar conceitos-chave e jurisprudência.</div>
                  <div>• Priorize os temas mais cobrados e os críticos listados acima.</div>
              </div>
          </div>
      `;

      document.getElementById('overview-title').innerHTML = '<i class="fas fa-binoculars"></i> RAIO X DO EDITAL';
      document.getElementById('overview-content').innerHTML = raioXContent;
      document.getElementById('overviewModal').style.display = 'flex';
    }

    // --- VISÃO GERAL ORIGINAL DO V16 (ATUALIZADA) ---
    // --- VISÃO GERAL ORIGINAL DO V16 (ATUALIZADA) ---
    function showProgressOverview() {
      if (allTopics.length === 0) {
        showNotification('Nenhum dado carregado para calcular progresso', 'error');
        return;
      }
      const totalTopics = allTopics.length;
      const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
      const topicsRevisados = allTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
      const topicsQuestoes = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;

      // --- 📊 DADOS DO EDITAL ---
      const dataProva = formatarData(globalMetas['Data_Prova']?.value);
      const dadosEditalHTML = `
    <div class="overview-chart">
      <div class="chart-title">📊 Dados do Edital</div>
      <div class="overview-text-summary">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center;">
          <div style="font-weight: bold; text-align: right; color: #FFD700;" class="bigger-font">Data Prova:</div>
          <div style="text-align: left; color: #ffffff;" class="bigger-font">${dataProva}</div>
          <div style="font-weight: bold; text-align: right; color: #FFD700;" class="bigger-font">Dias p/ Prova:</div>
          <div style="text-align: left; color: #ffffff;" class="bigger-font">${globalMetas['Dias_p_Prova']?.value || 'N/A'} dias</div>
          <div style="font-weight: bold; text-align: right; color: #FFD700;" class="bigger-font">Temas:</div>
          <div style="text-align: left; color: #ffffff;" class="bigger-font">${globalMetas['Total_Temas_Edital']?.value || 'N/A'}</div>
        </div>
      </div>
    </div>
  `;

      // --- 📚 DISTRIBUIÇÃO DE QUESTÕES POR DISCIPLINA (DINÂMICO) ---
      let disciplinasContent = '';

      // Verifica se temos a nova configuração vinda da aba 'Config_Disciplinas'
      if (disciplineConfig && disciplineConfig.length > 0) {
        // Gera a lista baseada no que está na planilha
        disciplineConfig.forEach(d => {
          disciplinasContent += `
            <div style="font-weight: bold; text-align: right; color: #FFD700;">${d.name}:</div>
            <div style="text-align: left; color: #ffffff; font-weight: bold;">${d.questions} questões</div>
          `;
        });
      } else {
        // FALLBACK: Caso a lista nova ainda não tenha carregado, usa um padrão ou avisa
        disciplinasContent = '<div style="grid-column: 1 / -1; text-align: center; color: #aaa;">Nenhuma disciplina configurada na aba Config_Disciplinas.</div>';
      }
      const disciplinasHTML = `
    <div class="overview-chart">
      <div class="chart-title">📚 Distribuição de Questões por Disciplina</div>
      <div class="overview-text-summary distribuicao-questoes">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center;">
          ${disciplinasContent}
        </div>
      </div>
    </div>
  `;

      // --- DOIS GRÁFICOS DE PIZZA LADO A LADO (AGORA RESPONSIVO) ---
      const graficosPizza = `
    <div class="overview-chart">
      <div class="pizza-container">
        
        <div style="flex: 1; display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3);">
          <div style="position: relative; width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(#4CAF50 0% ${(topicsEstudados / totalTopics) * 100}%, #F44336 ${(topicsEstudados / totalTopics) * 100}% 100%); box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>
          <div style="text-align: left; font-size: 0.95rem; line-height: 1.6;">
            <div style="font-weight: bold; color: #FFD700;">🍕 Estudo</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #4CAF50; border-radius: 50%; margin-right: 6px;"></span> Estudado: ${topicsEstudados}</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #F44336; border-radius: 50%; margin-right: 6px;"></span> Falta: ${totalTopics - topicsEstudados}</div>
            <div style="margin-top: 6px; font-weight: bold;">Total: ${totalTopics}</div>
          </div>
        </div>
        <!-- Gráfico de Pizza: Revisão -->
        <div style="flex: 1; display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3);">
          <div style="position: relative; width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(#FFC107 0% ${(topicsRevisados / totalTopics) * 100}%, #F44336 ${(topicsRevisados / totalTopics) * 100}% 100%); box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>
          <div style="text-align: left; font-size: 0.95rem; line-height: 1.6;">
            <div style="font-weight: bold; color: #FFD700;">🍕 Revisão</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #FFC107; border-radius: 50%; margin-right: 6px;"></span> Revisado: ${topicsRevisados}</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #F44336; border-radius: 50%; margin-right: 6px;"></span> Falta: ${totalTopics - topicsRevisados}</div>
            <div style="margin-top: 6px; font-weight: bold;">Total: ${totalTopics}</div>
          </div>
        </div>
      </div>
    </div>
  `;

      // --- BARRAS DE PROGRESSO COM NÚMERO REAL + PORCENTAGEM NAS DUAS PARTES ---
      const totalPaginas = currentUserGoals['Total Material Páginas'] || 0;
      const paginasConcluidas = currentUserGoals['Páginas Concluídas'] || 0;
      const progressoPaginas = totalPaginas > 0 ? Math.round((paginasConcluidas / totalPaginas) * 100) : 0;
      const totalVideos = currentUserGoals['Total Material Vídeo Aulas'] || 0;
      const videosConcluidos = currentUserGoals['Vídeo Aulas Concluídas'] || 0;
      const progressoVideos = totalVideos > 0 ? Math.round((videosConcluidos / totalVideos) * 100) : 0;
      const totalArtigos = currentUserGoals['Total Material Artigos'] || 0;
      const artigosConcluidos = currentUserGoals['Artigos Concluídos'] || 0;
      const progressoArtigos = totalArtigos > 0 ? Math.round((artigosConcluidos / totalArtigos) * 100) : 0;
      const totalFlashcards = currentUserGoals['Total Material Flashcards'] || 0;
      const flashcardsConcluidos = currentUserGoals['Flashcards Concluídos'] || 0;
      const progressoFlashcards = totalFlashcards > 0 ? Math.round((flashcardsConcluidos / totalFlashcards) * 100) : 0;

      const cores = {
        Estudo: '#4CAF50',
        Revisão: '#FFC107',
        Questões: '#2196F3',
        Páginas: '#42A5F5',
        Vídeos: '#9C27B0',
        Artigos: '#FF9800',
        Flashcards: '#00BCD4'
      };

      function criarBarra(categoria, percentual, concluido, total, cor) {
        const falta = total - concluido;
        const percentualFalta = total > 0 ? Math.round((falta / total) * 100) : 0;
        return `
      <div class="discipline-progress" style="margin-bottom: 2px; position: relative;">
        <div class="discipline-name">
          <span>${categoria}</span>
          <span>${concluido}/${total} (${percentual}%)</span>
        </div>
        <div class="progress-bar-container" style="background-color: #333; height: 22px; border-radius: 11px; overflow: hidden; position: relative;">
          <div class="custom-progress-bar-fill" style="width: ${percentual}%; background-color: ${cor}; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: #000; font-size: 0.8rem; font-weight: bold;">
            ${concluido} (${percentual}%)
          </div>
          ${percentual < 100 ? `
            <div style="position: absolute; left: ${percentual}%; right: 0; top: 0; bottom: 0; display: flex; align-items: center; padding-left: 8px; color: #ccc; font-size: 0.8rem; font-weight: bold;">
              ${falta} (${percentualFalta}%)
            </div>
          ` : ''}
        </div>
      </div>
    `;
      }

      let barrasHTML = '';
      barrasHTML += criarBarra('Estudo', Math.round((topicsEstudados / totalTopics) * 100), topicsEstudados, totalTopics, cores.Estudo);
      barrasHTML += criarBarra('Revisão', Math.round((topicsRevisados / totalTopics) * 100), topicsRevisados, totalTopics, cores.Revisão);
      barrasHTML += criarBarra('Questões', Math.round((topicsQuestoes / totalTopics) * 100), topicsQuestoes, totalTopics, cores.Questões);
      barrasHTML += criarBarra('Páginas', progressoPaginas, paginasConcluidas, totalPaginas, cores.Páginas);
      barrasHTML += criarBarra('Vídeos', progressoVideos, videosConcluidos, totalVideos, cores.Vídeos);
      barrasHTML += criarBarra('Artigos', progressoArtigos, artigosConcluidos, totalArtigos, cores.Artigos);
      barrasHTML += criarBarra('Flashcards', progressoFlashcards, flashcardsConcluidos, totalFlashcards, cores.Flashcards);

      const barrasVerticaisHTML = `
    <div class="overview-chart" style="padding: 8px; margin-top: 10px;">
      <div class="chart-title">Progresso Detalhado por Categoria</div>
      <div style="display: flex; flex-direction: column; gap: 2px;">
        ${barrasHTML}
      </div>
    </div>
  `;

      // --- Montagem final ---
      const fullContent = `
    ${dadosEditalHTML}
    ${disciplinasHTML}
    ${graficosPizza}
    ${barrasVerticaisHTML}
  `;

      document.getElementById('overview-title').innerHTML = '<i class="fas fa-chart-bar"></i> VISÃO GERAL DO PROGRESSO';
      document.getElementById('overview-content').innerHTML = fullContent;
      // --- ATIVA GAMIFICAÇÃO (LINHA NOVA) ---
      renderGamificationDashboard('overview-content');
      document.getElementById('overviewModal').style.display = 'flex';
    }

    function showIndividualProgressOverview() {
      if (allTopics.length === 0) {
        showNotification('Nenhum dado carregado para calcular progresso', 'error');
        return;
      }
      const totalTopics = allTopics.length;
      const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
      const topicsRevisados = allTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
      const topicsQuestoes = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;

      function criarBarraIndividual(titulo, concluidos, total, corClasse = 'progress-bar-fill') {
        const percent = total > 0 ? Math.round((concluidos / total) * 100) : 0;
        const falta = total - concluidos;
        const percentFalta = total > 0 ? Math.round((falta / total) * 100) : 0;
        const bgColor = corClasse === 'revisao-bar-fill'
          ? 'linear-gradient(to right, #FFC107, #FFD54F)'
          : 'linear-gradient(to right, #2E7D32, #4CAF50)';

        return `
      <div class="discipline-progress">
        <div class="discipline-name">
          <span>${titulo}</span>
          <span>${concluidos}/${total} (${percent}%)</span>
        </div>
        <div class="progress-bar-container" style="position: relative;">
          <div class="${corClasse}" style="width: ${percent}%; background: ${bgColor};">
            ${concluidos} (${percent}%)
          </div>
          ${percent < 100 ? `
            <div style="position: absolute; left: ${percent}%; right: 0; top: 0; bottom: 0; display: flex; align-items: center; padding-left: 8px; color: #ccc; font-size: 0.8rem; font-weight: bold;">
              ${falta} (${percentFalta}%)
            </div>
          ` : ''}
        </div>
      </div>
    `;
      }

      const disciplines = [...new Set(allTopics.map(t => t.Disciplinas).filter(d => d))];
      let disciplineBars = '';

      disciplineBars += criarBarraIndividual('Estudo Concluído', topicsEstudados, totalTopics, 'progress-bar-fill');

      if (disciplines.length > 0) {
        disciplineBars += `<div class="chart-title" style="margin-top: 20px;">Gráfico 1: Progresso por Disciplina (Estudo)</div>`;
        disciplines.forEach(disc => {
          const discTopics = allTopics.filter(t => t.Disciplinas === disc);
          const total = discTopics.length;
          const concluidos = discTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
          disciplineBars += criarBarraIndividual(disc, concluidos, total, 'progress-bar-fill');
        });
      }

      let chart2 = `<div class="chart-title">Gráfico 2: Revisão Geral</div>`;
      chart2 += criarBarraIndividual('Revisão Concluída', topicsRevisados, totalTopics, 'revisao-bar-fill');

      if (disciplines.length > 0) {
        chart2 += `<div class="chart-title" style="margin-top: 20px;">Revisão por Disciplina</div>`;
        disciplines.forEach(disc => {
          const discTopics = allTopics.filter(t => t.Disciplinas === disc);
          const total = discTopics.length;
          const revisados = discTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
          chart2 += criarBarraIndividual(disc, revisados, total, 'revisao-bar-fill');
        });
      }

      const fullContent = `
    <div class="overview-chart">
      ${disciplineBars}
    </div>
    <div class="overview-chart">
      ${chart2}
    </div>
  `;

      document.getElementById('overview-title').innerHTML = '<i class="fas fa-chart-bar"></i> MINHA VISÃO GERAL DE PROGRESSO';
      document.getElementById('overview-content').innerHTML = fullContent;
      document.getElementById('overviewModal').style.display = 'flex';
    }

    function filterByDiscipline(disciplineName) {
      document.getElementById('disciplineFilter').value = disciplineName;
      const mobile = document.getElementById('disciplineFilterMobile');
      if (mobile) mobile.value = disciplineName;
      filterTopics();
      document.getElementById('overviewModal').style.display = 'none';
      showSection("topics-list-container");
      updateTopicCounter();
    }

    // --- FUNÇÕES DE SALVAMENTO DE TÓPICOS ---
    async function saveProgress() {
      const saveButton = document.getElementById('save-progress-btn');
      const originalText = '<i class="fas fa-save"></i> Salvar Progresso';

      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }

      // Se estiver em modo edição, mantém o salvamento normal (pois altera estrutura)
      if (isEditMode) {
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando Edição...';
        await saveTopicChanges();
        saveButton.innerHTML = originalText;
        return;
      }

      const sequence = currentTopicSequence;
      if (!sequence) {
        showNotification('Nenhum tópico selecionado.', 'error');
        return;
      }

      // Feedback Visual Imediato (Otimista)
      saveButton.innerHTML = '<i class="fas fa-check"></i> Processando...';
      saveButton.style.background = 'linear-gradient(135deg, #4CAF50, #66BB6A, #2E7D32)';

      try {
        // 1. Coleta os dados do formulário
        const payload = {
          userEmail: currentUserName,
          sequence: sequence,
          statusEstudo: document.getElementById('estudo-checkbox').checked ? 'Concluído' : 'Não Concluído',
          dataEstudo: document.getElementById('estudo-date').value,
          revisaoCount: parseInt(document.getElementById('revisao-count').value) || 0,
          statusRevisao: (parseInt(document.getElementById('revisao-count').value) || 0) > 0 ? 'Concluído' : 'Não Concluído',
          dataRevisao: document.getElementById('revisao-date').value,
          statusQuestoes: document.getElementById('questoes-checkbox').checked ? 'Concluído' : 'Não Concluído',
          dataQuestoes: document.getElementById('questoes-date').value,
          statusFlashcards: document.getElementById('flashcards-checkbox').checked ? 'Concluído' : 'Não Concluído',
          dataFlashcards: document.getElementById('flashcards-date').value
        };

        // 2. Envia para o Gerente de Sincronização
        // Ação: updateTopicStatus (mesma usada no Google Apps Script)
        SyncManager.enqueue("updateTopicStatus", payload, null);

        // 3. Atualiza os dados na memória local (para refletir na lista sem recarregar)
        const topic = allTopics.find(t => t.Seq == sequence);
        if (topic) {
          topic['Status Estudo'] = payload.statusEstudo;
          topic['Data Estudo'] = payload.dataEstudo;
          topic['Revisao Count'] = payload.revisaoCount;
          topic['Status Revisão'] = payload.statusRevisao;
          topic['Data Revisão'] = payload.dataRevisao;
          topic['Status Questões'] = payload.statusQuestoes;
          topic['Data Questões'] = payload.dataQuestoes;
          topic['Status Flashcards'] = payload.statusFlashcards;
          topic['Data Flashcards'] = payload.dataFlashcards;

          // Atualiza a visualização da lista
          displayTopicsList();
        }

        // Restaura botão após 1.5s
        setTimeout(() => {
          saveButton.innerHTML = originalText;
          saveButton.style.background = '';
          saveButton.classList.remove('pulse-animation');
        }, 1500);

      } catch (error) {
        console.error("Erro local:", error);
        showNotification(`Erro ao preparar salvamento: ${error.message}`, 'error');
        saveButton.innerHTML = originalText;
        saveButton.style.background = '';
      }
    }

    function toggleEditMode() {
      if (!isEditMode) {
        showConfirm('Ao editar o tópico, você estará modificando informações que foram pré-definidas. Tem certeza que deseja continuar?', (confirmed) => {
          if (confirmed) {
            activateEditMode();
          }
        });
      } else {
        deactivateEditMode();
      }
    }

    function activateEditMode() {
      isEditMode = true;
      originalTopicData = {
        disc: document.getElementById('info-disc').textContent,
        seq: document.getElementById('info-seq').textContent,
        topico: document.getElementById('info-topico').textContent,
        subtopico: document.getElementById('info-subtopico').textContent
      };
      document.getElementById('edit-mode-banner').style.display = 'block';
      document.querySelectorAll('.info-value').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.edit-input').forEach(el => {
        el.style.display = 'block';
        const field = el.id.replace('edit-', '');
        el.value = originalTopicData[field];
      });
      document.getElementById('edit-topic-btn').innerHTML = '<i class="fas fa-times"></i> Cancelar Edição';
      document.getElementById('edit-topic-btn').classList.remove('btn-edit');
      document.getElementById('edit-topic-btn').classList.add('btn-cancel');
      showNotification('Modo de edição ativado. Você pode modificar as informações do tópico.', 'success');
    }

    function deactivateEditMode() {
      isEditMode = false;
      document.getElementById('edit-mode-banner').style.display = 'none';
      document.querySelectorAll('.info-value').forEach(el => el.style.display = 'block');
      document.querySelectorAll('.edit-input').forEach(el => el.style.display = 'none');
      if (originalTopicData.disc) {
        document.getElementById('info-disc').textContent = originalTopicData.disc;
        document.getElementById('info-seq').textContent = originalTopicData.seq;
        document.getElementById('info-topico').textContent = originalTopicData.topico;
        document.getElementById('info-subtopico').textContent = originalTopicData.subtopico;
      }
      document.getElementById('edit-topic-btn').innerHTML = '<i class="fas fa-edit"></i> Editar Tópico';
      document.getElementById('edit-topic-btn').classList.remove('btn-cancel');
      document.getElementById('edit-topic-btn').classList.add('btn-edit');
      showNotification('Modo de edição desativado.', 'success');
    }

    async function saveTopicChanges() {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }
      const sequence = currentTopicSequence;
      if (!sequence) {
        showNotification('Nenhum tópico selecionado.', 'error');
        return;
      }
      const disc = document.getElementById('edit-disc').value;
      const seq = document.getElementById('edit-seq').value;
      const topico = document.getElementById('edit-topico').value;
      const subtopico = document.getElementById('edit-subtopico').value;
      if (!disc || !seq || !topico) {
        showNotification('Disciplina, Sequência e Tópico são obrigatórios.', 'error');
        return;
      }
      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "update_topic");
        if (SHEET_ID) params.append("spreadsheetId", SHEET_ID);
        params.append("userEmail", currentUserName);
        params.append("sequence", sequence);
        params.append("disc", disc);
        params.append("topico", topico);
        params.append("subtopico", subtopico);
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });
        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }
        if (!result.success) {
          throw new Error(result.message);
        }
        document.getElementById('info-disc').textContent = disc;
        document.getElementById('info-seq').textContent = seq;
        document.getElementById('info-topico').textContent = topico;
        document.getElementById('info-subtopico').textContent = subtopico;
        document.getElementById('topic-detail-title').innerHTML = `<i class="fas fa-book"></i> ${disc} - ${seq}`;
        if (subtopico && subtopico !== '—') {
          document.getElementById('topic-detail-title').innerHTML += `<br><i class="fas fa-level-down-alt"></i> ${subtopico}`;
        }
        document.getElementById('topic-detail-discipline').textContent = topico;
        showNotification('Tópico atualizado com sucesso!');
        deactivateEditMode();
        await loadAllData();
      } catch (error) {
        console.error("Erro ao salvar tópico:", error);
        showNotification(`Erro ao salvar: ${error.message}`, 'error');
      }
    }

    function resetProgress() {
      const resetButton = document.getElementById('reset-progress-btn');
      const sequence = currentTopicSequence;
      if (!sequence) return;
      showConfirm('Tem certeza que deseja limpar todo o progresso deste tópico?', async (confirmed) => {
        if (confirmed) {
          setButtonLoading(resetButton, true);
          try {
            const url = new URL(WEB_APP_URL);
            const params = new URLSearchParams();
            params.append("action", "reset");
            if (SHEET_ID) params.append("spreadsheetId", SHEET_ID);
            params.append("userEmail", currentUserName);
            params.append("sequence", sequence);

            // ✅ ADICIONAR reset do contador de revisões - SUBSTITUIÇÃO APLICADA
            params.append("resetRevisaoCount", "true");

            const response = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: params,
              redirect: 'follow'
            });

            const result = await response.json();
            if (result.error) {
              throw new Error(result.error);
            }
            if (!result.success) {
              throw new Error(result.message);
            }

            showNotification('Progresso resetado com sucesso!');
            await loadAllData();

          } catch (error) {
            console.error("Erro ao resetar progresso:", error);
            showNotification(`Erro ao resetar: ${error.message}`, 'error');
          } finally {
            setButtonLoading(resetButton, false);
          }
        }
      });
    }

    async function setDifficulty(level) {
      if (!currentTopicSequence) return;

      // Atualiza a aparência dos botões
      document.querySelectorAll('.btn-difficulty').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.level === level) {
          btn.classList.add('active');
        }
      });

      // Salva a informação
      await saveTopicDifficulty(currentTopicSequence, level);
    }

    async function saveTopicDifficulty(sequence, level) {
      if (!currentUserName || !SHEET_ID) {
        showNotification('Erro: Usuário não autenticado.', 'error');
        return;
      }

      console.log(`Enviando dificuldade: ${level} para o tópico ${sequence}`); // Log para debug

      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();

        // Ação correta para V14
        params.append("action", "updateDifficulty");

        if (SHEET_ID) params.append("spreadsheetId", SHEET_ID);
        params.append("userEmail", currentUserName);
        params.append("sequence", sequence);
        params.append("difficulty", level); // O script V14 espera 'difficulty'

        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });

        const result = await response.json();

        if (result.status === 'error' || result.error) {
          throw new Error(result.message || result.error);
        }

        // Sucesso Silencioso

        // Atualiza memória local imediatamente para não precisar recarregar
        const topic = allTopics.find(t => t.Seq == sequence);
        if (topic) {
          topic.Dificuldade = level;
        }

      } catch (error) {
        console.error("Erro ao salvar dificuldade:", error);
        showNotification(`Erro ao salvar dificuldade: ${error.message}`, 'error');
      }
    }
    // --- FIM DAS NOVAS FUNÇÕES DE DIFICULDADE ---

    // === FUNÇÕES DE CONTROLE RÁPIDO NA LISTA ===

    async function quickToggleEstudo(sequence, index, element) {
      // 1. Verificações básicas
      const user = currentUserName || localStorage.getItem('currentUserName');
      if (!user) {
        showNotification('Erro: Usuário não identificado.', 'error');
        return;
      }

      // 2. Lógica Visual (Otimista)
      const isCurrentlyChecked = element.classList.contains('checked-estudo');

      // Localiza a linha (topic-item) para seletores relativos (Mais robusto que ID+Index)
      const topicItem = element.closest('.topic-item');
      // Elementos de data na tela (Scopes lookup para evitar bugs de index/re-render)
      const dateSpan = topicItem ? topicItem.querySelector(`[id^="date-est-index-"]`) : null;
      const proxSpan = topicItem ? topicItem.querySelector(`[id^="date-prox-index-"]`) : null;
      const revSpan = topicItem ? topicItem.querySelector(`[id^="date-rev-index-"]`) : null;

      let newStatus, dataEstudo;

      if (isCurrentlyChecked) {
        // DESMARCANDO: Remove visual e limpa datas
        element.classList.remove('checked-estudo');
        element.textContent = '';

        // ATUALIZAÇÃO VISUAL: Limpa a data imediatamente
        if (dateSpan) dateSpan.textContent = '—';
        if (proxSpan) {
          proxSpan.textContent = '—';
          proxSpan.style.color = '#aaa';
        }
        if (revSpan) revSpan.textContent = '—';

        newStatus = 'Não Concluído';
        dataEstudo = '';

        // --- CORREÇÃO: Limpar dificuldade visualmente ---
        const row = element.closest('.quick-controls');
        if (row) {
          const diffBtn = row.querySelector('.quick-difficulty-btn'); // Pega o botão de dificuldade
          if (diffBtn) {
            // Reseta o botão para o estado neutro/vazio
            diffBtn.className = 'quick-difficulty-btn';
            diffBtn.innerHTML = '<i class="fas fa-minus" style="font-size: 0.6rem;"></i>';
            diffBtn.title = 'Definir Dificuldade';
            // Reseta onclick para começar do Fácil
            diffBtn.setAttribute('onclick', `quickCycleDifficulty(event, '${sequence}', '', this)`);
          }
        }

        // Atualiza Model Local
        const currentTopic = allTopics.find(t => t.Seq == sequence);
        if (currentTopic) {
          currentTopic['Dificuldade'] = '';

          // Sincroniza remoção da dificuldade
          SyncManager.enqueue('updateDifficulty', {
            action: 'updateDifficulty',
            user: currentUserName,
            sequence: sequence,
            difficulty: ''
          }, null);
        }

      } else {
        // MARCANDO: Adiciona visual e data de hoje
        element.classList.add('checked-estudo');
        element.textContent = '✓';

        // Formata data curta para visualização imediata (DD/MM/AA)
        const today = new Date();
        const dd = String(today.getDate()).padStart(2, '0');
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const yy = String(today.getFullYear()).slice(2);

        if (dateSpan) dateSpan.textContent = `${dd}/${mm}/${yy}`;

        // --- NOVO: Auto-definir Dificuldade como "Fácil" se estiver vazia ---
        const currentTopic = allTopics.find(t => t.Seq == sequence);
        // Robustez: Verifica se está vazio ou apenas espaços
        const diffLimpa = (currentTopic && currentTopic['Dificuldade']) ? currentTopic['Dificuldade'].trim() : '';

        if (currentTopic && !diffLimpa) {
          // 1. Atualiza Local
          currentTopic['Dificuldade'] = 'Fácil';

          // 2. Atualiza Visual (encontra o botão na linha)
          const row = element.closest('.quick-controls'); // Busca o pai quick-controls
          if (row) {
            const diffBtn = row.querySelector('.quick-difficulty-btn');
            if (diffBtn) {
              diffBtn.innerHTML = '<i class="fas fa-smile"></i>';
              diffBtn.className = 'quick-difficulty-btn diff-facil';
              diffBtn.title = 'Dificuldade: Fácil';
              // Ajusta o onclick para o próximo ciclo ser Médio
              diffBtn.setAttribute('onclick', `quickCycleDifficulty(event, '${sequence}', 'Fácil', this)`);
            }
          }

          // 3. Salva no Servidor (Assíncrono)
          saveTopicDifficulty(sequence, 'Fácil');
        }

        // --- CÁLCULO OTIMISTA DA PRÓXIMA REVISÃO ---
        if (proxSpan) {
          const nivel = (currentTopic && currentTopic['Dificuldade']) || 'Fácil';
          const intervalosSRS = {
            'Fácil': [2, 6, 14, 30, 60],
            'Médio': [1, 3, 7, 15, 30],
            'Difícil': [1, 2, 4, 8, 15]
          };
          const serie = intervalosSRS[nivel] || intervalosSRS['Fácil'];
          const dias = serie[0]; // Primeira revisão (count 0)

          const dt = new Date();
          dt.setDate(dt.getDate() + dias);
          const pD = String(dt.getDate()).padStart(2, '0');
          const pM = String(dt.getMonth() + 1).padStart(2, '0');
          const pA = String(dt.getFullYear()).slice(2);
          proxSpan.textContent = `${pD}/${pM}/${pA}`;
          proxSpan.style.color = '#4CAF50';
        }

        newStatus = 'Concluído';
        dataEstudo = new Date().toISOString().split('T')[0];
      }

      // 3. Prepara os dados
      const payload = {
        userEmail: user,
        sequence: sequence,
        statusEstudo: newStatus,
        dataEstudo: dataEstudo
      };

      // 4. Envia para a Fila Offline
      SyncManager.enqueue("updateTopicStatus", payload, null);

      // 5. Atualiza memória local do tópico
      const topic = allTopics.find(t => t.Seq == sequence);
      if (topic) {
        topic['Status Estudo'] = newStatus;
        topic['Data Estudo'] = dataEstudo;
      }
    }
    async function quickToggleQuestoes(sequence, element) {
      // 1. Verificações básicas
      const user = currentUserName || localStorage.getItem('currentUserName');
      if (!user) {
        showNotification('Erro: Usuário não identificado.', 'error');
        return;
      }

      // 2. Lógica Visual Imediata (Otimista)
      const isCurrentlyChecked = element.classList.contains('checked-questoes');

      if (isCurrentlyChecked) {
        element.classList.remove('checked-questoes');
        element.textContent = '';
      } else {
        element.classList.add('checked-questoes');
        element.textContent = '✓';
      }

      // 3. Prepara os dados
      const newStatus = !isCurrentlyChecked ? 'Concluído' : 'Não Concluído';
      const dataQuestoes = !isCurrentlyChecked ? new Date().toISOString().split('T')[0] : '';

      const payload = {
        userEmail: user,
        sequence: sequence,
        statusQuestoes: newStatus,
        dataQuestoes: dataQuestoes
      };

      // 4. Envia para o Gerente de Sincronização
      SyncManager.enqueue("updateTopicStatus", payload, null);

      // 5. Atualiza memória local do tópico (para filtros e gráficos)
      const topic = allTopics.find(t => t.Seq == sequence);
      if (topic) {
        topic['Status Questões'] = newStatus;
        topic['Data Questões'] = dataQuestoes;
      }
    }
    async function quickToggleFlashcards(sequence, element) {
      // 1. Verificações básicas
      const user = currentUserName || localStorage.getItem('currentUserName');
      if (!user) {
        showNotification('Erro: Usuário não identificado.', 'error');
        return;
      }

      // 2. Lógica Visual Imediata (Otimista)
      const isCurrentlyChecked = element.classList.contains('checked-flashcards');

      if (isCurrentlyChecked) {
        element.classList.remove('checked-flashcards');
        element.textContent = '';
      } else {
        element.classList.add('checked-flashcards');
        element.textContent = '✓';
      }

      // 3. Prepara os dados
      const newStatus = !isCurrentlyChecked ? 'Concluído' : 'Não Concluído';
      const dataFlashcards = !isCurrentlyChecked ? new Date().toISOString().split('T')[0] : '';

      const payload = {
        userEmail: user,
        sequence: sequence,
        statusFlashcards: newStatus,
        dataFlashcards: dataFlashcards
      };

      // 4. Envia para o Gerente de Sincronização
      SyncManager.enqueue("updateTopicStatus", payload, null);

      // 5. Atualiza memória local do tópico
      const topic = allTopics.find(t => t.Seq == sequence);
      if (topic) {
        topic['Status Flashcards'] = newStatus;
        topic['Data Flashcards'] = dataFlashcards;
      }
    }
    // === NOVA FUNÇÃO: CICLAR DIFICULDADE NA LISTA ===
    async function quickCycleDifficulty(event, sequence, currentLevel, element) {
      if (event) event.stopPropagation();

      // Definição do ciclo: Fácil -> Médio -> Difícil -> Fácil...
      // MUDANÇA: Removido o estado vazio '' do ciclo
      const cycle = ['Fácil', 'Médio', 'Difícil'];

      // Normaliza o nível atual
      let safeCurrent = currentLevel || '';

      // Encontra a posição atual
      let currentIndex = cycle.indexOf(safeCurrent);
      if (currentIndex === -1) currentIndex = 0; // Se não achar (ex: erro de digitação), assume vazio

      // Calcula o próximo (AQUI ESTÁ A MUDANÇA)
      let nextIndex = currentIndex + 1;

      // Se passar do último (Difícil), volta para o PRIMEIRO (Vazio/0)
      if (nextIndex >= cycle.length) {
        nextIndex = 0;
      }

      const newLevel = cycle[nextIndex];

      // --- 1. ATUALIZAÇÃO VISUAL OTIMISTA ---
      // Remove todas as classes de cor
      element.classList.remove('diff-facil', 'diff-medio', 'diff-dificil');

      let newIcon = '';
      let tooltipText = '';

      if (newLevel === 'Fácil') {
        element.classList.add('diff-facil');
        newIcon = '<i class="fas fa-smile"></i>';
        tooltipText = 'Dificuldade: Fácil';
      } else if (newLevel === 'Médio') {
        element.classList.add('diff-medio');
        newIcon = '<i class="fas fa-meh"></i>';
        tooltipText = 'Dificuldade: Média';
      } else if (newLevel === 'Difícil') {
        element.classList.add('diff-dificil');
        newIcon = '<i class="fas fa-dizzy"></i>';
        tooltipText = 'Dificuldade: Difícil';
      } else {
        // Fallback (não deve acontecer com novo ciclo, mas mantemos por segurança como Fácil)
        element.classList.add('diff-facil');
        newIcon = '<i class="fas fa-smile"></i>';
        tooltipText = 'Dificuldade: Fácil';
      }

      element.innerHTML = newIcon;
      element.title = tooltipText;

      // Atualiza o atributo onclick para o próximo clique
      element.setAttribute('onclick', `quickCycleDifficulty(event, '${sequence}', '${newLevel}', this)`);

      // Atualiza memória local
      const topic = allTopics.find(t => t.Seq == sequence);
      if (topic) topic['Dificuldade'] = newLevel;

      // --- 2. SALVAR NO SERVIDOR ---
      await saveTopicDifficulty(sequence, newLevel);
    }
    // Função atualizada para posicionar a caixa ao lado do clique
    function openRevisaoPopup(event, sequence, index, currentCount) {
      // Previne que o clique propague (opcional, mas bom para segurança)
      if (event) event.stopPropagation();

      // Cria backdrop (fundo escuro) transparente para fechar ao clicar fora
      const backdrop = document.createElement('div');
      backdrop.className = 'popup-backdrop';
      backdrop.style.background = 'transparent'; // Transparente para parecer um menu suspenso
      backdrop.onclick = () => closeRevisaoPopup();

      // Cria popup
      const popup = document.createElement('div');
      popup.className = 'revisao-popup';
      popup.id = 'revisao-popup';
      popup.innerHTML = `
    <h4 style="margin:0 0 10px 0; font-size:0.9rem;"><i class="fas fa-sync-alt"></i> Atualizar Revisões</h4>
    <input type="number" id="revisao-input" min="0" value="${currentCount}" 
           style="width: 100%; margin-bottom: 10px;"
           onkeypress="if(event.key==='Enter') saveRevisaoPopup('${sequence}')">
    <div class="revisao-popup-buttons" style="justify-content: space-between;">
      <button class="btn-modal-cancel" onclick="closeRevisaoPopup()" style="font-size:0.75rem; padding:4px 8px;">Cancelar</button>
      <button class="btn-modal-confirm" onclick="saveRevisaoPopup('${sequence}', ${index})" style="font-size:0.75rem; padding:4px 8px;">Salvar</button>
    </div>
  `;

      document.body.appendChild(backdrop);
      document.body.appendChild(popup);

      // --- LÓGICA DE POSICIONAMENTO ---
      if (event && event.target) {
        const rect = event.target.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

        // Posiciona logo ACIMA do elemento clicado
        // Pega a altura da caixa criada para subtrair corretamente
        const popupHeight = popup.offsetHeight;
        let topPos = rect.top + scrollTop - popupHeight - 10; // 10px de espaço visual
        let leftPos = rect.left + scrollLeft - 100; // Ajusta um pouco para a esquerda para centralizar

        // Correção simples para não sair da tela (direita)
        if (leftPos + 220 > window.innerWidth) {
          leftPos = window.innerWidth - 230;
        }
        // Correção para não sair da tela (esquerda)
        if (leftPos < 10) leftPos = 10;

        popup.style.top = topPos + 'px';
        popup.style.left = leftPos + 'px';
      } else {
        // Fallback: Se não tiver evento, centraliza (segurança)
        popup.style.position = 'fixed';
        popup.style.top = '50%';
        popup.style.left = '50%';
        popup.style.transform = 'translate(-50%, -50%)';
      }

      // Foca no input
      setTimeout(() => {
        const input = document.getElementById('revisao-input');
        if (input) input.select();
      }, 100);
    }

    function closeRevisaoPopup() {
      const popup = document.getElementById('revisao-popup');
      const backdrop = document.querySelector('.popup-backdrop');
      if (popup) popup.remove();
      if (backdrop) backdrop.remove();
    }

    async function saveRevisaoPopup(sequence, index) {
      const input = document.getElementById('revisao-input');
      if (!input) return;
      const count = parseInt(input.value) || 0;

      const user = currentUserName || localStorage.getItem('currentUserName');
      if (!user) {
        showNotification('Erro: Usuário não identificado.', 'error');
        return;
      }

      // 1. Fecha o popup imediatamente
      closeRevisaoPopup();

      // 2. Prepara os dados
      const hojeISO = new Date().toISOString().split('T')[0];
      const payload = {
        userEmail: user,
        sequence: sequence,
        revisaoCount: count,
        statusRevisao: count > 0 ? 'Concluído' : 'Não Concluído',
        dataRevisao: count > 0 ? hojeISO : ''
      };

      // 3. Envia para a Fila Offline (SyncManager)
      if (typeof SyncManager !== 'undefined') {
        SyncManager.enqueue("updateTopicStatus", payload, null);
      }

      // 4. Atualiza memória local e visual da lista (Sem recarregar)
      const topic = allTopics.find(t => t.Seq == sequence);

      if (topic) {
        // Atualiza dados na memória
        topic['Revisao Count'] = count;
        topic['Data Revisão'] = (count > 0) ? hojeISO : '';

        // --- LÓGICA DE ATUALIZAÇÃO VISUAL (OTIMISTA) ---

        // Localiza a linha (topic-item) para seletores relativos (Mais robusto que ID+Index)
        const topicItem = document.querySelector(`.topic-item[data-sequence="${sequence}"]`);

        // 1. Contador de Revisões
        if (topicItem) {
          const counterElement = topicItem.querySelector('.quick-revisao-counter');
          if (counterElement) {
            counterElement.textContent = count;
            if (count > 0) counterElement.classList.add('has-revisoes');
            else counterElement.classList.remove('has-revisoes');
            // IMPORTANTE: Atualiza o onclick do contador para o novo valor
            counterElement.setAttribute('onclick', `openRevisaoPopup(event, '${sequence}', ${index}, ${count})`);
          }
        }

        // 2. Data de Revisão (Rev)
        const dateRevSpan = topicItem ? topicItem.querySelector(`[id^="date-rev-index-"]`) : null;
        if (dateRevSpan) {
          if (count > 0) {
            const d = new Date();
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const ano = String(d.getFullYear()).slice(2);
            dateRevSpan.textContent = `${dia}/${mes}/${ano}`;
          } else {
            dateRevSpan.textContent = '—';
          }
        }

        // 3. Próxima Revisão (Prox) - CÁLCULO OTIMISTA
        const dateProxSpan = topicItem ? topicItem.querySelector(`[id^="date-prox-index-"]`) : null;
        if (dateProxSpan) {
          if (topic['Data Estudo'] && count >= 0) {
            const intervalosSRS = {
              'Fácil': [2, 6, 14, 30, 60],
              'Médio': [1, 3, 7, 15, 30],
              'Difícil': [1, 2, 4, 8, 15]
            };
            const nivel = topic['Dificuldade'] || 'Fácil';
            const serie = intervalosSRS[nivel] || intervalosSRS['Fácil'];

            let dataProxStr = '—';
            let corProx = '#aaa';

            if (count < serie.length) {
              const baseDate = (count > 0) ? hojeISO : topic['Data Estudo'];
              const dias = serie[count];
              const dt = new Date(baseDate + 'T12:00:00');
              dt.setDate(dt.getDate() + dias);

              const d = String(dt.getDate()).padStart(2, '0');
              const m = String(dt.getMonth() + 1).padStart(2, '0');
              const a = String(dt.getFullYear()).slice(2);
              dataProxStr = `${d}/${m}/${a}`;

              const hoje = new Date();
              hoje.setHours(0, 0, 0, 0);
              dt.setHours(0, 0, 0, 0);
              if (hoje > dt) corProx = '#ff5555';
              else if (hoje.getTime() === dt.getTime()) corProx = '#F7EF8A';
              else corProx = '#4CAF50';
            } else {
              // Modo Infinito simplificado para o otimista
              dataProxStr = 'Recálculo pendente ∞';
              corProx = '#4CAF50';
            }

            dateProxSpan.textContent = dataProxStr;
            dateProxSpan.style.color = corProx;
          } else {
            dateProxSpan.textContent = '—';
            dateProxSpan.style.color = '#aaa';
          }
        }
      }
    }
    // --- FUNÇÕES DA AGENDA (FASE 2 COMPLETA) ---

    // Função com loading para o botão Agenda
    // Função com loading INTELIGENTE para o botão Agenda
    async function showAgendaWithLoading() {
      // --- NOVO: VERIFICAÇÃO DE PERFORMANCE ---
      // Se a agenda já foi carregada em background, abre imediatamente sem loading
      if (window.agendaDataLoaded) {
        showAgendaModal();
        return;
      }
      // ----------------------------------------

      const button = document.querySelector('.top-bar button:nth-child(7)');
      const mainIcon = button.querySelector('.fa-calendar-alt');
      const spinner = button.querySelector('.button-spinner');

      // 1. Ativa visual no botão
      button.classList.add('loading');
      if (mainIcon) mainIcon.style.display = 'none';
      if (spinner) spinner.style.display = 'inline-block';

      // 2. Adiciona overlay de carregamento na tela toda
      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'agenda-loading-overlay';
      loadingOverlay.innerHTML = `
        <div class="loading-content">
            <div class="spinner-large"></div>
            <p>Carregando sua agenda de estudos...</p>
            <p class="loading-subtext">Isso pode levar alguns segundos</p>
        </div>
    `;
      document.body.appendChild(loadingOverlay);

      try {
        // Força um tempo mínimo de exibição do loading (300ms) apenas se precisar carregar
        const loadingPromise = new Promise(resolve => setTimeout(resolve, 300));

        // Verifica novamente (redundância de segurança) ou carrega se necessário
        if (!window.agendaDataLoaded) {
          await Promise.all([loadAgendaData(), loadingPromise]);
          window.agendaDataLoaded = true;
        } else {
          await loadingPromise;
        }

        showAgendaModal();
      } catch (error) {
        console.error("Erro ao mostrar agenda:", error);
        showNotification('Não foi possível carregar a agenda.', 'error');
      } finally {
        // Remove o overlay de loading
        const overlay = document.getElementById('agenda-loading-overlay');
        if (overlay) overlay.remove();

        // Restaura o botão
        button.classList.remove('loading');
        button.disabled = false;
        if (mainIcon) mainIcon.style.display = 'inline-block';
        if (spinner) spinner.style.display = 'none';
      }
    }
    // Fechar modal da agenda
    function closeAgendaModal() {
      if (isTimerRunning) startPauseTimer(); // Pausa o timer se estiver rodando
      // Esta função agora é mais inteligente!
      // Primeiro, ela verifica se a aba "Configurações" está ativa.
      const configTab = document.querySelector('.agenda-tab[onclick*="config"]');
      const isConfigTabActive = configTab && configTab.classList.contains('active');

      // Se a aba "Configurações" for a que está aberta...
      if (isConfigTabActive) {
        // ...ela não fecha a agenda, mas sim volta para a aba "Semanal".
        // Para isso, encontramos o botão da aba "Semanal" e clicamos nele.
        const semanalTabButton = document.querySelector('.agenda-tab[onclick*="semanal"]');
        if (semanalTabButton) {
          semanalTabButton.click();
        } else {
          // Caso algo dê errado, apenas fecha a janela como antes.
          document.getElementById('agendaModal').style.display = 'none';
        }
      } else {
        // Se qualquer outra aba (Semanal ou Mensal) estiver aberta, o botão "Fechar"
        // funciona normalmente, fechando a janela da agenda.
        document.getElementById('agendaModal').style.display = 'none';
      }
    }

    // Trocar entre abas
    function switchAgendaTab(tabName) {
      // Atualizar botões ativos
      document.querySelectorAll('.agenda-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');

      // Carregar conteúdo da aba
      loadAgendaTab(tabName);
    }

    // Carregar dados da agenda
    async function loadAgendaData() {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return [];
      }

      try {
        // --- CORREÇÃO: USAR POST E action 'getAgendaEvents' ---
        const payload = {
          action: 'getAgendaEvents', // Nome correto da ação no novo Script
          user: currentUserName,
          spreadsheetId: SHEET_ID
        };

        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        // ------------------------------------------------------

        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        // Adaptação: O script retorna { events: [...] }
        const data = result.data || result;
        window.agendaData = data.events || [];

        return window.agendaData;

      } catch (error) {
        console.error('Erro ao carregar agenda:', error);
        showNotification('Erro ao carregar agenda.', 'error');
        return [];
      }
    }

    // Carregar conteúdo da aba específica
    function loadAgendaTab(tabName) {
      const contentDiv = document.getElementById('agenda-content');

      switch (tabName) {
        case 'semanal':
          contentDiv.innerHTML = generateWeeklyView();
          initializeAgendaInteractions();
          // Garantir que a visibilidade dos períodos seja atualizada após carregar a interface
          setTimeout(updatePeriodoVisibility, 100);
          break;
        case 'mensal':
          contentDiv.innerHTML = generateMonthlyView();
          initializeMonthlyView();
          break;
        case 'config':
          contentDiv.innerHTML = generateConfigView();
          initializeConfigView();
          break;
      }
    }

    // ==================== ABA SEMANAL ====================

    function generateWeeklyView() {
      return `
        <div class="weekly-agenda">
    <div class="agenda-toolbar" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;">
    
    <div style="display: flex; gap: 8px; align-items: center;">
        
        <button onclick="openGenerateOptionsModal()" class="btn-save tooltip-btn" data-title="Gerar Ag. Automática">
            <i class="fas fa-robot"></i> Gerar Agenda
        </button>

        <button onclick="reschedulePendingFromYesterday()" class="btn-edit btn-icon-only tooltip-btn" data-title="Resgatar pendências de ontem" style="background: linear-gradient(135deg, #FF9800, #F57C00); color: white;">
            <i class="fas fa-history"></i>
        </button>

        <button onclick="addNewBlock()" class="btn-edit btn-icon-only tooltip-btn" data-title="Novo Bloco">
            <i class="fas fa-plus"></i>
        </button>

        <button onclick="clearAgenda()" class="btn-reset btn-icon-only tooltip-btn" data-title="Limpar Agenda">
            <i class="fas fa-trash"></i>
        </button>

        <button onclick="saveAgenda()" class="btn-save btn-icon-only tooltip-btn" data-title="Salvar Agenda">
            <i class="fas fa-save"></i>
        </button>
    </div>

    <div style="display: flex; gap: 15px; align-items: center;">
        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
            <label style="color: #fff; cursor: pointer;"><input type="checkbox" id="periodo-manha" checked> Manhã</label>
            <label style="color: #fff; cursor: pointer;"><input type="checkbox" id="periodo-tarde" checked> Tarde</label>
            <label style="color: #fff; cursor: pointer;"><input type="checkbox" id="periodo-noite" checked> Noite</label>
        </div>
        <div id="week-date-range" style="color: #Fff; font-weight: bold; font-size: 0.85rem; border-left: 1px solid #555; padding-left: 10px;"></div>
    </div>

</div>
         <div class="week-grid-container">
            ${generateWeekGrid()}
         </div>
          </div>

          <div id="generate-options-modal" class="modal-backdrop" style="display: none; z-index: 2000;">
            <div class="modal" style="max-width: 500px;">
                <button class="btn-close-absolute" onclick="closeGenerateOptionsModal()" style="top: 10px; right: 10px; width: 24px; height: 24px;">X</button>
                <h3 style="text-align: center; color: #F7EF8A; margin-bottom: 5px;"><i class="fas fa-robot"></i> Gerar Agenda Automática</h3>
                <p style="text-align: center; color: #ccc; margin-bottom: 20px;">Escolha o tipo de agendamento:</p>
                
                <div class="generate-options-container">
                    <div class="option-card" onclick="generateAutoAgenda('daily'); closeGenerateOptionsModal();">
                        <i class="fas fa-calendar-day" style="color: #4CAF50;"></i>
                        <h4>Apenas Hoje</h4>
                        <p>Preenche os horários vazios do dia atual.</p>
                    </div>
                    <div class="option-card" onclick="generateAutoAgenda('weekly'); closeGenerateOptionsModal();">
                        <i class="fas fa-calendar-week" style="color: #2196F3;"></i>
                        <h4>Semana Toda</h4>
                        <p>Planeja a semana completa baseada nas metas.</p>
                    </div>
                </div>
            </div>
          </div>

          <div id="block-modal" class="modal-backdrop" style="display: none;">
            <div class="modal" style="max-width: 500px;">
              <h3 id="block-modal-title"><i class="fas fa-plus"></i> Adicionar Bloco</h3>
			  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div class="form-field" style="flex: 1;">
                <label>Dia:</label>
                <select id="block-dia" style="width: 100%; padding: 8px; background: #222; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    <option value="Segunda">Segunda</option>
                    <option value="Terça">Terça</option>
                    <option value="Quarta">Quarta</option>
                    <option value="Quinta">Quinta</option>
                    <option value="Sexta">Sexta</option>
                    <option value="Sábado">Sábado</option>
                    <option value="Domingo">Domingo</option>
                </select>
                </div>
                <div class="form-field" style="flex: 1;">
                <label>Período:</label>
                <select id="block-periodo" style="width: 100%; padding: 8px; background: #222; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    <option value="Manhã">Manhã</option>
                    <option value="Tarde">Tarde</option>
                    <option value="Noite">Noite</option>
                </select>
                </div>
            </div>
              <div class="form-field" style="margin-bottom: 15px;">
                <label>Disciplina:</label>
                <select id="block-disciplina" style="width: 100%; padding: 8px; background: #222; color: #fff; border: 1px solid #555; border-radius: 4px;">
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div class="form-field" style="margin-bottom: 15px;">
                <label>Tópico:</label>
                <select id="block-topico" style="width: 100%; padding: 8px; background: #222; color: #fff; border: 1px solid #555; border-radius: 4px;">
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div class="form-field" style="margin-bottom: 15px;">
                <label>Horas:</label>
                <input type="number" id="block-horas" min="0.5" max="8" step="0.5" value="2" style="width: 100%; padding: 8px; background: #222; color: #fff; border: 1px solid #555; border-radius: 4px;">
              </div>
              <div class="form-field" style="margin-bottom: 15px;">
                <label>Prioridade:</label>
                <select id="block-prioridade" style="width: 100%; padding: 8px; background: #222; color: #fff; border: 1px solid #555; border-radius: 4px;">
                  <option value="Alta">Alta</option>
                  <option value="Média" selected>Média</option>
                  <option value="Baixa">Baixa</option>
                </select>
              </div>
              <div class="modal-buttons">
                <button class="btn-modal-cancel" onclick="closeBlockModal()">Cancelar</button>
                <button class="btn-modal-confirm" onclick="saveBlockModal()">Salvar</button>
              </div>
            </div>
          </div>
      `;
    }

    function generateWeekGrid() {
      const today = new Date();
      const weekdays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
      const todayName = weekdays[today.getDay()];
      const days = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
      const periods = ['Manhã', 'Tarde', 'Noite'];

      // Calcula a data de segunda-feira desta semana
      const monday = new Date(today);
      monday.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));

      let gridHTML = '<div class="week-grid">';

      // Cabeçalho dos períodos (primeira coluna, vazia para alinhar)
      gridHTML += '<div></div>';

      // Cabeçalho dos dias com a data correta
      days.forEach((day, index) => {
        const currentDate = new Date(monday);
        currentDate.setDate(monday.getDate() + index);
        const dateString = currentDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        const isToday = day === todayName;

        // Adiciona a classe 'today' se for o dia atual
        gridHTML += `<div class="day-header ${isToday ? 'today' : ''}">${day}<br><span style="font-size: 0.8em; color: #ccc;">${dateString}</span></div>`;
      });

      // Gera as linhas para cada período (Manhã, Tarde, Noite)
      periods.forEach(period => {
        // Adiciona o cabeçalho do período (ex: "Manhã")
        gridHTML += `<div class="period-header" data-period="${period}" style="font-size: 1.2rem; text-transform: uppercase;">${period}</div>`;

        // Adiciona as caixas de horário para cada dia da semana
        days.forEach(day => {
          gridHTML += `
                <div class="time-slot" data-day="${day}" data-period="${period}" onclick="handleMobileSlotClick(this)" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)" ondragleave="dragLeaveHandler(event)">
                    <div class="slot-content" id="slot-${day}-${period}"></div>
                    <button onclick="openBlockModal('${day}', '${period}')" class="add-block-btn" title="Adicionar Bloco">+</button>
                </div>
            `;
        });
      });

      gridHTML += '</div>';
      return gridHTML;
    }

    function updateWeekDateRange() {
      const dateRangeElement = document.getElementById('week-date-range');
      if (!dateRangeElement) return;

      const today = new Date();
      // Ajuste para considerar Segunda-feira (1) como início da semana. Domingo é 0.
      const dayOfWeek = today.getDay();
      const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

      const monday = new Date(today);
      monday.setDate(today.getDate() + diffToMonday);

      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);

      const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
      const startDate = monday.toLocaleDateString('pt-BR', options);
      const endDate = sunday.toLocaleDateString('pt-BR', options);

      dateRangeElement.innerHTML = `<i class="fas fa-calendar-alt"></i> Semana de ${startDate} a ${endDate}`;
    }
    function initializeAgendaInteractions() {
      populateDisciplineDropdown();
      loadExistingBlocks();
      updateWeekDateRange();

      // Carregar preferências salvas do localStorage
      const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');
      const mostrarManha = config.periodos?.includes('manha') ?? true;
      const mostrarTarde = config.periodos?.includes('tarde') ?? true;
      const mostrarNoite = config.periodos?.includes('noite') ?? true;

      document.getElementById('periodo-manha').checked = mostrarManha;
      document.getElementById('periodo-tarde').checked = mostrarTarde;
      document.getElementById('periodo-noite').checked = mostrarNoite;

      // Adicionar eventos de mudança aos checkboxes da grade principal
      document.getElementById('periodo-manha').addEventListener('change', (e) => syncPeriodCheckboxes(e.target, 'config'));
      document.getElementById('periodo-tarde').addEventListener('change', (e) => syncPeriodCheckboxes(e.target, 'config'));
      document.getElementById('periodo-noite').addEventListener('change', (e) => syncPeriodCheckboxes(e.target, 'config'));

      updatePeriodoVisibility();

      // --- INÍCIO DA MODIFICAÇÃO: Centralizar dia atual ---
      setTimeout(() => {
        const todayHeader = document.querySelector('.day-header.today');
        const container = document.querySelector('.week-grid-container');
        if (todayHeader && container) {
          const scrollPos = todayHeader.offsetLeft - (container.clientWidth / 2) + (todayHeader.clientWidth / 2);
          container.scrollLeft = scrollPos;
        }
      }, 100); // Pequeno delay para garantir que a interface foi renderizada
      // --- FIM DA MODIFICAÇÃO ---
    }

    function populateDisciplineDropdown() {
      const disciplinaSelect = document.getElementById('block-disciplina');
      if (!disciplinaSelect) return;

      // Obter disciplinas únicas dos tópicos
      const disciplines = [...new Set(allTopics.map(topic => topic.Disciplinas).filter(d => d))];

      disciplinaSelect.innerHTML = '<option value="">Selecione uma disciplina</option>';
      disciplines.forEach(discipline => {
        const option = document.createElement('option');
        option.value = discipline;
        option.textContent = discipline;
        disciplinaSelect.appendChild(option);
      });

      // Quando disciplina mudar, carregar tópicos
      disciplinaSelect.addEventListener('change', function () {
        populateTopicDropdown(this.value);
      });
    }

    function populateTopicDropdown(disciplina) {
      const topicoSelect = document.getElementById('block-topico');
      if (!topicoSelect) return;

      topicoSelect.innerHTML = '<option value="">Selecione um tópico</option>';

      if (!disciplina) return;

      // Filtrar tópicos da disciplina selecionada
      const topics = allTopics.filter(topic => topic.Disciplinas === disciplina);
      topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.Seq;
        option.textContent = `${topic.Seq} - ${topic.Tópicos}${topic.Subtópicos && topic.Subtópicos !== '—' ? ' - ' + topic.Subtópicos : ''}`;
        option.dataset.topicName = topic.Tópicos;
        option.dataset.subtopic = topic.Subtópicos || '';
        topicoSelect.appendChild(option);
      });
    }

    function openBlockModal(day, period) {
      window.editingBlockId = null;

      document.getElementById('block-modal-title').innerHTML = '<i class="fas fa-plus"></i> Adicionar Bloco de Estudo';
      document.getElementById('block-modal').style.display = 'flex';

      // Preenche ou reseta os seletores de dia e período
      document.getElementById('block-dia').value = day || 'Segunda';
      document.getElementById('block-periodo').value = period || 'Manhã';

      // Resetar o resto do formulário
      document.getElementById('block-disciplina').value = '';
      document.getElementById('block-topico').innerHTML = '<option value="">Selecione um tópico</option>';
      document.getElementById('block-horas').value = '2';
      document.getElementById('block-prioridade').value = 'Média';
    }
    function closeBlockModal() {
      document.getElementById('block-modal').style.display = 'none';
    }

    function saveBlockModal() {
      const disciplina = document.getElementById('block-disciplina').value;
      const topicoSelect = document.getElementById('block-topico');
      const topicoSeq = topicoSelect.value;
      const topicoText = topicoSelect.options[topicoSelect.selectedIndex]?.text || '';
      const horas = document.getElementById('block-horas').value;
      const prioridade = document.getElementById('block-prioridade').value;

      if (!disciplina || !topicoSeq) {
        showNotification('Selecione uma disciplina e um tópico.', 'error');
        return;
      }

      const blockData = {
        Data: getCorrectDateForDayOfWeek(document.getElementById('block-dia').value),
        DiaSemana: document.getElementById('block-dia').value,
        Periodo: document.getElementById('block-periodo').value,
        Disciplina: disciplina,
        TopicosSugeridos: topicoText,
        Horas: horas,
        Concluido: 'Não', // Sempre assume 'Não' ao criar/editar
        Prioridade: prioridade,
        ID_Topico: topicoSeq,
        ID_Disciplina: disciplina
      };

      // MODIFICADO: Agora verifica se estamos editando a partir do índice (do calendário mensal)
      if (window.editingBlockIndex !== undefined && window.editingBlockIndex !== null) {
        // Atualiza o item existente no array de dados
        window.agendaData[window.editingBlockIndex] = { ...window.agendaData[window.editingBlockIndex], ...blockData };
        generateCalendar(); // Redesenha o calendário
        saveAgenda(); // Salva
        showNotification('Bloco atualizado com sucesso!');
        window.editingBlockIndex = null; // Limpa o índice de edição

      } else if (window.editingBlockId) {
        // Lógica antiga para a visão semanal
        updateExistingBlock(window.editingBlockId, blockData);

      } else {
        // Adicionar novo bloco (visão semanal)
        addBlockToSlot(blockData);
      }

      closeBlockModal();
    }

    function addBlockToSlot(blockData) {
      const slot = document.getElementById(`slot-${blockData.DiaSemana}-${blockData.Periodo}`);
      if (slot) {
        const blockHTML = generateStudyBlock(blockData);
        slot.innerHTML += blockHTML;
        updateAgendaData();
        showNotification('Bloco adicionado com sucesso!');
      }
    }

    function generateStudyBlock(blockData) {
      const blockId = `block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

      // --- INÍCIO DA SOLUÇÃO DEFINITIVA ---
      let topicId = null;

      // 1. A ESTRATÉGIA PRINCIPAL: Extrair o ID diretamente do texto 'TopicosSugeridos'.
      //    Isso funciona mesmo que a coluna ID_Topico não seja carregada pela planilha.
      if (blockData.TopicosSugeridos && blockData.TopicosSugeridos.includes(' - ')) {
        topicId = blockData.TopicosSugeridos.split(' - ')[0].trim();
      }

      // 2. Se, por algum motivo, o texto não contiver o ID, exibe um erro claro.
      if (!topicId) {
        return `<div class="study-block" style="border-left-color: red !important; background: #333; color: white; padding: 10px;">
                    <strong style="color: #ffbaba;">Erro de Dados!</strong>
                    <p style="font-size: 0.8rem; margin: 5px 0 0 0;">Não foi possível extrair o ID do Tópico do texto: "${blockData.TopicosSugeridos || 'vazio'}".</p>
                </div>`;
      }

      const topic = allTopics.find(t => t.Seq == topicId) || {};
      const isEstudoConcluido = topic['Status Estudo'] === 'Concluído';
      const isQuestoesConcluido = topic['Status Questões'] === 'Concluído';
      const isFlashcardsConcluido = topic['Status Flashcards'] === 'Concluído';
      const revisaoCount = topic['Revisao Count'] || 0;

      const isNewTopic = blockData.Prioridade === 'Alta';
      const visualIndicator = isNewTopic
        ? `<span style="color: #4CAF50;"><i class="fas fa-star fa-fw"></i> NOVO</span>`
        : `<span style="color: #FFC107;"><i class="fas fa-sync-alt fa-fw"></i> REVISÃO</span>`;
      // --- FIM DA SOLUÇÃO DEFINITIVA ---

      return `
      <div class="study-block" 
            onclick="handleMobileBlockClick(event, '${blockId}')"
            id="${blockId}"
            data-disciplina="${blockData.Disciplina}"
            data-topico="${topicId}"
            data-horas="${blockData.Horas}"
            data-prioridade="${blockData.Prioridade}"
            draggable="true"
            ondragstart="dragStartHandler(event)"
            style="background: #1a1a1a; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 5px solid ${getPriorityColor(blockData.Prioridade)}; cursor: move;">
            
            <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <strong style="color: #F7EF8A; font-size: 0.9rem;">${blockData.Disciplina}</strong>
                        <span style="font-size: 0.75rem; font-weight: bold; margin-left: auto;">${visualIndicator}</span>
                    </div>
                    <!-- Adicionada uma classe para busca segura -->
                    <div class="agenda-block-title" style="font-size: 0.8rem; color: #fff;">${blockData.TopicosSugeridos}</div>
                </div>
                <button onclick="event.stopPropagation(); deleteBlock('${blockId}')" class="delete-block" title="Excluir Bloco">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>

            <div class="quick-controls" onclick="event.stopPropagation()" style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #444; display: flex; justify-content: space-around; align-items: center;">
                <div class="quick-checkbox ${isEstudoConcluido ? 'checked-estudo' : ''}" title="Estudo" onclick="quickToggleEstudo('${topicId}', this)">${isEstudoConcluido ? '✓' : ''}</div>
                <div class="quick-revisao-counter ${revisaoCount > 0 ? 'has-revisoes' : ''}" title="Revisões" onclick="openRevisaoPopup('${topicId}', ${revisaoCount})">${revisaoCount}</div>
                <div class="quick-checkbox ${isQuestoesConcluido ? 'checked-questoes' : ''}" title="Questões" onclick="quickToggleQuestoes('${topicId}', this)">${isQuestoesConcluido ? '✓' : ''}</div>
                <div class="quick-checkbox ${isFlashcardsConcluido ? 'checked-flashcards' : ''}" title="Flashcards" onclick="quickToggleFlashcards('${topicId}', this)">${isFlashcardsConcluido ? '✓' : ''}</div>
            </div>
        </div>
    `;
    }

    function getPriorityColor(prioridade) {
      switch (prioridade) {
        case 'Alta': return '#ff4444';
        case 'Média': return '#ffaa00';
        case 'Baixa': return '#44ff44';
        default: return '#D2AC47';
      }
    }
    function getCorrectDateForDayOfWeek(dayName) {
      const weekdays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
      const targetDayIndex = weekdays.indexOf(dayName);

      const today = new Date();
      const todayIndex = today.getDay(); // Domingo é 0, Segunda é 1...

      // Calcula a data da Segunda-feira desta semana
      const monday = new Date(today);
      const diffToMonday = todayIndex === 0 ? -6 : 1 - todayIndex;
      monday.setDate(today.getDate() + diffToMonday);

      // Calcula a data final somando os dias a partir de Segunda-feira
      const targetDate = new Date(monday);
      targetDate.setDate(monday.getDate() + (targetDayIndex - 1)); // -1 porque Segunda é o dia 0 no nosso cálculo

      // Formata a data como YYYY-MM-DD
      return targetDate.toISOString().split('T')[0];
    }
    // ==================== SISTEMA DRAG & DROP ====================

    function loadExistingBlocks() {
      if (window.agendaData && window.agendaData.length > 0) {
        window.agendaData.forEach(item => {
          const slot = document.getElementById(`slot-${item.DiaSemana}-${item.Periodo}`);
          if (slot) {
            const blockHTML = generateStudyBlock(item);
            slot.innerHTML += blockHTML;
          }
        });
      }
    }

    function dragStartHandler(event) {
      event.dataTransfer.setData('text/plain', event.target.id);
      event.target.style.opacity = '0.4';
    }

    function dragOverHandler(event) {
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function dragLeaveHandler(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function dropHandler(event) {
      event.preventDefault();
      const data = event.dataTransfer.getData('text/plain');
      const draggedElement = document.getElementById(data);
      const dropZone = event.currentTarget.querySelector('.slot-content');

      if (draggedElement && dropZone) {
        dropZone.appendChild(draggedElement);
        draggedElement.style.opacity = '1';
        event.currentTarget.classList.remove('drag-over');

        updateAgendaData();
        showNotification('Bloco movido com sucesso!');
      }
    }

    // ==================== GESTÃO DE BLOCO ====================

    function editBlock(blockId) {
      const block = document.getElementById(blockId);
      const disciplina = block.dataset.disciplina;
      const topico = block.dataset.topico;
      const horas = block.dataset.horas;
      const prioridade = block.dataset.prioridade;

      // Encontrar dia e período atual do bloco
      const slot = block.closest('.time-slot');
      const day = slot?.dataset.day;
      const period = slot?.dataset.period;

      if (!day || !period) return;

      window.currentBlockDay = day;
      window.currentBlockPeriod = period;
      window.editingBlockId = blockId;

      document.getElementById('block-modal-title').innerHTML = '<i class="fas fa-edit"></i> Editar Bloco de Estudo';
      document.getElementById('block-modal').style.display = 'flex';

      // Preencher formulário
      document.getElementById('block-disciplina').value = disciplina;
      populateTopicDropdown(disciplina);

      // Aguardar carregamento dos tópicos
      setTimeout(() => {
        document.getElementById('block-topico').value = topico;
        document.getElementById('block-horas').value = horas;
        document.getElementById('block-prioridade').value = prioridade;
      }, 100);
    }

    function updateExistingBlock(blockId, newData) {
      const block = document.getElementById(blockId);
      if (block) {
        const newBlockHTML = generateStudyBlock(newData);
        block.outerHTML = newBlockHTML;
        updateAgendaData();
        showNotification('Bloco atualizado com sucesso!');
      }
    }

    function deleteBlock(blockId) {
      showConfirm('Deseja excluir este bloco de estudo?', (confirmed) => {
        if (confirmed) {
          const block = document.getElementById(blockId);
          if (block) {
            block.remove(); // Remove imediatamente da interface
            updateAgendaData(); // Atualiza os dados no window.agendaData
            showNotification('Bloco excluído com sucesso!');
          }
        }
      });
    }
    function deleteAgendaItem(itemIndex) {
      // Pede confirmação ao usuário antes de deletar
      showConfirm('Deseja excluir este bloco de estudo do calendário?', (confirmed) => {
        if (confirmed) {
          // Remove o item do array de dados da agenda usando seu índice
          window.agendaData.splice(itemIndex, 1);

          // Redesenha o calendário mensal para refletir a remoção
          generateCalendar();

          // Salva a alteração na planilha
          saveAgenda();

          showNotification('Bloco excluído com sucesso do calendário!');
        }
      });
    }

    function editAgendaItem(itemIndex) {
      // Guarda o índice do item que estamos editando
      window.editingBlockIndex = itemIndex;
      const blockData = window.agendaData[itemIndex];

      if (!blockData) {
        showNotification('Erro: Bloco de estudo não encontrado.', 'error');
        return;
      }

      // Abre o modal de edição
      document.getElementById('block-modal-title').innerHTML = '<i class="fas fa-edit"></i> Editar Bloco de Estudo';
      document.getElementById('block-modal').style.display = 'flex';

      // Preenche o formulário com os dados do bloco selecionado
      document.getElementById('block-dia').value = blockData.DiaSemana;
      document.getElementById('block-periodo').value = blockData.Periodo;
      document.getElementById('block-disciplina').value = blockData.Disciplina;

      // Carrega os tópicos corretos para a disciplina
      populateTopicDropdown(blockData.Disciplina);

      setTimeout(() => {
        document.getElementById('block-topico').value = blockData.ID_Topico;
        document.getElementById('block-horas').value = blockData.Horas;
        document.getElementById('block-prioridade').value = blockData.Prioridade;
      }, 100); // Um pequeno atraso para garantir que os tópicos foram carregados
    }
    // ==================== CONCLUSÃO INTEGRADA ====================

    async function toggleConcluido(blockId) {
      const block = document.getElementById(blockId);
      const isConcluido = block.querySelector('input[type="checkbox"]').checked;
      const topicoSeq = block.dataset.topico;

      block.classList.toggle('concluido', isConcluido);

      // Integração com sistema principal
      if (isConcluido && topicoSeq) {
        await updateTopicCompletion(topicoSeq);
      }

      updateAgendaData();
    }

    async function updateTopicCompletion(sequence) {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }

      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "update");
        if (SHEET_ID) params.append("spreadsheetId", SHEET_ID);
        params.append("userEmail", currentUserName);
        params.append("sequence", sequence);
        params.append("statusEstudo", "Concluído");
        params.append("dataEstudo", new Date().toISOString().split('T')[0]);

        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        // Recarregar dados para atualizar estatísticas
        await loadAllData();
        showNotification('Tópico marcado como concluído no sistema!');

      } catch (error) {
        console.error('Erro ao atualizar tópico:', error);
        showNotification('Erro ao atualizar tópico.', 'error');
      }
    }

    // ==================== ATUALIZAÇÃO DE DADOS ====================

    function updateAgendaData() {
      const agendaData = [];
      const days = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
      const periods = ['Manhã', 'Tarde', 'Noite'];

      days.forEach(day => {
        periods.forEach(period => {
          const slot = document.getElementById(`slot-${day}-${period}`);
          if (slot) {
            const blocks = slot.querySelectorAll('.study-block');
            blocks.forEach(block => {
              const concluido = block.classList.contains('concluido');
              const topicoSeq = block.dataset.topico;

              // Busca o elemento do título de forma segura usando uma classe
              const topicoElement = block.querySelector('.agenda-block-title');
              const topicoNome = topicoElement ? topicoElement.textContent : '';

              agendaData.push({
                Data: getCorrectDateForDayOfWeek(day),
                DiaSemana: day,
                Periodo: period,
                Disciplina: block.dataset.disciplina,
                TopicosSugeridos: topicoNome,
                Horas: block.dataset.horas,
                Concluido: concluido ? 'Sim' : 'Não',
                Prioridade: block.dataset.prioridade,
                ID_Topico: topicoSeq,
                ID_Disciplina: block.dataset.disciplina
              });
            });
          }
        });
      });

      window.agendaData = agendaData;
    }
    // Função atualizada para aceitar modo 'weekly' ou 'daily'
    // Função atualizada para aceitar modo 'weekly' ou 'daily' (CORRIGIDA)
    async function generateAutoAgenda(mode = 'weekly') {
      // Feedback visual via notificação (removemos a dependência do botão antigo para evitar erro)
      if (mode === 'daily') {
        showNotification('Gerando agenda para hoje...', 'success');
      } else {
        showNotification('Gerando agenda semanal...', 'success');
      }

      try {
        // Se for modo semanal, limpa tudo.
        if (mode === 'weekly') {
          document.querySelectorAll('.slot-content').forEach(slot => slot.innerHTML = '');
        }

        const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');
        const diasSemanaConfig = parseInt(config.diasSemana || '5');
        const topicosDiaConfig = parseInt(config.topicosDia || '0');
        const focoPrincipalConfig = config.focoPrincipal || 'balanceado';
        const baseAgendaConfig = config.baseAgenda || 'meta-diaria-topicos';
        const distribuicaoConfig = config.distribuicao || 'igual';
        const periodosConfig = config.periodos || ['manha', 'tarde', 'noite'];
        const baseRevisaoConfig = config.baseRevisao || '1';

        const deadlineDate = currentUserGoals['Meta Data Conclusão']
          ? new Date(currentUserGoals['Meta Data Conclusão'])
          : (globalMetas['Data_Prova'] ? new Date(globalMetas['Data_Prova'].value) : null);
        if (deadlineDate) {
          deadlineDate.setHours(23, 59, 59, 999);
        }

        const today = new Date();
        const weekdays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
        const todayName = weekdays[today.getDay()];

        // Lógica para definir quais dias vamos preencher
        let diasParaPreencher = [];

        if (mode === 'daily') {
          // Se for diário, preenchemos APENAS o dia de hoje
          diasParaPreencher = [todayName];
        } else {
          // Se for semanal, lógica original
          const todayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
          const todosOsDiasDaSemana = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
          const diasDeEstudoConfigurados = todosOsDiasDaSemana.slice(0, diasSemanaConfig);
          diasParaPreencher = diasDeEstudoConfigurados.filter((_, index) => index >= todayIndex);
        }

        if (diasParaPreencher.length === 0) {
          showNotification('Não há dias configurados para gerar nesta seleção.', 'error');
          return;
        }

        const availableSlots = [];
        diasParaPreencher.forEach(day => {
          if (periodosConfig.includes('manha')) availableSlots.push({ dia: day, periodo: 'Manhã' });
          if (periodosConfig.includes('tarde')) availableSlots.push({ dia: day, periodo: 'Tarde' });
          if (periodosConfig.includes('noite')) availableSlots.push({ dia: day, periodo: 'Noite' });
        });

        if (availableSlots.length === 0) {
          showNotification('Nenhum slot disponível nos períodos selecionados.', 'error');
          return;
        }

        // Cálculo de metas
        let newTopicsTarget = 0;
        // CORREÇÃO: Se o foco for 'revisao', forçamos a meta de novos tópicos a ser 0, 
        // ignorando as médias do Raio X para conteúdo novo.
        if (baseAgendaConfig !== 'nenhum' && focoPrincipalConfig !== 'revisao') {
          newTopicsTarget = getDailyStudyTarget(baseAgendaConfig, topicosDiaConfig, diasSemanaConfig);
        }

        let revisionTarget = 0;
        switch (baseRevisaoConfig) {
          case 'srs':
            revisionTarget = getTopicsForSrsReview(deadlineDate).length;
            break;
          case 'medias-recomendadas-revisao':
            const diasParaProva = globalMetas['Dias_p_Prova']?.value || 0;
            const totalRevisoes = globalMetas['Total_Temas_Revisao_Edital']?.value || totalTopics;
            if (diasParaProva > 0) revisionTarget = Math.ceil(totalRevisoes / diasParaProva);
            break;
          case 'medias-personalizadas-revisao':
            const mediasPersonalizadas = calcularMediasPersonalizadas();
            revisionTarget = Math.ceil(parseFloat(mediasPersonalizadas.mediaRevisoesPersonalizada) || 0);
            break;
          default:
            revisionTarget = parseInt(baseRevisaoConfig) || 0;
            break;
        }

        if (focoPrincipalConfig === 'chico-concursos') {
          const totalDailyBlocks = newTopicsTarget + revisionTarget;
          const studyPhase = calculateStudyPhase();
          let newContentProportion = 0.5;
          if (studyPhase === '0-50') newContentProportion = 0.75;
          if (studyPhase === '75-100') newContentProportion = 0.25;
          if (studyPhase === '100+') newContentProportion = 0;
          newTopicsTarget = Math.floor(totalDailyBlocks * newContentProportion);
          revisionTarget = Math.ceil(totalDailyBlocks * (1 - newContentProportion));
        }

        const { newTopics, reviewTopics } = prepareTopicsForScheduling(focoPrincipalConfig, distribuicaoConfig, allTopics, globalMetas, deadlineDate);

        const multiplier = diasParaPreencher.length;
        const totalNewTopicsToSchedule = newTopicsTarget * multiplier;
        let totalRevisionsToSchedule = 0;

        if (baseRevisaoConfig === 'srs') {
          totalRevisionsToSchedule = mode === 'daily' ? Math.min(revisionTarget, 15) : revisionTarget;
        } else {
          totalRevisionsToSchedule = revisionTarget * multiplier;
        }

        if (mode === 'daily') {
          diasParaPreencher.forEach(day => {
            ['Manhã', 'Tarde', 'Noite'].forEach(p => {
              const slot = document.getElementById(`slot-${day}-${p}`);
              if (slot) slot.innerHTML = '';
            });
          });
          window.agendaData = window.agendaData.filter(item => item.DiaSemana !== todayName);
        }

        const newAgendaItems = [];
        let currentSlotIndex = 0;

        for (let i = 0; i < totalNewTopicsToSchedule && i < newTopics.length; i++) {
          const topic = newTopics[i];
          const targetSlot = availableSlots[currentSlotIndex % availableSlots.length];
          newAgendaItems.push({
            Data: getCorrectDateForDayOfWeek(targetSlot.dia), DiaSemana: targetSlot.dia, Periodo: targetSlot.periodo,
            Disciplina: topic.Disciplinas, TopicosSugeridos: `${topic.Seq} - ${topic.Tópicos}`,
            Horas: 1, Concluido: 'Não', Prioridade: 'Alta',
            ID_Topico: topic.Seq, ID_Disciplina: topic.Disciplinas
          });
          currentSlotIndex++;
        }

        for (let i = 0; i < totalRevisionsToSchedule && i < reviewTopics.length; i++) {
          const topic = reviewTopics[i];
          const targetSlot = availableSlots[currentSlotIndex % availableSlots.length];
          newAgendaItems.push({
            Data: getCorrectDateForDayOfWeek(targetSlot.dia), DiaSemana: targetSlot.dia, Periodo: targetSlot.periodo,
            Disciplina: topic.Disciplinas, TopicosSugeridos: `${topic.Seq} - ${topic.Tópicos}`,
            Horas: 1, Concluido: 'Não', Prioridade: 'Média',
            ID_Topico: topic.Seq, ID_Disciplina: topic.Disciplinas
          });
          currentSlotIndex++;
        }

        if (mode === 'weekly') {
          window.agendaData = newAgendaItems;
        } else {
          window.agendaData = [...window.agendaData, ...newAgendaItems];
        }

        loadExistingBlocks();
        showNotification(mode === 'daily' ? 'Agenda de hoje gerada!' : 'Agenda semanal gerada!', 'success');

      } catch (error) {
        console.error('Erro:', error);
        showNotification(`Erro: ${error.message}`, 'error');
      }
    }

    // --- NOVA FUNÇÃO: RESGATAR PENDÊNCIAS ---
    function reschedulePendingFromYesterday() {
      if (!window.agendaData || window.agendaData.length === 0) {
        showNotification('Não há dados na agenda para verificar.', 'error');
        return;
      }

      showConfirm('Deseja mover todas as matérias não concluídas de ONTEM para HOJE?', (confirmed) => {
        if (confirmed) {
          const today = new Date();
          const yesterday = new Date(today);
          yesterday.setDate(today.getDate() - 1);

          const weekdays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
          const todayName = weekdays[today.getDay()];
          const yesterdayName = weekdays[yesterday.getDay()];

          let moveCount = 0;

          // Percorre a agenda procurando itens de ontem não concluídos
          window.agendaData.forEach(item => {
            // Verifica se é de ontem (pelo dia da semana ou data se disponível)
            const isFromYesterday = item.DiaSemana === yesterdayName;

            if (isFromYesterday && item.Concluido !== 'Sim') {
              // Atualiza para hoje
              item.DiaSemana = todayName;
              item.Data = getCorrectDateForDayOfWeek(todayName);
              item.Prioridade = 'Alta'; // Aumenta prioridade pois está atrasado
              // Opcional: Adicionar um marcador visual no título
              if (!item.TopicosSugeridos.includes('(Atrasado)')) {
                item.TopicosSugeridos += ' (Atrasado)';
              }
              moveCount++;
            }
          });

          if (moveCount > 0) {
            // Limpa a visualização atual e recarrega
            document.querySelectorAll('.slot-content').forEach(slot => slot.innerHTML = '');
            loadExistingBlocks();
            showNotification(`${moveCount} itens atrasados movidos para hoje!`, 'success');
            saveAgenda(); // Salva automaticamente
          } else {
            showNotification('Nenhuma pendência de ontem encontrada.', 'warning');
          }
        }
      });
    }
    // ==================== FUNÇÕES DE GESTÃO ====================


    // ========================================================================
    // INÍCIO DA NOVA FUNÇÃO INTELIGENTE generateAutoAgenda (VERSÃO FINAL E CORRIGIDA)
    // ========================================================================
    function prepareTopicsForScheduling(focoPrincipalConfig, distribuicaoConfig, allTopics, globalMetas, deadlineDate) { // <-- PARÂMETRO NOVO AQUI
      const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');
      const excludedDiscipline = config.excludeDisciplina || '';

      const availableTopics = excludedDiscipline
        ? allTopics.filter(t => t.Disciplinas !== excludedDiscipline)
        : allTopics;

      let topicsToStudy = availableTopics.filter(t => t['Status Estudo'] !== 'Concluido');

      const baseRevisaoConfig = config.baseRevisao || '1';
      let topicsToReviewOriginal = [];

      if (baseRevisaoConfig === 'srs') {
        // Agora passamos o deadline para a função do SRS
        topicsToReviewOriginal = getTopicsForSrsReview(deadlineDate);
      } else {
        topicsToReviewOriginal = availableTopics.filter(t => t['Status Estudo'] === 'Concluído' && (parseInt(t['Revisao Count']) || 0) < 4);
      }

      // ... (o resto da função, com a lógica de small/large topics e applyDisciplineDistribution, permanece exatamente igual) ...
      const SMALL_TOPIC_PAGES_THRESHOLD = 5;
      let smallReviewTopics = topicsToReviewOriginal.filter(t => (parseInt(t['N. de Páginas']) || 0) < SMALL_TOPIC_PAGES_THRESHOLD);
      let largeReviewTopics = topicsToReviewOriginal.filter(t => (parseInt(t['N. de Páginas']) || 0) >= SMALL_TOPIC_PAGES_THRESHOLD);

      smallReviewTopics.sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq));
      largeReviewTopics.sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq));

      let topicsToReview = [];
      let smallIdx = 0;
      let largeIdx = 0;

      while (smallIdx < smallReviewTopics.length || largeIdx < largeReviewTopics.length) {
        for (let i = 0; i < 2 && smallIdx < smallReviewTopics.length; i++) {
          topicsToReview.push(smallReviewTopics[smallIdx++]);
        }
        if (largeIdx < largeReviewTopics.length) {
          topicsToReview.push(largeReviewTopics[largeIdx++]);
        }
      }
      while (smallIdx < smallReviewTopics.length) {
        topicsToReview.push(smallReviewTopics[smallIdx++]);
      }
      while (largeIdx < largeReviewTopics.length) {
        topicsToReview.push(largeReviewTopics[largeIdx++]);
      }

      function applyDisciplineDistribution(topics, distributionType) {
        const disciplines = [...new Set(topics.map(t => t.Disciplinas).filter(d => d))];
        let distributedTopics = [];

        if (distributionType === 'igual') {
          distributedTopics = [...topics].sort(() => Math.random() - 0.5);
        } else if (distributionType === 'peso') {
          const disciplineWeights = {};
          disciplines.forEach(d => {
            const cleanDiscName = d.replace(/[^a-zA-Z0-9çãáéíóúâêôõüÇÃÁÉÍÓÚÂÊÔÕÜ\s]/g, '').replace(/ /g, '_');
            disciplineWeights[d] = parseInt(globalMetas[cleanDiscName]?.value || 0);
          });

          disciplines.sort((a, b) => disciplineWeights[b] - disciplineWeights[a]);

          let disciplineQueues = {};
          disciplines.forEach(d => disciplineQueues[d] = topics.filter(t => t.Disciplinas === d).sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq)));

          let allQueuesEmpty = false;
          let currentDisciplineIndex = 0;
          while (!allQueuesEmpty) {
            allQueuesEmpty = true;
            const currentDisc = disciplines[currentDisciplineIndex];
            if (disciplineQueues[currentDisc] && disciplineQueues[currentDisc].length > 0) {
              distributedTopics.push(disciplineQueues[currentDisc].shift());
              allQueuesEmpty = false;
            }
            currentDisciplineIndex = (currentDisciplineIndex + 1) % disciplines.length;

            if (allQueuesEmpty) {
              allQueuesEmpty = Object.values(disciplineQueues).every(queue => queue.length === 0);
            }
          }
        } else {
          distributedTopics = [...topics].sort(() => Math.random() - 0.5);
        }
        return distributedTopics;
      }

      topicsToStudy = applyDisciplineDistribution(topicsToStudy, distribuicaoConfig);
      topicsToReview = applyDisciplineDistribution(topicsToReview, distribuicaoConfig);

      let finalNewTopics = [];
      let finalReviewTopics = [];

      if (focoPrincipalConfig === 'novos') {
        finalNewTopics = topicsToStudy;
        finalReviewTopics = topicsToReview.slice(0, Math.ceil(topicsToReview.length * 0.15));
      } else if (focoPrincipalConfig === 'revisao') {
        finalReviewTopics = topicsToReview;
        finalNewTopics = topicsToStudy.slice(0, Math.ceil(topicsToStudy.length * 0.15));
      } else if (focoPrincipalConfig === 'balanceado' || focoPrincipalConfig === 'chico-concursos') {
        finalNewTopics = topicsToStudy;
        finalReviewTopics = topicsToReview;
      } else if (focoPrincipalConfig === 'questoes') {
        finalReviewTopics = topicsToReview.filter(t => t['Status Questões'] !== 'Concluído' && t['Status Estudo'] === 'Concluído');
        finalNewTopics = topicsToStudy.filter(t => t['Status Questões'] !== 'Concluido');
        finalNewTopics.sort(() => Math.random() - 0.5);
        finalReviewTopics.sort(() => Math.random() - 0.5);
      }

      return { newTopics: finalNewTopics || [], reviewTopics: finalReviewTopics || [] };
    }

    // ========================================================================
    // FIM DA NOVA FUNÇÃO INTELIGENTE
    // ========================================================================

    function addNewBlock() {
      openBlockModal('Segunda', 'Manhã');
    }

    function clearAgenda() {
      showConfirm('Deseja limpar toda a agenda? Esta ação não pode ser desfeita.', (confirmed) => {
        if (confirmed) {
          const slots = document.querySelectorAll('.slot-content');
          slots.forEach(slot => {
            slot.innerHTML = '';
          });
          window.agendaData = [];
          saveAgenda();
          showNotification('Agenda limpa com sucesso!');
        }
      });
    }

    async function saveAgenda() {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }

      const button = document.querySelector('.btn-save');
      // Proteção caso o botão não exista na tela atual
      const originalText = button ? button.innerHTML : '';
      if (button) button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

      try {
        // 1. Atualiza a memória local com o estado atual da tela
        updateAgendaData();

        // 2. Prepara os dados
        const payload = {
          userEmail: currentUserName,
          agenda: window.agendaData // O SyncManager vai converter para string automaticamente
        };

        // 3. Envia para o Gerente de Sincronização
        // Ele decide se manda agora (online) ou guarda (offline)
        SyncManager.enqueue("updateAgenda", payload, null);

        // Feedback imediato visual (Otimista)
        if (button) {
          button.innerHTML = '<i class="fas fa-check"></i> Salvo';
          setTimeout(() => { button.innerHTML = originalText; }, 2000);
        }
        showNotification('Agenda salva com sucesso!', 'success');

      } catch (error) {
        console.error('Erro ao processar agenda:', error);
        showNotification('Erro interno ao salvar agenda.', 'error');
        if (button) button.innerHTML = originalText;
      }
    }

    // ==================== ABA MENSAL ====================

    function generateMonthlyView() {
      // Variáveis para controle do mês exibido
      if (window.currentMonth === undefined) window.currentMonth = new Date().getMonth(); // Use new Date() para obter o mês atual inicialmente
      if (window.currentYear === undefined) window.currentYear = new Date().getFullYear();
      const monthName = new Date(window.currentYear, window.currentMonth).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
      return `
        <div class="monthly-agenda">
          <div class="calendar-header" style="text-align: center; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 15px;">
            <button onclick="changeMonth(-1)" style="background: #333; border: 1px solid #555; color: #F7EF8A; padding: 5px 10px; border-radius: 5px; cursor: pointer;"><</button>
            <h3 style="color: #F7EF8A; margin: 0;">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</h3>
            <button onclick="changeMonth(1)" style="background: #333; border: 1px solid #555; color: #F7EF8A; padding: 5px 10px; border-radius: 5px; cursor: pointer;">></button>
          </div>
          <div class="calendar-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
            <div class="stat-card" style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.9rem; color: #fff;">Horas Programadas</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #F7EF8A;" id="monthly-hours">0h</div>
            </div>
            <div class="stat-card" style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.9rem; color: #fff;">Blocos Concluídos</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #4CAF50;" id="monthly-completed">0</div>
            </div>
            <div class="stat-card" style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.9rem; color: #fff;">Disciplinas</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #2196F3;" id="monthly-disciplines">0</div>
            </div>
            <div class="stat-card" style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.9rem; color: #fff;">Dias de Estudo</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #FFC107;" id="monthly-days">0</div>
            </div>
          </div>
            <div class="calendar-grid" id="monthly-calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
              <!-- Calendário será gerado aqui -->
          </div>
      `;
    }

    async function initializeMonthlyView() {
      // Garante que os dados da agenda estejam carregados
      if (!window.agendaData || window.agendaData.length === 0) {
        await loadAgendaData();
      }

      // Verifica se já temos um mês/ano selecionado, se não, define o padrão
      if (window.currentMonth === undefined) {
        // Se há dados na agenda, define o mês/ano para o primeiro evento encontrado
        if (window.agendaData && window.agendaData.length > 0) {
          const dateParts = window.agendaData[0].Data.split('-'); // Separa a data em ano, mês e dia
          const firstEventDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); // Cria a data ignorando o fuso horário
          window.currentMonth = firstEventDate.getMonth();
          window.currentYear = firstEventDate.getFullYear();
        } else {
          // Se não há dados, define para o mês/ano atual
          const today = new Date();
          window.currentMonth = today.getMonth();
          window.currentYear = today.getFullYear();
        }
      }

      // Agora, com o mês e ano corretos definidos, redesenha a view
      document.getElementById('agenda-content').innerHTML = generateMonthlyView();
      generateCalendar();
      calculateMonthlyStats();
    }

    function generateCalendar() {
      const today = new Date();
      const year = window.currentYear;
      const month = window.currentMonth;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();

      const calendarGrid = document.getElementById('monthly-calendar');
      if (!calendarGrid) return;

      let calendarHTML = '';

      const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
      weekdays.forEach(day => {
        calendarHTML += `<div class="weekday-header" style="text-align: center; font-weight: bold; color: #F7EF8A; padding: 10px; background: #333; border-radius: 4px;">${day}</div>`;
      });

      for (let i = 0; i < firstDay.getDay(); i++) {
        calendarHTML += `<div class="empty-day" style="background: #111; border-radius: 4px; min-height: 80px;"></div>`;
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        // Encontra os itens e seus índices originais
        const dayAgendaWithIndices = window.agendaData.map((item, index) => ({ item, index }))
          .filter(({ item }) => item.Data === dateStr);

        const hasStudies = dayAgendaWithIndices.length > 0;
        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();

        calendarHTML += `
          <div class="calendar-day ${isToday ? 'today' : ''} ${hasStudies ? 'has-studies' : ''}" 
               style="background: ${isToday ? '#333' : '#222'}; border-radius: 4px; min-height: 80px; padding: 5px; border: 1px solid #444; position: relative; display: flex; flex-direction: column; gap: 4px;">
            <div style="font-weight: bold; color: ${isToday ? '#F7EF8A' : '#fff'};">${day}</div>
            <div class="day-studies" style="font-size: 0.75rem; flex-grow: 1;">
              ${dayAgendaWithIndices.map(({ item, index }) => `
                <div style="background: #3a3a3a; color: #fff; margin-top: 2px; padding: 4px; border-radius: 3px; border-left: 3px solid ${getPriorityColor(item.Prioridade)};">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.TopicosSugeridos}">
                      ${item.Disciplina} (${item.Horas}h)
                    </span>
                    <div style="display: flex; gap: 3px;">
                      <button onclick="editAgendaItem(${index})" style="background:none; border:none; color:#D2AC47; cursor:pointer; font-size: 0.8rem; padding: 2px;"><i class="fas fa-pencil-alt"></i></button>
                      <button onclick="deleteAgendaItem(${index})" style="background:none; border:none; color:#ff4444; cursor:pointer; font-size: 0.8rem; padding: 2px;"><i class="fas fa-trash-alt"></i></button>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      calendarGrid.innerHTML = calendarHTML;
    }

    function calculateMonthlyStats() {
      if (!window.agendaData) return;

      const monthlyHours = window.agendaData.reduce((total, item) => total + parseFloat(item.Horas || 0), 0);
      const completedBlocks = window.agendaData.filter(item => item.Concluido === 'Sim').length;
      const uniqueDisciplines = [...new Set(window.agendaData.map(item => item.Disciplina))].length;
      const studyDays = [...new Set(window.agendaData.map(item => item.Data))].length;

      document.getElementById('monthly-hours').textContent = `${monthlyHours}h`;
      document.getElementById('monthly-completed').textContent = completedBlocks;
      document.getElementById('monthly-disciplines').textContent = uniqueDisciplines;
      document.getElementById('monthly-days').textContent = studyDays;
    }

    // ==================== ABA CONFIGURAÇÕES ====================


    // >>>>> INÍCIO DA NOVA FUNÇÃO <<<<<
    function updateConfigUI() {
      const focoPrincipal = document.getElementById('config-foco-principal').value;
      const isChicoMethod = focoPrincipal === 'chico-concursos';

      // >>>>> LÓGICA ANTIGA DE DESABILITAR FOI REMOVIDA DAQUI <<<<<

      // Mostra ou esconde a mensagem de ajuda
      const helperText = document.getElementById('chico-helper');
      if (helperText) {
        helperText.style.display = isChicoMethod ? 'block' : 'none';
      }

      // Lógica para mostrar/esconder a barra de progresso
      const progressBarContainer = document.getElementById('chico-progress-bar-container');
      if (progressBarContainer) {
        if (isChicoMethod) {
          progressBarContainer.style.display = 'flex';
          updateChicoProgressBar();
        } else {
          progressBarContainer.style.display = 'none';
        }
      }
    }
    // >>>>> FIM DA NOVA FUNÇÃO <<<<<
    // >>>>> INÍCIO DA NOVA FUNÇÃO PARA A BARRA DE PROGRESSO <<<<<
    function updateChicoProgressBar() {
      const container = document.getElementById('chico-progress-bar-container');
      if (!container) return; // Se o elemento não existir, para aqui.

      const totalDailyHours = parseFloat(document.getElementById('config-horas-dia').value) || 0;
      if (totalDailyHours === 0) {
        container.style.display = 'none'; // Esconde se não houver horas
        return;
      }

      const studyPhase = calculateStudyPhase();
      const { newContentHours, reviewHours } = allocateDailyStudyHours(totalDailyHours, studyPhase);

      const newContentPercent = (newContentHours / totalDailyHours) * 100;
      const reviewPercent = 100 - newContentPercent;

      const newContentSegment = document.getElementById('new-content-segment');
      const reviewSegment = document.getElementById('review-segment');

      // Atualiza a largura das barras
      newContentSegment.style.width = `${newContentPercent}%`;
      reviewSegment.style.width = `${reviewPercent}%`;

      // Atualiza o texto dentro das barras
      newContentSegment.textContent = formatarHoras(newContentHours);
      reviewSegment.textContent = formatarHoras(reviewHours);

      // Atualiza os tooltips (texto que aparece ao passar o mouse)
      newContentSegment.title = `Conteúdo Novo: ${formatarHoras(newContentHours)} (${newContentPercent.toFixed(0)}%)`;
      reviewSegment.title = `Revisão: ${formatarHoras(reviewHours)} (${reviewPercent.toFixed(0)}%)`;
    }
    // >>>>> FIM DA NOVA FUNÇÃO <<<<<

    function generateConfigView() {
      // --- SEU NOVO CÓDIGO COMEÇA AQUI ---
      const disciplines = [...new Set(allTopics.map(topic => topic.Disciplinas).filter(d => d))];
      let disciplineOptions = '<option value="">Nenhuma</option>';
      disciplines.forEach(d => {
        disciplineOptions += `<option value="${d}">${d}</option>`;
      });
      // --- FIM DO NOVO CÓDIGO ---
      return `
        <div class="agenda-config">
        <h4 style="color: #F7EF8A; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">
            <i class="fas fa-cog"></i> Configurações da Agenda
        </h4>
        
        <div style="display: flex; gap: 20px; margin-bottom: 25px;">

            <!-- Coluna da Esquerda: Preferências -->
            <div class="config-section" style="flex: 1;">
            <h5 style="color: #D2AC47; margin-bottom: 15px;">📅 Preferências de Agendamento</h5>
            
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Dias de Estudo por Semana:</label>
                <input type="number" id="config-dias-semana" min="1" max="7" value="5" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            </div>
            
                            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Horas de Estudo por Dia:</label>
                <input type="number" id="config-horas-dia" min="1" max="12" value="4" oninput="updateChicoProgressBar()" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            </div>
                <!-- NOVO CAMPO: Tópicos Estudo por Dia -->
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Tópicos Estudo por Dia:</label>
                <input type="number" id="config-topicos-dia" min="0" value="0" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            </div>

            <!-- FIM NOVO CAMPO -->
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Períodos Preferidos:</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <label style="color: #fff; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="config-periodo-manha" checked> Manhã
                </label>
                <label style="color: #fff; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="config-periodo-tarde" checked> Tarde
                </label>
                <label style="color: #fff; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="config-periodo-noite"> Noite
                </label>
                </div>
            </div>
            </div>
            
            <!-- Coluna da Direita: Metas -->
            <div class="config-section" style="flex: 1;">
            <h5 style="color: #D2AC47; margin-bottom: 15px;">🎯 Metas de Estudo</h5>
            
                            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Foco Principal:</label>
                <!-- >>>>> LINHA MODIFICADA AQUI <<<<< -->
                <!-- NOVO CÓDIGO COM A DICA -->
<select id="config-foco-principal" onchange="updateConfigUI()" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
    <option value="novos">Novos Conteúdos</option>
    <option value="revisao">Revisão</option>
    <option value="balanceado">Balanceado</option>
    <option value="questoes">Resolução de Questões</option>
    <option value="chico-concursos" title="Método adaptativo que ajusta a proporção de conteúdo novo vs. revisão com base no seu percentual de progresso no edital.">Método Chico Concursos</option>
</select>
            </div>
            <!-- NOVO CAMPO: Base da Agenda -->
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Base Conteúdo (Médias):</label>
<select id="config-base-agenda" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
    <option value="nenhum">Nenhum Conteúdo Automático</option>
    <option value="meta-diaria-topicos">🎯 Meta Diária (Digitada)</option>
    <option value="medias-recomendadas">🧮 Médias Diárias Recomendadas (Edital)</option>
    <option value="medias-personalizadas">💪SUAS Médias Personalizadas</option>
</select>
            </div>
            <!-- FIM NOVO CAMPO -->
            
            <!-- NOVO CAMPO: Base da Revisão -->
      <div class="form-field" style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; color: #fff;">Base da Revisão Diária:</label>
        <!-- NOVO CÓDIGO COM A DICA -->
<select id="config-base-revisao" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
  <option value="0">Nenhuma Revisão Automática</option>
  <option value="1" selected>1 Revisão por Dia</option>
  <option value="2">2 Revisões por Dia</option>
  <option value="3">3 Revisões por Dia</option>
  <option value="srs" title="Agenda automaticamente os tópicos que precisam ser revisados hoje, com base na data do estudo, dificuldade e número de revisões já feitas (método Anki).">Sistema de Repetição Espaçada (Automático)</option>
  <option value="medias-recomendadas-revisao">📅 Médias Diárias Recomendadas (Raio X)</option>
  <option value="medias-personalizadas-revisao">💪 SUAS Médias Personalizadas (Raio X)</option>
</select>
        <!-- >>>>> MENSAGEM DE AJUDA ADICIONADA AQUI <<<<< -->
        <div id="chico-helper" class="chico-helper-text">
            Estes campos definem o <b>volume total</b> de blocos. O método aplicará a proporção dinâmica sobre este total.
        </div>
      </div>
        
        <!-- SEU NOVO CÓDIGO COMEÇA AQUI -->
            <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Excluir Disciplina da Geração:</label>
            <select id="config-exclude-disciplina" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            <!-- A MODIFICAÇÃO ESTÁ AQUI -->
            ${disciplineOptions}
                </select>
            </div>
            <!-- FIM DO NOVO CÓDIGO -->
        
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Distribuição por Disciplina:</label>
                <select id="config-distribuicao" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
                <option value="igual">Igual para Todas</option>
                <option value="peso">Por Peso no Edital</option>
                <option value="dificuldade">Por Dificuldade Pessoal</option>
                </select>
            </div>
            </div>
<!-- >>>>> INÍCIO DAS CONFIGURAÇÕES DO POMODORO <<<<< -->
    <div class="config-section" style="flex: 1;">
        <h5 style="color: #D2AC47; margin-bottom: 15px;">🍅 Configurações do Timer Pomodoro</h5>
        <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Tempo de Foco (minutos):</label>
            <input type="number" id="config-pomodoro-focus" min="5" max="60" value="25" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
        </div>
        <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Pausa Curta (minutos):</label>
            <input type="number" id="config-pomodoro-short-break" min="1" max="20" value="5" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
        </div>
        <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Pausa Longa (minutos):</label>
            <input type="number" id="config-pomodoro-long-break" min="10" max="45" value="15" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
        </div>
        <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Ciclos para Pausa Longa:</label>
            <input type="number" id="config-pomodoro-cycles" min="2" max="8" value="4" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
        </div>
    </div>
    <!-- >>>>> FIM DAS CONFIGURAÇÕES DO POMODORO <<<<< -->

  </div>
        </div>
        
        <div class="config-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn-modal-cancel" onclick="resetConfig()">Redefinir</button>
            <button class="btn-modal-confirm" onclick="saveConfig()">Salvar Configurações</button>
        </div>
        </div>
    `;
    }

    function initializeConfigView() {
      loadConfig();
      updateConfigUI(); // Atualiza a interface assim que abre
    }

    function loadConfig() {
      const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');

      // Carrega os valores salvos ou, se não existirem, busca das metas do usuário ou um padrão
      document.getElementById('config-dias-semana').value = config.diasSemana ?? (currentUserGoals['Meta Dias Estudo'] || '5');
      document.getElementById('config-horas-dia').value = config.horasDia ?? (currentUserGoals['Meta Horas Estudo'] || '4');
      document.getElementById('config-topicos-dia').value = config.topicosDia ?? (currentUserGoals['Meta Diária Tópicos'] || '0');

      document.getElementById('config-periodo-manha').checked = config.periodos?.includes('manha') ?? true;
      document.getElementById('config-periodo-tarde').checked = config.periodos?.includes('tarde') ?? true;
      document.getElementById('config-periodo-noite').checked = config.periodos?.includes('noite') ?? false;

      document.getElementById('config-foco-principal').value = config.focoPrincipal || 'balanceado';
      document.getElementById('config-base-agenda').value = config.baseAgenda || 'meta-diaria-topicos';

      // Carrega a nova configuração de revisão
      document.getElementById('config-base-revisao').value = config.baseRevisao || '1';

      // >>>>> LINHA CORRIGIDA/ADICIONADA AQUI <<<<<
      document.getElementById('config-exclude-disciplina').value = config.excludeDisciplina || '';
      // >>>>> FIM DA LINHA CORRIGIDA <<<<<

      document.getElementById('config-distribuicao').value = config.distribuicao || 'igual';
      // >>>>> CARREGAR E APLICAR CONFIGURAÇÕES DO POMODORO <<<<<
      document.getElementById('config-pomodoro-focus').value = config.pomodoroFocus || '25';
      document.getElementById('config-pomodoro-short-break').value = config.pomodoroShortBreak || '5';
      document.getElementById('config-pomodoro-long-break').value = config.pomodoroLongBreak || '15';
      document.getElementById('config-pomodoro-cycles').value = config.pomodoroCycles || '4';

      // Atualiza as variáveis globais do timer
      pomodoroSettings.focus = parseInt(config.pomodoroFocus || '25');
      pomodoroSettings.short_break = parseInt(config.pomodoroShortBreak || '5');
      pomodoroSettings.long_break = parseInt(config.pomodoroLongBreak || '15');
      pomodoroSettings.cycles_to_long_break = parseInt(config.pomodoroCycles || '4');

      resetTimer(); // Reinicia o timer com as novas configurações carregadas
    }

    function changeMonth(direction) {
      window.currentMonth += direction;
      if (window.currentMonth < 0) {
        window.currentMonth = 11;
        window.currentYear--;
      } else if (window.currentMonth > 11) {
        window.currentMonth = 0;
        window.currentYear++;
      }
      // Recarregar a visualização mensal
      loadAgendaTab('mensal');
    }

    function saveConfig() {
      const config = {
        diasSemana: document.getElementById('config-dias-semana').value,
        horasDia: document.getElementById('config-horas-dia').value,
        topicosDia: document.getElementById('config-topicos-dia').value,
        periodos: [
          document.getElementById('config-periodo-manha').checked ? 'manha' : null,
          document.getElementById('config-periodo-tarde').checked ? 'tarde' : null,
          document.getElementById('config-periodo-noite').checked ? 'noite' : null
        ].filter(Boolean),
        focoPrincipal: document.getElementById('config-foco-principal').value,
        baseAgenda: document.getElementById('config-base-agenda').value,
        baseRevisao: document.getElementById('config-base-revisao').value,
        excludeDisciplina: document.getElementById('config-exclude-disciplina').value,
        distribuicao: document.getElementById('config-distribuicao').value,
        // NOVAS CONFIGURAÇÕES DO POMODORO
        pomodoroFocus: document.getElementById('config-pomodoro-focus').value,
        pomodoroShortBreak: document.getElementById('config-pomodoro-short-break').value,
        pomodoroLongBreak: document.getElementById('config-pomodoro-long-break').value,
        pomodoroCycles: document.getElementById('config-pomodoro-cycles').value
      };

      localStorage.setItem('agendaConfig', JSON.stringify(config));
      showNotification('Configurações salvas com sucesso!');

      // Sincronizar campos com as Metas do Usuário
      saveUserGoalSpecificField('Meta Diária Tópicos', config.topicosDia);
      saveUserGoalSpecificField('Meta Horas Estudo', config.horasDia);
      saveUserGoalSpecificField('Meta Dias Estudo', config.diasSemana);

      // >>>>> LÓGICA NOVA PARA ATUALIZAR O TIMER IMEDIATAMENTE <<<<<
      // Atualiza as variáveis globais do timer com os novos valores salvos
      pomodoroSettings.focus = parseInt(config.pomodoroFocus || '25');
      pomodoroSettings.short_break = parseInt(config.pomodoroShortBreak || '5');
      pomodoroSettings.long_break = parseInt(config.pomodoroLongBreak || '15');
      pomodoroSettings.cycles_to_long_break = parseInt(config.pomodoroCycles || '4');

      resetTimer(); // Reinicia o timer com as novas configurações para atualizar a tela
      // >>>>> FIM DA NOVA LÓGICA <<<<<
    }

    // ========================================================
    // >>>>> INÍCIO DAS NOVAS FUNÇÕES DO TIMER DE FOCO <<<<<
    // ========================================================

    function startPauseTimer() {
      const startPauseIcon = document.querySelector('#timer-start-pause i');
      if (isTimerRunning) {
        // Pausar
        clearInterval(timerInterval);
        isTimerRunning = false;
        startPauseIcon.className = 'fas fa-play';
      } else {
        // Iniciar
        isTimerRunning = true;
        startPauseIcon.className = 'fas fa-pause';
        timerInterval = setInterval(tick, 1000);
      }
    }

    function resetTimer() {
      clearInterval(timerInterval);
      isTimerRunning = false;
      document.querySelector('#timer-start-pause i').className = 'fas fa-play';

      if (timerMode === 'pomodoro') {
        pomodoroState = 'focus';
        pomodoroCycles = 0;
        timerSeconds = pomodoroSettings.focus * 60;
        updatePomodoroUI();
      } else {
        timerSeconds = 0;
      }
      updateTimerDisplay();
    }

    function tick() {
      if (timerMode === 'pomodoro') {
        timerSeconds--;
      } else {
        timerSeconds++;
      }
      updateTimerDisplay();

      if (timerMode === 'pomodoro' && timerSeconds <= 0) {
        handlePomodoroEnd();
      }
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(Math.abs(timerSeconds) / 60);
      const seconds = Math.abs(timerSeconds) % 60;
      const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      document.getElementById('timer-display').textContent = display;
      document.title = `${display} - Controle de Progresso`;
    }

    function handlePomodoroEnd() {
      document.getElementById('timer-alert-sound').play();
      clearInterval(timerInterval);
      isTimerRunning = false;
      document.querySelector('#timer-start-pause i').className = 'fas fa-play';

      if (pomodoroState === 'focus') {
        pomodoroCycles++;
        if (pomodoroCycles % pomodoroSettings.cycles_to_long_break === 0) {
          pomodoroState = 'long_break';
          timerSeconds = pomodoroSettings.long_break * 60;
          showNotification('Hora da pausa longa!', 'success');
        } else {
          pomodoroState = 'short_break';
          timerSeconds = pomodoroSettings.short_break * 60;
          showNotification('Ótimo trabalho! Pausa curta.', 'success');
        }
      } else { // Era uma pausa
        pomodoroState = 'focus';
        timerSeconds = pomodoroSettings.focus * 60;
        showNotification('Fim da pausa. Hora de focar!', 'success');
      }
      updatePomodoroUI();
      updateTimerDisplay();
    }

    function toggleTimerMode() {
      const toggleButton = document.getElementById('timer-mode-toggle');
      resetTimer(); // Reinicia o timer ao trocar de modo
      if (timerMode === 'pomodoro') {
        timerMode = 'chronometer';
        toggleButton.innerHTML = '<i class="fas fa-hourglass-half"></i>';
        toggleButton.title = "Alternar para modo Pomodoro";
        document.getElementById('pomodoro-cycles').style.display = 'none';
      } else {
        timerMode = 'pomodoro';
        toggleButton.innerHTML = '<i class="fas fa-stopwatch"></i>';
        toggleButton.title = "Alternar para modo Cronômetro";
        document.getElementById('pomodoro-cycles').style.display = 'block';
      }
      resetTimer(); // Garante que a UI seja atualizada para o novo modo
    }

    function updatePomodoroUI() {
      const cyclesDisplay = document.getElementById('pomodoro-cycles');
      const container = document.getElementById('focus-timer-container');
      let cycleHTML = '';
      for (let i = 0; i < pomodoroSettings.cycles_to_long_break; i++) {
        cycleHTML += i < pomodoroCycles % pomodoroSettings.cycles_to_long_break ? '🍅' : '⚪';
      }
      cyclesDisplay.innerHTML = cycleHTML;

      // Mudar a cor de fundo baseado no estado
      if (pomodoroState === 'focus') {
        container.style.borderColor = '#444';
      } else if (pomodoroState === 'short_break') {
        container.style.borderColor = '#4CAF50'; // Verde para pausa curta
      } else { // long_break
        container.style.borderColor = '#2196F3'; // Azul para pausa longa
      }
    }

    // ========================================================
    // >>>>> FIM DAS NOVAS FUNÇÕES DO TIMER DE FOCO <<<<<
    // ========================================================
    // ========================================================
    // >>>>> NOVAS FUNÇÕES DE GAMIFICAÇÃO (DASHBOARD) <<<<<
    // ========================================================

    function renderGamificationDashboard(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;

      // 1. Estrutura HTML
      const dashboardHTML = `
        <div class="gamification-container">
            <div class="overview-chart">
                <div class="chart-title"><i class="fas fa-th"></i> Constância de Estudos (Últimos 6 Meses)</div>
                <div class="heatmap-wrapper">
                    <div id="heatmap-grid" class="heatmap-grid"></div>
                </div>
                <div style="font-size: 0.75rem; color: #888; margin-top: 5px; text-align: right;">
                    Menos <span style="display:inline-block;width:10px;height:10px;background:#161b22;vertical-align:middle;"></span>
                    <span style="display:inline-block;width:10px;height:10px;background:#D2AC47;vertical-align:middle;"></span> Mais
                </div>
            </div>

            <div class="overview-chart">
                <div class="chart-title"><i class="fas fa-fire"></i> Gráfico de Burndown (Meta vs Real)</div>
                <div class="chart-container">
                    <canvas id="burndownChart"></canvas>
                </div>
                <p id="burndown-alert" style="color: #aaa; font-size: 0.8rem; margin-top: 5px; display:none;">
                    * Defina a "Data da Prova" no Raio X para ver a linha ideal.
                </p>
            </div>
        </div>
    `;

      // Injeta o HTML antes do conteúdo existente ou no final
      container.innerHTML += dashboardHTML;

      // 2. Gerar Heatmap
      setTimeout(generateHeatmap, 100);

      // 3. Gerar Burndown
      setTimeout(generateBurndownChart, 200);
    }

    function generateHeatmap() {
      const grid = document.getElementById('heatmap-grid');
      if (!grid) return;

      // A. Processar Dados: Contar atividades por data
      const activityMap = {};
      allTopics.forEach(t => {
        // Conta estudo
        if (t['Data Estudo']) {
          const d = t['Data Estudo'].split('T')[0];
          activityMap[d] = (activityMap[d] || 0) + 1;
        }
        // Conta revisão (peso menor, mas conta)
        if (t['Data Revisão']) {
          const d = t['Data Revisão'].split('T')[0];
          activityMap[d] = (activityMap[d] || 0) + 1;
        }
      });

      // B. Gerar Grade (Últimos 180 dias aprox)
      grid.innerHTML = '';
      const today = new Date();
      // Ajusta para começar num domingo, cerca de 26 semanas atrás
      const startDate = new Date();
      startDate.setDate(today.getDate() - 180);

      // Loop dia a dia até hoje
      for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const count = activityMap[dateStr] || 0;

        // Define classe de intensidade
        let levelClass = 'heatmap-cell';
        if (count > 0) levelClass += ' level-1';
        if (count > 2) levelClass += ' level-2'; // Adicionei espaço antes de level-2
        if (count > 4) levelClass += ' level-3'; // Adicionei espaço
        if (count > 6) levelClass += ' level-4'; // Adicionei espaço

        const cell = document.createElement('div');
        cell.className = levelClass;
        cell.title = `${dateStr}: ${count} atividades`;
        grid.appendChild(cell);
      }
    }

    function generateBurndownChart() {
      const ctx = document.getElementById('burndownChart');
      if (!ctx) return;

      // Dados Necessários
      const totalTopicos = allTopics.length;
      const dataProvaStr = globalMetas['Data_Prova']?.value;

      if (!dataProvaStr) {
        document.getElementById('burndown-alert').style.display = 'block';
        return;
      }

      const dataProva = new Date(dataProvaStr);
      const hoje = new Date();

      // Descobrir data de início (primeiro estudo ou 3 meses atrás se for novo)
      let dataInicio = new Date();
      allTopics.forEach(t => {
        if (t['Data Estudo']) {
          const d = new Date(t['Data Estudo']);
          if (d < dataInicio) dataInicio = d;
        }
      });
      // Se não tiver estudo, usa data de hoje - 30 dias
      if (totalTopicos === 0 || dataInicio.getTime() === hoje.getTime()) {
        dataInicio.setDate(hoje.getDate() - 30);
      }

      // Gerar pontos do eixo X (Datas)
      const labels = [];
      const dataIdeal = [];
      const dataReal = [];

      // Calcular dias totais do projeto
      const timeDiff = dataProva - dataInicio;
      const totalDias = Math.ceil(timeDiff / (1000 * 3600 * 24));
      const idealBurnRate = totalTopicos / totalDias; // Quantos tópicos matar por dia

      // Loop do Início até a Prova (Passo de 3 em 3 dias para não poluir o gráfico)
      let topicosRestantesReal = totalTopicos;

      // Para construir o histórico real, precisamos ordenar os estudos
      const estudosPorData = {};
      allTopics.forEach(t => {
        if (t['Status Estudo'] === 'Concluído' && t['Data Estudo']) {
          estudosPorData[t['Data Estudo']] = (estudosPorData[t['Data Estudo']] || 0) + 1;
        }
      });

      let acumuladoEstudado = 0;

      for (let d = new Date(dataInicio); d <= dataProva; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];

        // Só adiciona label e pontos a cada 5 dias ou se for hoje/data prova
        const isKeyDate = d.getDate() % 5 === 0 || d.getTime() === dataProva.getTime() || dateStr === hoje.toISOString().split('T')[0];

        if (isKeyDate) {
          labels.push(d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));

          // 1. Linha Ideal (Reta descendente)
          const diasPassados = Math.ceil((d - dataInicio) / (1000 * 3600 * 24));
          let idealRestante = totalTopicos - (idealBurnRate * diasPassados);
          if (idealRestante < 0) idealRestante = 0;
          dataIdeal.push(idealRestante);

          // 2. Linha Real (Só vai até hoje)
          if (d <= new Date().setHours(23, 59, 59, 999)) {
            // Soma o que foi estudado nesse dia específico no loop
            // (Lógica simplificada: recalcula o acumulado até esta data)
            let estudadoAteAgora = 0;
            for (const [dataEst, qtd] of Object.entries(estudosPorData)) {
              if (new Date(dataEst) <= d) estudadoAteAgora += qtd;
            }
            dataReal.push(totalTopicos - estudadoAteAgora);
          } else {
            dataReal.push(null); // Futuro = null
          }
        }
      }

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Linha Ideal (Meta)',
              data: dataIdeal,
              borderColor: '#4CAF50', // Verde
              borderDash: [5, 5],
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.1
            },
            {
              label: 'Progresso Real',
              data: dataReal,
              borderColor: '#D2AC47', // Seu Dourado
              backgroundColor: 'rgba(210, 172, 71, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#333' },
              ticks: { color: '#888' },
              title: { display: true, text: 'Tópicos Restantes', color: '#666' }
            },
            x: {
              grid: { color: '#333' },
              ticks: { color: '#888', maxTicksLimit: 10 }
            }
          },
          plugins: {
            legend: { labels: { color: '#fff' } }
          }
        }
      });
    }
    // ==================== FUNÇÕES GLOBAIS ====================

    function showAgendaModal() {
      document.getElementById('agendaModal').style.display = 'flex';
      loadAgendaTab('semanal');
    }
    // ... (fim do código existente) ...

    // NOVA FUNÇÃO: Atualiza a visibilidade dos períodos com base nos checkboxes
    function updatePeriodoVisibility() {
      const mostrarManha = document.getElementById('periodo-manha').checked;
      const mostrarTarde = document.getElementById('periodo-tarde').checked;
      const mostrarNoite = document.getElementById('periodo-noite').checked;

      // Esconder todos os cabeçalhos de período
      document.querySelectorAll('.period-header').forEach(header => {
        header.style.display = 'none';
      });
      // Esconder todos os slots de tempo
      document.querySelectorAll('.time-slot').forEach(slot => {
        slot.style.display = 'none';
      });

      // Mostrar apenas os períodos selecionados
      if (mostrarManha) {
        document.querySelectorAll('.period-header[data-period="Manhã"]').forEach(header => {
          header.style.display = '';
        });
        document.querySelectorAll('.time-slot[data-period="Manhã"]').forEach(slot => {
          slot.style.display = '';
        });
      }

      if (mostrarTarde) {
        document.querySelectorAll('.period-header[data-period="Tarde"]').forEach(header => {
          header.style.display = '';
        });
        document.querySelectorAll('.time-slot[data-period="Tarde"]').forEach(slot => {
          slot.style.display = '';
        });
      }

      if (mostrarNoite) {
        document.querySelectorAll('.period-header[data-period="Noite"]').forEach(header => {
          header.style.display = '';
        });
        document.querySelectorAll('.time-slot[data-period="Noite"]').forEach(slot => {
          slot.style.display = '';
        });
      }

      // Salvar preferências no localStorage
      localStorage.setItem('mostrarManha', mostrarManha);
      localStorage.setItem('mostrarTarde', mostrarTarde);
      localStorage.setItem('mostrarNoite', mostrarNoite);
    }
    // --- FUNÇÕES PARA O NOVO MENU DE GERAÇÃO ---
    function openGenerateOptionsModal() {
      const modal = document.getElementById('generate-options-modal');
      if (modal) modal.style.display = 'flex';
    }

    function closeGenerateOptionsModal() {
      const modal = document.getElementById('generate-options-modal');
      if (modal) modal.style.display = 'none';
    }
    // --- FUNÇÃO DO NOVO MENU DE USUÁRIO ---
    function toggleUserMenu() {
      const menu = document.getElementById('user-dropdown');
      menu.classList.toggle('active');

      // Fecha o menu se clicar fora dele
      if (menu.classList.contains('active')) {
        document.addEventListener('click', closeMenuOnClickOutside);
      }
    }

    function closeMenuOnClickOutside(event) {
      const menu = document.getElementById('user-dropdown');
      const icon = document.querySelector('.header-user-icon');

      if (!menu.contains(event.target) && !icon.contains(event.target)) {
        menu.classList.remove('active');
        document.removeEventListener('click', closeMenuOnClickOutside);
      }
    }
  </script>
  <audio id="timer-alert-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>
  <script>
    // Inicializa o suporte a toque
    var options = {
      holdToDrag: 200 // O usuário precisa segurar por 0.2s para começar a arrastar (evita arrastar ao rolar a tela)
    };
    MobileDragDrop.polyfill(options);

    // Corrige problemas de rolagem enquanto arrasta
    window.addEventListener('touchmove', function () { }, { passive: false });
    // ========================================================
    // >>>>> NOVA LÓGICA MOBILE (MENU & AGENDA) <<<<<
    // ========================================================

    // 1. Alternar Menu Hambúrguer e Auto-Fechamento
    function toggleMobileMenu() {
      const menu = document.getElementById('mainTopBar');
      menu.classList.toggle('active');
    }

    // CORREÇÃO: Adiciona evento para fechar o menu ao clicar em qualquer botão dentro dele
    // Colocamos isso dentro de um setTimeout para garantir que o elemento já existe
    setTimeout(function () {
      const menuContainer = document.getElementById('mainTopBar');
      if (menuContainer) {
        menuContainer.addEventListener('click', function (e) {
          // Se o elemento clicado for um BOTÃO ou um ÍCONE dentro de um botão
          if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
            // Fecha o menu removendo a classe ativa
            menuContainer.classList.remove('active');
          }
        });
      }
    }, 500);

    // Variável global para armazenar o bloco selecionado no mobile
    let mobileSelectedBlockId = null;

    // 2. Manipulador de Clique no Bloco (Substitui Drag&Drop no Mobile)
    function handleMobileBlockClick(event, blockId) {
      // Só ativa se for tela pequena (Mobile)
      if (window.innerWidth > 768) return;

      event.stopPropagation(); // Impede cliques indesejados

      const block = document.getElementById(blockId);

      // Se clicou no mesmo bloco, deseleciona
      if (mobileSelectedBlockId === blockId) {
        block.classList.remove('mobile-selected');
        mobileSelectedBlockId = null;
        showNotification('Seleção cancelada.', 'warning');
        return;
      }

      // Remove seleção anterior, se houver
      if (mobileSelectedBlockId) {
        const prevBlock = document.getElementById(mobileSelectedBlockId);
        if (prevBlock) prevBlock.classList.remove('mobile-selected');
      }

      // Seleciona o novo
      mobileSelectedBlockId = blockId;
      block.classList.add('mobile-selected');
      showNotification('Toque em um horário vazio para mover.', 'success');
    }

    // 3. Manipulador de Clique no Slot (Destino do movimento)
    function handleMobileSlotClick(slotElement) {
      // Só ativa se for tela pequena E se tiver um bloco selecionado
      if (window.innerWidth > 768 || !mobileSelectedBlockId) return;

      const block = document.getElementById(mobileSelectedBlockId);
      if (!block) return;

      // Move o bloco visualmente
      const dropZone = slotElement.querySelector('.slot-content');
      if (dropZone) {
        dropZone.appendChild(block);

        // Limpa a seleção visual
        block.classList.remove('mobile-selected');
        mobileSelectedBlockId = null;

        // Atualiza os dados internos (importante para salvar)
        updateAgendaData();
        showNotification('Bloco movido com sucesso!', 'success');
      }
    }
    // ========================================================
  </script>
</body>

</html>
